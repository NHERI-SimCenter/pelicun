

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pelicun.control &mdash; pelicun  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
        <script src="../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
        <script src="../../_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<script src="https://cdn.jsdelivr.net/npm/vega@5.12.1"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.13.1"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.8.0"></script>
<style media="screen">.vega-actions a {margin-right: 5px;}</style>
<link href="../../_static/css/bootstrap.css" rel="stylesheet">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F2F2F2" >
          
<a href="https://simcenter.designsafe-ci.org/" style="margin-bottom: 0px;">
  <img src="../../_static/img/SimCenter-Only.png" class="logo" alt="Org-Logo" />
</a>
<hr style="margin: 0px;">

  <a href="../../index.html">



  
  <img src="../../_static/pelicun-Logo.png" class="logo" alt="Logo"/>

</a>


  
  



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../common/user_manual/about/pelicun/about.html">1. About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/front-matter/pelAck.html">2. Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/front-matter/license.html">3. Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/front-matter/glossary.html">4. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/front-matter/abbreviations.html">5. Abbreviations</a></li>
</ul>
<p class="caption"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../common/user_manual/installation/pelicun/installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/user_manual/usage/pelicun/usage.html">2. User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/user_manual/troubleshooting/pelicun/troubleshooting.html">3. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/reqments/reqPelicun.html">4. Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/user_manual/bugs.html">5. Bugs &amp; Feature Requests</a></li>
</ul>
<p class="caption"><span class="caption-text">Technical Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../common/technical_manual/pelicun/background/background.html">1. Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/technical_manual/pelicun/verification/verification.html">2. Verification</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../common/developer_manual/coding_style/pelicun/coding_style.html">1. Coding Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common/developer_manual/API/pelicun/API.html">2. API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pelicun</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pelicun.control</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pelicun.control</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2018 Leland Stanford Junior University</span>
<span class="c1"># Copyright (c) 2018 The Regents of the University of California</span>
<span class="c1">#</span>
<span class="c1"># This file is part of pelicun.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer in the documentation</span>
<span class="c1"># and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># 3. Neither the name of the copyright holder nor the names of its contributors</span>
<span class="c1"># may be used to endorse or promote products derived from this software without</span>
<span class="c1"># specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span>
<span class="c1"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c1"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c1"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c1"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c1"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the BSD 3-Clause License along with</span>
<span class="c1"># pelicun. If not, see &lt;http://www.opensource.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># Contributors:</span>
<span class="c1"># Adam Zsarn√≥czay</span>
<span class="c1"># Pouria Kourehpaz</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module has classes and methods that control the performance assessment.</span>

<span class="sd">.. rubric:: Contents</span>

<span class="sd">.. autosummary::</span>

<span class="sd">    Assessment</span>
<span class="sd">    FEMA_P58_Assessment</span>
<span class="sd">    HAZUS_Assessment</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.uq</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.file_io</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="Assessment"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment">[docs]</a><span class="k">class</span> <span class="nc">Assessment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A high-level class that collects features common to all supported loss</span>
<span class="sd">    assessment methods. This class will only rarely be called directly when</span>
<span class="sd">    using pelicun.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># initialize the basic data containers</span>
        <span class="c1"># inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_POP_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># random variables and loss model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span> <span class="o">=</span> <span class="n">RandomVariableRegistry</span><span class="p">()</span> <span class="c1"># object to manage RVs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_dict</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># dictionary to store random variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_QNT_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DSG_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DV_RED_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DV_INJ_dict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span> <span class="o">=</span> <span class="s1">&#39;generic&#39;</span>

        <span class="c1"># initialize the log file</span>
        <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
            <span class="n">set_log_file</span><span class="p">(</span><span class="s1">&#39;pelicun_log.txt&#39;</span><span class="p">)</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Assessement Started&#39;</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beta_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the total additional uncertainty for post processing.</span>

<span class="sd">        The total additional uncertainty is the squared root of sum of squared</span>
<span class="sd">        uncertainties corresponding to ground motion and modeling.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        beta_total: float</span>
<span class="sd">            The total uncertainty (logarithmic EDP standard deviation) to add</span>
<span class="sd">            to the EDP distribution. Returns None if no additional uncertainty</span>
<span class="sd">            is assigned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">AU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;added_uncertainty&#39;</span><span class="p">]</span>

        <span class="n">beta_total</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">AU</span><span class="p">[</span><span class="s1">&#39;beta_m&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_total</span> <span class="o">+=</span> <span class="n">AU</span><span class="p">[</span><span class="s1">&#39;beta_m&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>
        <span class="k">if</span> <span class="n">AU</span><span class="p">[</span><span class="s1">&#39;beta_gm&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_total</span> <span class="o">+=</span> <span class="n">AU</span><span class="p">[</span><span class="s1">&#39;beta_gm&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>

        <span class="c1"># if no uncertainty is assigned, we return None</span>
        <span class="k">if</span> <span class="n">beta_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_total</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta_total</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">beta_total</span>

<div class="viewcode-block" id="Assessment.read_inputs"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment.read_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">read_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_DL_input</span><span class="p">,</span> <span class="n">path_EDP_input</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and process the input files to describe the loss assessment task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_DL_input: string</span>
<span class="sd">            Location of the Damage and Loss input file. The file is expected to</span>
<span class="sd">            be a JSON with data stored in a standard format described in detail</span>
<span class="sd">            in the Input section of the documentation.</span>
<span class="sd">        path_EDP_input: string</span>
<span class="sd">            Location of the EDP input file. The file is expected to follow the</span>
<span class="sd">            output formatting of Dakota. The Input section of the documentation</span>
<span class="sd">            provides more information about the expected formatting.</span>
<span class="sd">        verbose: boolean, default: False</span>
<span class="sd">            If True, the method echoes the information read from the files.</span>
<span class="sd">            This can be useful to ensure that the information in the file is</span>
<span class="sd">            properly read by the method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># read SimCenter inputs -----------------------------------------------</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Reading inputs...&#39;</span><span class="p">)</span>

        <span class="c1"># BIM file</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">BIM file...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span> <span class="o">=</span> <span class="n">read_SimCenter_DL_input</span><span class="p">(</span>
            <span class="n">path_DL_input</span><span class="p">,</span> <span class="n">assessment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Global attributes / settings:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stories&#39;</span><span class="p">,</span> <span class="s1">&#39;coupled_assessment&#39;</span><span class="p">,</span> <span class="s1">&#39;realizations&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="n">att</span><span class="p">]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Prescribed Decision Variables:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dv</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dv</span><span class="p">))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Damage and Loss Data Dir:&quot;</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;data_sources&#39;</span><span class="p">][</span><span class="s1">&#39;path_CMP_data&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">][</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">()</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Population Data Dir:&quot;</span><span class="p">)</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;data_sources&#39;</span><span class="p">][</span><span class="s1">&#39;path_POP_data&#39;</span><span class="p">]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Units:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dv</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;unit_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="n">dv</span><span class="p">]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Response Model:&#39;</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Detection Limits:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dl_name</span><span class="p">,</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;detection_limits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dl_name</span><span class="p">,</span> <span class="n">dl</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">()</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Additional Uncertainty:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;added_uncertainty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Performance Model:&#39;</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">loc</span><span class="se">\t</span><span class="s1">dir</span><span class="se">\t</span><span class="s1">qnt</span><span class="se">\t</span><span class="s1">dist</span><span class="se">\t</span><span class="s1">cov</span><span class="se">\t</span><span class="s1">cgw&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comp_id</span><span class="p">,</span> <span class="n">comp_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">]:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">comp_data</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1">#TODO: control this with a verbose flag</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_data</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">])):</span>
                    <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">comp_data</span><span class="p">[</span><span class="n">att</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="s1">&#39;directions&#39;</span><span class="p">,</span> <span class="s1">&#39;quantities&#39;</span><span class="p">,</span> <span class="s1">&#39;distribution&#39;</span><span class="p">,</span> <span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="s1">&#39;csg_weights&#39;</span><span class="p">]]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Damage Model:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span> <span class="o">==</span> <span class="s1">&#39;P58&#39;</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Collapse Limits:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cl_name</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;collapse_limits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cl_name</span><span class="p">,</span> <span class="n">cl</span><span class="p">))</span>
            <span class="n">log_msg</span><span class="p">()</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Irreparable Residual Drift:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;irreparable_res_drift&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;irreparable_res_drift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">not considered&#39;</span><span class="p">)</span>
            <span class="n">log_msg</span><span class="p">()</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Collapse Probability:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;coll_prob&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;estimated&#39;</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">Estimated based on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;CP_est_basis&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">Prescribed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;coll_prob&#39;</span><span class="p">]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Loss Model:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;replacement_cost&#39;</span><span class="p">,</span> <span class="s1">&#39;replacement_time&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="n">att</span><span class="p">]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Collapse Modes:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cmode</span><span class="p">,</span> <span class="n">cmode_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;collapse_modes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmode</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">cmode_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Dependencies:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

        <span class="c1"># EDP file</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">EDP file...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hazard</span> <span class="o">==</span> <span class="s1">&#39;EQ&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span> <span class="o">=</span> <span class="n">read_SimCenter_EDP_input</span><span class="p">(</span>
                <span class="n">path_EDP_input</span><span class="p">,</span>
                <span class="n">EDP_kinds</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;PID&#39;</span><span class="p">,</span> <span class="s1">&#39;PRD&#39;</span><span class="p">,</span> <span class="s1">&#39;RID&#39;</span><span class="p">,</span> <span class="s1">&#39;PFA&#39;</span><span class="p">,</span> <span class="s1">&#39;PMD&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;PGA&#39;</span><span class="p">,</span> <span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="s1">&#39;SA&#39;</span><span class="p">,</span> <span class="s1">&#39;SV&#39;</span><span class="p">,</span> <span class="s1">&#39;SD&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;PGD&#39;</span><span class="p">,</span><span class="s1">&#39;DWD&#39;</span><span class="p">,</span> <span class="s1">&#39;RDR&#39;</span><span class="p">),</span>
                <span class="n">units</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">PID</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">PRD</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">RID</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">DWD</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">RDR</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">PFA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;acceleration&#39;</span><span class="p">],</span>
                           <span class="n">PMD</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">PGA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;acceleration&#39;</span><span class="p">],</span>
                           <span class="n">PGV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;speed&#39;</span><span class="p">],</span>
                           <span class="n">SA</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;acceleration&#39;</span><span class="p">],</span>
                           <span class="n">SV</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;speed&#39;</span><span class="p">],</span>
                           <span class="n">SD</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">],</span>
                           <span class="n">PGD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]),</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hazard</span> <span class="o">==</span> <span class="s1">&#39;HU&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span> <span class="o">=</span> <span class="n">read_SimCenter_EDP_input</span><span class="p">(</span>
                <span class="n">path_EDP_input</span><span class="p">,</span> <span class="n">EDP_kinds</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;PWS&#39;</span><span class="p">,),</span>
                <span class="n">units</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">PWS</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;speed&#39;</span><span class="p">]),</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">EDP types:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">EDP_kind</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">EDP_kind</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">EDP_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">EDP_kind</span><span class="p">]:</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1">#TODO: control this with a verbose flag</span>
                    <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">EDP_data</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="n">EDP_data</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]))</span>

        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">number of samples: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;raw_data&#39;</span><span class="p">])))</span></div>

<div class="viewcode-block" id="Assessment.define_random_variables"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment.define_random_variables">[docs]</a>    <span class="k">def</span> <span class="nf">define_random_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the random variables used for loss assessment.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Defining random variables...&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assessment.define_loss_model"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment.define_loss_model">[docs]</a>    <span class="k">def</span> <span class="nf">define_loss_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the stochastic loss model based on the inputs provided earlier.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Creating the damage and loss model...&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assessment.calculate_damage"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment.calculate_damage">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_damage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Characterize the damage experienced in each random event realization.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Calculating damage...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Assessment.calculate_losses"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment.calculate_losses">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Characterize the consequences of damage in each random event realization.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Calculating losses...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Assessment.save_outputs"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.Assessment.save_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">save_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">EDP_file</span><span class="p">,</span> <span class="n">DM_file</span><span class="p">,</span> <span class="n">DV_file</span><span class="p">,</span>
                     <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">detailed_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">replace_FG_IDs_with_FG_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="n">FG_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">new_col_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">fg_id</span><span class="p">,</span> <span class="n">fg_name</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">fg_id</span><span class="p">,</span> <span class="n">fg_name</span><span class="p">)</span> <span class="ow">in</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">FG_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">FG_list</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_col_names</span><span class="p">)</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Saving outputs...&#39;</span><span class="p">)</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Converting EDP samples to input units...&#39;</span><span class="p">)</span>
        <span class="n">EDPs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">EDP_samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">edp</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">edp</span><span class="p">]</span><span class="o">.</span><span class="n">samples</span> <span class="k">for</span> <span class="n">edp</span> <span class="ow">in</span> <span class="n">EDPs</span><span class="p">})</span>
        <span class="c1">#EDP_samples = self._EDP_dict[EDPs[0]].samples_DF.copy()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">EDP_samples</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">col_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="n">EDP_samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;1-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_info</span><span class="p">]</span>

        <span class="c1"># TODO: use some global vars to identify EDP units because this is a mess</span>
        <span class="k">for</span> <span class="n">col_i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;PFA&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;PGA&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;SA&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;acceleration&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;PFV&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;SV&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="p">(</span><span class="s1">&#39;PWS&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;speed&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;PGD&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="k">if</span> <span class="n">scale_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">EDP_samples</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">col_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">EDP_samples</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">col_i</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Converting damaged quantities to input units...&#39;</span><span class="p">)</span>
        <span class="n">DMG_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">DMG_scaled</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FG_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">col_i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">FG_name</span> <span class="o">=</span> <span class="n">FG_list</span><span class="p">[</span><span class="n">col</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">FG_name</span><span class="p">]</span><span class="o">.</span><span class="n">_unit</span>
            <span class="k">if</span> <span class="n">scale_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">DMG_scaled</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DMG_scaled</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col_i</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Replacing headers with FG names...&#39;</span><span class="p">)</span>
        <span class="n">DMG_mod</span> <span class="o">=</span> <span class="n">replace_FG_IDs_with_FG_names</span><span class="p">(</span><span class="n">DMG_scaled</span><span class="p">)</span>
        <span class="n">DV_mods</span><span class="p">,</span> <span class="n">DV_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;injuries&#39;</span><span class="p">:</span>
                <span class="n">DV_mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replace_FG_IDs_with_FG_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="n">DV_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DV_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span> <span class="o">==</span> <span class="s1">&#39;P58&#39;</span> <span class="k">else</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">DV_mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replace_FG_IDs_with_FG_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">DV_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DV_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
        <span class="c1">#if True:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Saving files:&#39;</span><span class="p">)</span>

            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Summary&#39;</span><span class="p">)</span>
            <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DL_summary.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">detailed_results</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Only saving the main results.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Summary statistics&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DL_summary_stats.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;attribute&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">stats_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">EDP values&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">EDP_.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                    <span class="n">EDP_samples</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span>
                    <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">EDP statistics&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">EDP_stats.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                    <span class="n">EDP_samples</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span>
                    <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stats_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Damaged quantities&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DMG.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                    <span class="n">DMG_mod</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Damage statistics&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DMG_stats.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                    <span class="n">DMG_mod</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span>
                    <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stats_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Damaged quantities - aggregated&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">DMG_agg.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
                    <span class="n">DMG_mod</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">DV_mod</span><span class="p">,</span> <span class="n">DV_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">DV_mods</span><span class="p">,</span> <span class="n">DV_names</span><span class="p">):</span>
                    <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Decision variable </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DV_name</span><span class="p">))</span>
                    <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                        <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">DV_name</span><span class="p">),</span>
                        <span class="n">DV_mod</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">DV_mod_agg</span> <span class="o">=</span> <span class="n">DV_mod</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

                    <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Decision variable </span><span class="si">{}</span><span class="s1"> - aggregated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DV_name</span><span class="p">))</span>
                    <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                        <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_agg.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">DV_name</span><span class="p">),</span>
                        <span class="n">DV_mod_agg</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Aggregated statistics for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DV_name</span><span class="p">))</span>
                    <span class="n">write_SimCenter_DL_output</span><span class="p">(</span>
                        <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_agg_stats.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">DV_name</span><span class="p">),</span>
                        <span class="n">DV_mod_agg</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;#Num&#39;</span><span class="p">,</span> <span class="n">collapse_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">stats_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1">#if True:</span>
            <span class="c1"># create the EDP file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HAZUS&#39;</span><span class="p">):</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">SimCenter EDP file&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_EDP_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">+</span> <span class="n">EDP_file</span><span class="p">,</span>
                    <span class="n">EDP_samples</span><span class="p">)</span>

            <span class="c1"># create the DM file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HAZUS&#39;</span><span class="p">):</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">SimCenter DM file&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DM_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="n">suffix</span><span class="o">+</span><span class="n">DM_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span><span class="p">,</span>
                    <span class="n">DMG_mod</span><span class="p">)</span>

            <span class="c1"># create the DV file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HAZUS&#39;</span><span class="p">):</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">SimCenter DV file&#39;</span><span class="p">)</span>
                <span class="n">write_SimCenter_DV_output</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="n">suffix</span><span class="o">+</span><span class="n">DV_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">DV_names</span><span class="p">,</span> <span class="n">DV_mods</span><span class="p">)))</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR when trying to create DL output files.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_RV_demands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Unlike other random variables, the demand RV is based on raw data.</span>

        <span class="c1"># First, collect the raw values from the EDP dict...</span>
        <span class="n">demand_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">detection_limits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">collapse_limits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">GI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span>
        <span class="n">s_edp_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">d_id</span> <span class="ow">in</span> <span class="n">s_edp_keys</span><span class="p">:</span>
            <span class="n">d_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span><span class="p">[</span><span class="n">d_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_list</span><span class="p">)):</span>
                <span class="n">demand_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;raw_data&#39;</span><span class="p">])</span>
                <span class="n">d_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EDP-</span><span class="si">{</span><span class="n">d_id</span><span class="si">}</span><span class="s2">-LOC-</span><span class="si">{</span><span class="n">d_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span>
                              <span class="sa">f</span><span class="s2">&quot;-DIR-</span><span class="si">{</span><span class="n">d_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">det_lim</span> <span class="o">=</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;detection_limits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">det_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">det_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

                <span class="k">if</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;EDP_dist_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;non-collapse results&#39;</span><span class="p">:</span>
                    <span class="n">coll_lim</span> <span class="o">=</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;collapse_limits&#39;</span><span class="p">][</span><span class="n">d_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">coll_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">coll_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">elif</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;EDP_dist_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all results&#39;</span><span class="p">:</span>
                    <span class="n">coll_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

                <span class="n">detection_limits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="n">det_lim</span><span class="p">])</span>
                <span class="n">collapse_limits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="n">coll_lim</span><span class="p">])</span>

        <span class="c1"># detection_limits = np.transpose(np.asarray(detection_limits))</span>
        <span class="c1"># collapse_limits = np.transpose(np.asarray(collapse_limits))</span>
        <span class="c1"># demand_data = np.transpose(np.asarray(demand_data))</span>
        <span class="n">detection_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">detection_limits</span><span class="p">)</span>
        <span class="n">collapse_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">collapse_limits</span><span class="p">)</span>
        <span class="n">demand_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">demand_data</span><span class="p">)</span>

        <span class="c1"># In a coupled assessment only the raw data needs to be stored</span>
        <span class="k">if</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;coupled_assessment&#39;</span><span class="p">]:</span>

            <span class="c1"># Create the random variable</span>
            <span class="c1"># demand_RV = RandomVariable(ID=200, dimension_tags=d_tags,</span>
            <span class="c1">#                            raw_data=np.transpose(demand_data))</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span>
                <span class="n">RandomVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;coupled_empirical&#39;</span><span class="p">,</span>
                               <span class="n">raw_samples</span><span class="o">=</span><span class="n">demand_data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)]</span>

        <span class="c1"># Otherwise, a distribution is fit to the raw data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If more than one sample is available...</span>
            <span class="k">if</span> <span class="n">demand_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                <span class="c1"># Second, we discard the collapsed EDPs if the fitted</span>
                <span class="c1"># distribution shall represent non-collapse EDPs.</span>
                <span class="n">demand_data_T</span> <span class="o">=</span> <span class="n">demand_data</span><span class="o">.</span><span class="n">T</span>
                <span class="c1"># EDP_filter = np.all(</span>
                <span class="c1">#     [np.all(demand_data_T &gt; collapse_limits.T[0], axis=1),</span>
                <span class="c1">#      np.all(demand_data_T &lt; collapse_limits.T[1], axis=1)], axis=0)</span>
                <span class="n">EDP_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">demand_data_T</span> <span class="o">&lt;</span> <span class="n">collapse_limits</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">demand_data_T</span> <span class="o">=</span> <span class="n">demand_data_T</span><span class="p">[</span><span class="n">EDP_filter</span><span class="p">]</span>

                <span class="n">log_msg</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1"> considered collapsed out of </span><span class="si">{}</span><span class="s1"> raw samples&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)))</span>

                <span class="c1"># Third, we censor the EDPs that are beyond the detection limit.</span>
                <span class="c1"># EDP_filter = np.all(</span>
                <span class="c1">#     [np.all(demand_data_T &gt; detection_limits.T[0], axis=1),</span>
                <span class="c1">#      np.all(demand_data_T &lt; detection_limits.T[1], axis=1)], axis=0)</span>
                <span class="n">EDP_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">demand_data_T</span> <span class="o">&lt;</span> <span class="n">detection_limits</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">log_msg</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1"> are beyond the detection limits out of </span><span class="si">{}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;non-collapse samples&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)))</span>

                <span class="n">censored_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)</span>
                <span class="n">demand_data_T</span> <span class="o">=</span> <span class="n">demand_data_T</span><span class="p">[</span><span class="n">EDP_filter</span><span class="p">]</span>
                <span class="n">demand_data</span> <span class="o">=</span> <span class="n">demand_data_T</span><span class="o">.</span><span class="n">T</span>

                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Number of EDP dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)))</span>

                <span class="c1"># Fourth, if requested, we fit a multivariate lognormal</span>
                <span class="c1"># distribution to the data and create the random variables</span>
                <span class="n">target_dist</span> <span class="o">=</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;EDP_distribution&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">target_dist</span> <span class="o">==</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">censored_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Fitting a censored multivariate lognormal &#39;</span>
                                <span class="s1">&#39;distribution to EDP samples...&#39;</span><span class="p">)</span>
                        <span class="n">EDP_theta</span><span class="p">,</span> <span class="n">EDP_rho</span> <span class="o">=</span> <span class="n">fit_distribution</span><span class="p">(</span>
                            <span class="n">demand_data</span><span class="p">,</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                            <span class="n">censored_count</span> <span class="o">=</span> <span class="n">censored_count</span><span class="p">,</span>
                            <span class="n">detection_limits</span> <span class="o">=</span> <span class="n">detection_limits</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Fitting a multivariate lognormal &#39;</span>
                                <span class="s1">&#39;distribution to EDP samples...&#39;</span><span class="p">)</span>
                        <span class="n">EDP_theta</span><span class="p">,</span> <span class="n">EDP_rho</span> <span class="o">=</span> <span class="n">fit_distribution</span><span class="p">(</span>
                            <span class="n">demand_data</span><span class="p">,</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">)</span>

                    <span class="c1"># Create the RVs</span>
                    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">theta_d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                            <span class="nb">zip</span><span class="p">(</span><span class="n">d_tags</span><span class="p">,</span> <span class="n">EDP_theta</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                            <span class="n">theta</span><span class="o">=</span><span class="n">theta_d</span>
                        <span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                        <span class="s1">&#39;EDP_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="n">EDP_rho</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">target_dist</span> <span class="o">==</span> <span class="s1">&#39;truncated lognormal&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">censored_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Fitting a censored truncated multivariate &#39;</span>
                                <span class="s1">&#39;lognormal distribution to EDP samples...&#39;</span><span class="p">)</span>
                        <span class="n">EDP_theta</span><span class="p">,</span> <span class="n">EDP_rho</span> <span class="o">=</span> <span class="n">fit_distribution</span><span class="p">(</span>
                            <span class="n">demand_data</span><span class="p">,</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                            <span class="n">truncation_limits</span><span class="o">=</span><span class="n">collapse_limits</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Fitting a truncated multivariate &#39;</span>
                                <span class="s1">&#39;lognormal distribution to EDP samples...&#39;</span><span class="p">)</span>
                        <span class="n">EDP_theta</span><span class="p">,</span> <span class="n">EDP_rho</span> <span class="o">=</span> <span class="n">fit_distribution</span><span class="p">(</span>
                            <span class="n">demand_data</span><span class="p">,</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                            <span class="n">truncation_limits</span><span class="o">=</span><span class="n">collapse_limits</span><span class="p">)</span>

                    <span class="c1"># Create the RVs</span>
                    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">theta_d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                            <span class="nb">zip</span><span class="p">(</span><span class="n">d_tags</span><span class="p">,</span> <span class="n">EDP_theta</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                            <span class="n">theta</span><span class="o">=</span><span class="n">theta_d</span><span class="p">,</span>
                            <span class="n">truncation_limits</span><span class="o">=</span><span class="n">collapse_limits</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                        <span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                        <span class="s1">&#39;EDP_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="n">EDP_rho</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1"># this is when fitting is not requested (i.e. empirical)</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span>
                        <span class="n">RandomVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span>
                                       <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;empirical&#39;</span><span class="p">,</span>
                                       <span class="n">raw_samples</span><span class="o">=</span><span class="n">demand_data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)]</span>

                <span class="c1"># demand_RV = RandomVariable(ID=200, dimension_tags=d_tags,</span>
                <span class="c1">#                            raw_data=demand_data,</span>
                <span class="c1">#                            detection_limits=detection_limits,</span>
                <span class="c1">#                            censored_count=censored_count</span>
                <span class="c1">#                            )</span>

            <span class="c1"># This is a special case when only a one sample is provided.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: what to do when the sample is larger than the collapse or detection limit and when truncated distribution is prescribed</span>

                <span class="c1"># Since we only have one data point, the best we can do is assume</span>
                <span class="c1"># it is the median of the multivariate distribution. The dispersion</span>
                <span class="c1"># is assumed to be negligible.</span>

                <span class="c1"># dim = demand_data.shape[0]</span>
                <span class="c1"># if dim &gt; 1:</span>
                <span class="c1">#     sig = np.abs(demand_data.T[0])*1e-6</span>
                <span class="c1">#     rho = np.zeros((dim,dim))</span>
                <span class="c1">#     np.fill_diagonal(rho, 1.0)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     COV = np.abs(demand_data[0][0])*(1e-6)**2.0</span>

                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span>
                    <span class="n">RandomVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                                   <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="n">demand_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">demand_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)]</span>

                <span class="c1"># demand_RV = RandomVariable(ID=200, dimension_tags=d_tags,</span>
                <span class="c1">#                            distribution_kind=&#39;lognormal&#39;,</span>
                <span class="c1">#                            theta=demand_data[0],</span>
                <span class="c1">#                            COV=COV)</span>

            <span class="c1"># To consider additional uncertainty in EDPs, we need to increase</span>
            <span class="c1"># the log standard deviation of the lognormal RVs. If the EDP</span>
            <span class="c1"># distribution is set to &#39;empirical&#39; then we do not consider the</span>
            <span class="c1"># prescribed additional uncertainty</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_tot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">GI</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;EDP_distribution&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;empirical&#39;</span><span class="p">)):</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Considering additional sources of uncertainty...&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="n">d_tags</span><span class="p">:</span>
                    <span class="n">RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">[</span><span class="n">d_tag</span><span class="p">]</span>

                    <span class="n">theta_0</span> <span class="o">=</span> <span class="n">RV</span><span class="o">.</span><span class="n">theta</span>
                    <span class="n">theta_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">theta_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_tot</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
                    <span class="n">RV</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta_0</span>

                <span class="c1"># determine the covariance matrix with added uncertainty</span>
                <span class="c1"># if demand_RV.COV.shape != ():</span>
                <span class="c1">#     sig_mod = np.sqrt(demand_RV.sig ** 2. + self.beta_tot ** 2.)</span>
                <span class="c1">#     COV_mod = np.outer(sig_mod, sig_mod) * demand_RV.corr</span>
                <span class="c1"># else:</span>
                <span class="c1">#     COV_mod = np.sqrt(demand_RV.COV**2. + self.beta_tot**2.)</span>
                <span class="c1">#</span>
                <span class="c1"># # redefine the random variable</span>
                <span class="c1"># demand_RV = RandomVariable(</span>
                <span class="c1">#     ID=200,</span>
                <span class="c1">#     dimension_tags=demand_RV.dimension_tags,</span>
                <span class="c1">#     distribution_kind=demand_RV.distribution_kind,</span>
                <span class="c1">#     theta=demand_RV.theta,</span>
                <span class="c1">#     COV=COV_mod,</span>
                <span class="c1">#     truncation_limits=demand_RV.tr_limits_pre)</span>

        <span class="k">return</span> <span class="n">d_tags</span></div>


<div class="viewcode-block" id="FEMA_P58_Assessment"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment">[docs]</a><span class="k">class</span> <span class="nc">FEMA_P58_Assessment</span><span class="p">(</span><span class="n">Assessment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Assessment class that implements the loss assessment method in FEMA P58.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inj_lvls</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

        <span class="c1"># constants for the FEMA-P58 methodology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span> <span class="o">=</span> <span class="n">inj_lvls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hazard</span> <span class="o">=</span> <span class="s1">&#39;EQ&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span> <span class="o">=</span> <span class="s1">&#39;P58&#39;</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;type: FEMA P58 Assessment&#39;</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;hazard: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hazard</span><span class="p">))</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>

<div class="viewcode-block" id="FEMA_P58_Assessment.read_inputs"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.read_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">read_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_DL_input</span><span class="p">,</span> <span class="n">path_EDP_input</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and process the input files to describe the loss assessment task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_DL_input: string</span>
<span class="sd">            Location of the Damage and Loss input file. The file is expected to</span>
<span class="sd">            be a JSON with data stored in a standard format described in detail</span>
<span class="sd">            in the Input section of the documentation.</span>
<span class="sd">        path_EDP_input: string</span>
<span class="sd">            Location of the EDP input file. The file is expected to follow the</span>
<span class="sd">            output formatting of Dakota. The Input section of the documentation</span>
<span class="sd">            provides more information about the expected formatting.</span>
<span class="sd">        verbose: boolean, default: False</span>
<span class="sd">            If True, the method echoes the information read from the files.</span>
<span class="sd">            This can be useful to ensure that the information in the file is</span>
<span class="sd">            properly read by the method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_inputs</span><span class="p">(</span><span class="n">path_DL_input</span><span class="p">,</span>
                                                     <span class="n">path_EDP_input</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># assume that the asset is a building</span>
        <span class="c1"># TODO: If we want to apply FEMA-P58 to non-building assets, several parts of this methodology need to be extended.</span>
        <span class="n">BIM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span>

        <span class="c1"># read component and population data ----------------------------------</span>
        <span class="c1"># components</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Damage and Loss data files...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span> <span class="o">=</span> <span class="n">read_component_DL_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;data_sources&#39;</span><span class="p">][</span><span class="s1">&#39;path_CMP_data&#39;</span><span class="p">],</span>
            <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">],</span>
            <span class="n">assessment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Available Fragility Groups:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1"> demand:</span><span class="si">{}</span><span class="s1"> PGs: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;demand_type&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">])))</span>

        <span class="c1"># population (if needed)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">][</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;event_time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Population data files...&#39;</span><span class="p">)</span>
                <span class="n">POP</span> <span class="o">=</span> <span class="n">read_population_distribution</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;data_sources&#39;</span><span class="p">][</span><span class="s1">&#39;path_POP_data&#39;</span><span class="p">],</span>
                    <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;occupancy_type&#39;</span><span class="p">],</span>
                    <span class="n">assessment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">POP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peak&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

            <span class="n">POP</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;population&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_POP_in</span> <span class="o">=</span> <span class="n">POP</span></div>

<div class="viewcode-block" id="FEMA_P58_Assessment.define_random_variables"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.define_random_variables">[docs]</a>    <span class="k">def</span> <span class="nf">define_random_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the random variables used for loss assessment.</span>

<span class="sd">        Following the FEMA P58 methodology, the groups of parameters below are</span>
<span class="sd">        considered random. Simple correlation structures within each group can</span>
<span class="sd">        be specified through the DL input file. The random decision variables</span>
<span class="sd">        are only created and used later if those particular decision variables</span>
<span class="sd">        are requested in the input file.</span>

<span class="sd">        1. Demand (EDP) distribution</span>

<span class="sd">        Describe the uncertainty in the demands. Unlike other random variables,</span>
<span class="sd">        the EDPs are characterized by the EDP input data provided earlier. All</span>
<span class="sd">        EDPs are handled in one multivariate lognormal distribution. If more</span>
<span class="sd">        than one sample is provided, the distribution is fit to the EDP data.</span>
<span class="sd">        Otherwise, the provided data point is assumed to be the median value</span>
<span class="sd">        and the additional uncertainty prescribed describes the dispersion. See</span>
<span class="sd">        _create_RV_demands() for more details.</span>

<span class="sd">        2. Component quantities</span>

<span class="sd">        Describe the uncertainty in the quantity of components in each</span>
<span class="sd">        Performance Group. All Fragility Groups are handled in the same</span>
<span class="sd">        multivariate distribution. Consequently, correlation between various</span>
<span class="sd">        groups of component quantities can be specified. See</span>
<span class="sd">        _create_RV_quantities() for details.</span>

<span class="sd">        3. Fragility EDP limits</span>

<span class="sd">        Describe the uncertainty in the EDP limit that corresponds to</span>
<span class="sd">        exceedance of each Damage State. EDP limits are grouped by Fragility</span>
<span class="sd">        Groups. Consequently, correlation between fragility limits are</span>
<span class="sd">        currently limited within Fragility Groups. See</span>
<span class="sd">        _create_RV_fragilities() for details.</span>

<span class="sd">        4. Reconstruction cost and time</span>

<span class="sd">        Describe the uncertainty in the cost and duration of reconstruction of</span>
<span class="sd">        each component conditioned on the damage state of the component. All</span>
<span class="sd">        Fragility Groups are handled in the same multivariate distribution.</span>
<span class="sd">        Consequently, correlation between various groups of component</span>
<span class="sd">        reconstruction time and cost estimates can be specified. See</span>
<span class="sd">        _create_RV_repairs() for details.</span>

<span class="sd">        5. Damaged component proportions that trigger a red tag</span>

<span class="sd">        Describe the uncertainty in the amount of damaged components needed to</span>
<span class="sd">        trigger a red tag for the building. All Fragility Groups are handled in</span>
<span class="sd">        the same multivariate distribution. Consequently, correlation between</span>
<span class="sd">        various groups of component proportion limits can be specified. See</span>
<span class="sd">        _create_RV_red_tags() for details.</span>

<span class="sd">        6. Injuries</span>

<span class="sd">        Describe the uncertainty in the proportion of people in the affected</span>
<span class="sd">        area getting injuries exceeding a certain level of severity. FEMA P58</span>
<span class="sd">        uses two severity levels: injury and fatality. Both levels for all</span>
<span class="sd">        Fragility Groups are handled in the same multivariate distribution.</span>
<span class="sd">        Consequently, correlation between various groups of component injury</span>
<span class="sd">        expectations can be specified. See _create_RV_injuries() for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">define_random_variables</span><span class="p">()</span>

        <span class="c1"># create the random variables -----------------------------------------</span>
        <span class="n">DEP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># quantities 100</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Quantities...&#39;</span><span class="p">)</span>
        <span class="n">QNT_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_quantities</span><span class="p">(</span><span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">])</span>

        <span class="c1"># self._RV_dict.update({&#39;QNT&#39;:</span>
        <span class="c1">#                       self._create_RV_quantities(DEP[&#39;quantities&#39;])})</span>

        <span class="k">if</span> <span class="n">QNT_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">QNT_tags</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_QNT_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">QNT_tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the components have random quantities assigned&#39;</span><span class="p">)</span>

        <span class="c1"># fragilities 300</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Damage State Limits...&#39;</span><span class="p">)</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="n">FF_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_fragilities</span><span class="p">(</span><span class="n">c_id</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;fragilities&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">FF_tags</span><span class="p">))</span>

            <span class="c1"># self._RV_dict.update({</span>
            <span class="c1">#     &#39;FR-&#39; + c_name:</span>
            <span class="c1">#         self._create_RV_fragilities(c_id, comp,</span>
            <span class="c1">#                                     DEP[&#39;fragilities&#39;])})</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">FF_tags</span><span class="p">)))</span>


        <span class="c1"># for key, val in self._RV_dict.items():</span>
        <span class="c1">#     if &#39;FR-&#39; in key:</span>
        <span class="c1">#         log_msg(&#39;\t\t\t{}: {}&#39;.format(key, len(val.theta)))</span>

        <span class="c1"># irreparability</span>
        <span class="k">if</span> <span class="s1">&#39;irreparable_res_drift&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]:</span>
            <span class="n">irrep_frag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;irreparable_res_drift&#39;</span><span class="p">]</span>
            <span class="n">RV_irrep</span> <span class="o">=</span> <span class="n">RandomVariable</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;RED_irrep&#39;</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;lognormal&#39;</span><span class="p">,</span>
                <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="n">irrep_frag</span><span class="p">[</span><span class="s1">&#39;Median&#39;</span><span class="p">],</span> <span class="n">irrep_frag</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RV_irrep</span><span class="p">)</span>

        <span class="c1"># collapse modes</span>
        <span class="n">coll_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;collapse_modes&#39;</span><span class="p">]</span>
        <span class="n">P_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmk</span> <span class="k">for</span> <span class="n">cmk</span> <span class="ow">in</span> <span class="n">coll_modes</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">P_modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">coll_modes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">P_keys</span><span class="p">]</span>
        <span class="n">RV_CM</span> <span class="o">=</span> <span class="n">RandomVariable</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CM&#39;</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">P_modes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RV_CM</span><span class="p">)</span>

        <span class="c1"># damages (mutually exclusive cases and later simultaneous ones too)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Damage States...&#39;</span><span class="p">)</span>
        <span class="n">DS_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_damage_states</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">DS_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DS_tags</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DSG_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">DS_tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the components have random damage states assigned&#39;</span><span class="p">)</span>

        <span class="c1"># consequences 400</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Red Tag Thresholds...&#39;</span><span class="p">)</span>
            <span class="n">RED_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_red_tags</span><span class="p">(</span><span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;red_tags&#39;</span><span class="p">])</span>

            <span class="c1"># self._RV_dict.update({&#39;DV_RED&#39;:</span>
            <span class="c1">#                       self._create_RV_red_tags(DEP[&#39;red_tags&#39;])})</span>

            <span class="k">if</span> <span class="n">RED_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RED_tags</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_RED_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">RED_tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the component damage states trigger red tags&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Reconstruction Costs and Times...&#39;</span><span class="p">)</span>
            <span class="n">REP_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_repairs</span><span class="p">(</span>
                <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;rec_costs&#39;</span><span class="p">],</span> <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;rec_times&#39;</span><span class="p">],</span> <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;cost_and_time&#39;</span><span class="p">])</span>

            <span class="c1"># self._RV_dict.update({&#39;DV_REP&#39;:</span>
            <span class="c1">#                       self._create_RV_repairs(</span>
            <span class="c1">#                         DEP[&#39;rec_costs&#39;],</span>
            <span class="c1">#                         DEP[&#39;rec_times&#39;],</span>
            <span class="c1">#                         DEP[&#39;cost_and_time&#39;])})</span>

            <span class="k">if</span> <span class="n">REP_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">REP_tags</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">REP_tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the components have probabilistic consequence functions&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Injury Probabilities...&#39;</span><span class="p">)</span>
            <span class="n">INJ_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_injuries</span><span class="p">(</span>
                <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">],</span> <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;injury_lvls&#39;</span><span class="p">])</span>

            <span class="c1"># self._RV_dict.update({&#39;DV_INJ&#39;:</span>
            <span class="c1">#                       self._create_RV_injuries(</span>
            <span class="c1">#                         DEP[&#39;injuries&#39;],</span>
            <span class="c1">#                         DEP[&#39;injury_lvls&#39;])})</span>

            <span class="k">if</span> <span class="n">INJ_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">INJ_tags</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_INJ_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">INJ_tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the component damage states trigger injuries&#39;</span><span class="p">)</span>

        <span class="c1"># demands 200</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">EDPs...&#39;</span><span class="p">)</span>

        <span class="n">GR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">GR</span><span class="p">[</span><span class="s1">&#39;EDP_dist_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;non-collapse results&#39;</span><span class="p">:</span>
            <span class="n">discard_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;collapse_limits&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">discard_limits</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">EDP_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_demands</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">EDP_tags</span><span class="p">)</span>
        <span class="c1">#self._RV_dict.update({&#39;EDP&#39;: self._create_RV_demands()})</span>

        <span class="c1"># sample the random variables -----------------------------------------</span>
        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Sampling the random variables...&#39;</span><span class="p">)</span>

        <span class="n">realization_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="n">realization_count</span><span class="p">)</span>

        <span class="c1"># is_coupled = self._AIM_in[&#39;general&#39;][&#39;coupled_assessment&#39;]</span>
        <span class="c1">#</span>
        <span class="c1"># s_rv_keys = sorted(self._RV_dict.keys())</span>
        <span class="c1"># for r_i in s_rv_keys:</span>
        <span class="c1">#     rv = self._RV_dict[r_i]</span>
        <span class="c1">#     if rv is not None:</span>
        <span class="c1">#         log_msg(&#39;\t{}...&#39;.format(r_i))</span>
        <span class="c1">#         rv.sample_distribution(</span>
        <span class="c1">#             sample_size=realization_count,</span>
        <span class="c1">#             preserve_order=((r_i==&#39;EDP&#39;) and is_coupled))</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Sampling completed.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FEMA_P58_Assessment.define_loss_model"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.define_loss_model">[docs]</a>    <span class="k">def</span> <span class="nf">define_loss_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the stochastic loss model based on the inputs provided earlier.</span>

<span class="sd">        Following the FEMA P58 methodology, the components specified in the</span>
<span class="sd">        Damage and Loss input file are used to create Fragility Groups. Each</span>
<span class="sd">        Fragility Group corresponds to a component that might be present in</span>
<span class="sd">        the building at several locations. See _create_fragility_groups() for</span>
<span class="sd">        more details about the creation of Fragility Groups.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">define_loss_model</span><span class="p">()</span>

        <span class="c1"># fragility groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fragility_groups</span><span class="p">()</span></div>

        <span class="c1"># demands</span>
        <span class="c1"># self._EDP_dict = dict(</span>
        <span class="c1">#     [(tag, RandomVariableSubset(self._RV_dict[&#39;EDP&#39;],tags=tag))</span>
        <span class="c1">#      for tag in self._RV_dict[&#39;EDP&#39;]._dimension_tags])</span>

<div class="viewcode-block" id="FEMA_P58_Assessment.calculate_damage"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.calculate_damage">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_damage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Characterize the damage experienced in each random event realization.</span>

<span class="sd">        First, the time of the event (month, weekday/weekend, hour) is randomly</span>
<span class="sd">        generated for each realization. Given the event time, the number of</span>
<span class="sd">        people present at each floor of the building is calculated.</span>

<span class="sd">        Second, the realizations that led to collapse are filtered. See</span>
<span class="sd">        _calc_collapses() for more details on collapse estimation.</span>

<span class="sd">        Finally, the realizations that did not lead to building collapse are</span>
<span class="sd">        further investigated and the quantities of components in each damage</span>
<span class="sd">        state are estimated. See _calc_damage() for more details on damage</span>
<span class="sd">        estimation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_damage</span><span class="p">()</span>

        <span class="c1"># event time - month, weekday, and hour realizations</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sampling event time...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_event_time</span><span class="p">()</span>

        <span class="c1"># get the population conditioned on event time (if needed)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">][</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sampling the population...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_population</span><span class="p">()</span>

        <span class="c1"># collapses</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating the number of collapses...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="p">,</span> <span class="n">collapsed_IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_collapses</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;collapse&#39;</span><span class="p">:</span><span class="n">collapsed_IDs</span><span class="p">})</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1"> out of </span><span class="si">{}</span><span class="s1"> collapsed.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">collapsed_IDs</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]))</span>

        <span class="c1"># select the non-collapse cases for further analyses</span>
        <span class="n">non_collapsed_IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span><span class="p">[</span>
            <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">collapsed_IDs</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">:</span> <span class="n">non_collapsed_IDs</span><span class="p">})</span>

        <span class="c1"># damage in non-collapses</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating the damage in the non-collapsed cases...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_damage</span><span class="p">()</span></div>

<div class="viewcode-block" id="FEMA_P58_Assessment.calculate_losses"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.calculate_losses">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Characterize the consequences of damage in each random event realization.</span>

<span class="sd">        For the sake of efficiency, only the decision variables requested in</span>
<span class="sd">        the input file are estimated. The following consequences are handled by</span>
<span class="sd">        this method:</span>

<span class="sd">        Reconstruction time and cost</span>
<span class="sd">        Estimate the irreparable cases based on residual drift magnitude and</span>
<span class="sd">        the provided irreparable drift limits. Realizations that led to</span>
<span class="sd">        irreparable damage or collapse are assigned the replacement cost and</span>
<span class="sd">        time of the building when reconstruction cost and time is estimated.</span>
<span class="sd">        Repairable cases get a cost and time estimate for each Damage State in</span>
<span class="sd">        each Performance Group. For more information about estimating</span>
<span class="sd">        irreparability see _calc_irreparable() and reconstruction cost and</span>
<span class="sd">        time see _calc_repair_cost_and_time() methods.</span>

<span class="sd">        Injuries</span>
<span class="sd">        Collapse-induced injuries are based on the collapse modes and</span>
<span class="sd">        corresponding injury characterization. Injuries conditioned on no</span>
<span class="sd">        collapse are based on the affected area and the probability of</span>
<span class="sd">        injuries of various severity specified in the component data file. For</span>
<span class="sd">        more information about estimating injuries conditioned on collapse and</span>
<span class="sd">        no collapse, see _calc_collapse_injuries() and</span>
<span class="sd">        _calc_non_collapse_injuries, respectively.</span>

<span class="sd">        Red Tag</span>
<span class="sd">        The probability of getting an unsafe placard or red tag is a function</span>
<span class="sd">        of the amount of damage experienced in various Damage States for each</span>
<span class="sd">        Performance Group. The damage limits that trigger an unsafe placard are</span>
<span class="sd">        specified in the component data file. For more information on</span>
<span class="sd">        assigning red tags to realizations see the _calc_red_tag() method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_losses</span><span class="p">()</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="c1"># red tag probability</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Assigning Red Tags...&#39;</span><span class="p">)</span>
            <span class="n">DV_RED</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_red_tag</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;red_tag&#39;</span><span class="p">:</span> <span class="n">DV_RED</span><span class="p">})</span>

        <span class="c1"># reconstruction cost and time</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="c1"># irreparable cases</span>
            <span class="k">if</span> <span class="s1">&#39;irreparable_res_drift&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Identifying Irreparable Cases...&#39;</span><span class="p">)</span>
                <span class="n">irreparable_IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_irreparable</span><span class="p">()</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1"> out of </span><span class="si">{}</span><span class="s1"> non-collapsed cases are irreparable.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">irreparable_IDs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">irreparable_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="c1"># collect the IDs of repairable realizations</span>
            <span class="n">P_NC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]]</span>
            <span class="n">repairable_IDs</span> <span class="o">=</span> <span class="n">P_NC</span><span class="p">[</span>
                <span class="o">~</span><span class="n">P_NC</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">irreparable_IDs</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;repairable&#39;</span><span class="p">:</span> <span class="n">repairable_IDs</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;irreparable&#39;</span><span class="p">:</span> <span class="n">irreparable_IDs</span><span class="p">})</span>

            <span class="c1"># reconstruction cost and time for repairable cases</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating Reconstruction cost and time...&#39;</span><span class="p">)</span>
            <span class="n">DV_COST</span><span class="p">,</span> <span class="n">DV_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_repair_cost_and_time</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">:</span> <span class="n">DV_COST</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;rec_time&#39;</span><span class="p">:</span> <span class="n">DV_TIME</span><span class="p">})</span>

        <span class="c1"># injuries due to collapse</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating Injuries in Collapsed Cases...&#39;</span><span class="p">)</span>
            <span class="n">COL_INJ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_collapse_injuries</span><span class="p">()</span>

            <span class="c1"># injuries in non-collapsed cases</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating Injuries in Non-Collapsed Cases...&#39;</span><span class="p">)</span>
            <span class="n">DV_INJ_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_non_collapse_injuries</span><span class="p">()</span>

            <span class="c1"># store results</span>
            <span class="k">if</span> <span class="n">COL_INJ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="p">,</span> <span class="n">COL_INJ</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;injuries&#39;</span><span class="p">:</span> <span class="n">DV_INJ_dict</span><span class="p">})</span></div>

<div class="viewcode-block" id="FEMA_P58_Assessment.aggregate_results"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.aggregate_results">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Aggregating results...&#39;</span><span class="p">)</span>

        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="n">MI_raw</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;inhabitants&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;collapses&#39;</span><span class="p">,</span> <span class="s1">&#39;collapsed&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;collapses&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;red tagged&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;irreparable&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost impractical&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time impractical&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time-sequential&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time-parallel&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev1&#39;</span><span class="p">),</span>  <span class="c1"># thanks, Laura S.!</span>
            <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev2&#39;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
            <span class="n">MI_raw</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="s1">&#39;weekday?&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">colID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">repID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;repairable&#39;</span><span class="p">]</span>
            <span class="n">irID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">]</span>

        <span class="n">MI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">MI_raw</span><span class="p">)</span>

        <span class="n">SUMMARY</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">],</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MI</span><span class="p">))),</span> <span class="n">columns</span><span class="o">=</span><span class="n">MI</span><span class="p">)</span>
        <span class="n">SUMMARY</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="c1"># event time (if needed)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;weekday?&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">prop</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span>

        <span class="c1"># collapses</span>
        <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;collapses&#39;</span><span class="p">,</span> <span class="s1">&#39;collapsed&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># red tag</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;red tagged&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># reconstruction cost</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">repl_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;replacement_cost&#39;</span><span class="p">]</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_cost</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;irreparable&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;irreparable&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_cost</span>

            <span class="n">repair_impractical_IDs</span> <span class="o">=</span> <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">repl_cost</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost impractical&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repair_impractical_IDs</span><span class="p">,</span>
                        <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost impractical&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">repair_impractical_IDs</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_cost</span>

        <span class="c1"># reconstruction time</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time-sequential&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time-parallel&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">rep_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;replacement_time&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">t_label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time-sequential&#39;</span><span class="p">,</span> <span class="s1">&#39;time-parallel&#39;</span><span class="p">]:</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="n">t_label</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rep_time</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="n">t_label</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rep_time</span>

            <span class="n">repair_impractical_IDs</span> <span class="o">=</span> \
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;time-parallel&#39;</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">rep_time</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time impractical&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repair_impractical_IDs</span><span class="p">,(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;time impractical&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repair_impractical_IDs</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;time-parallel&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rep_time</span>

        <span class="c1"># injuries</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>

            <span class="c1"># inhabitants</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;inhabitants&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;CM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;collapses&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;CM&#39;</span><span class="p">]</span>

                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev1&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;INJ-0&#39;</span><span class="p">]</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev2&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;INJ-1&#39;</span><span class="p">]</span>

            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev1&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev2&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span> <span class="o">=</span> <span class="n">SUMMARY</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FEMA_P58_Assessment.save_outputs"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.FEMA_P58_Assessment.save_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">save_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FEMA_P58_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save_outputs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">include_CSG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">include_DSG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_DS</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rho_target</span>
<span class="sd">        c_target</span>
<span class="sd">        include_CSG</span>
<span class="sd">        include_DSG</span>
<span class="sd">        include_DS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set the correlation structure</span>
        <span class="n">rho_FG</span><span class="p">,</span> <span class="n">rho_PG</span><span class="p">,</span> <span class="n">rho_LOC</span><span class="p">,</span> <span class="n">rho_DIR</span><span class="p">,</span> <span class="n">rho_CSG</span><span class="p">,</span> <span class="n">rho_DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC&#39;</span><span class="p">,</span> <span class="s1">&#39;CSG&#39;</span><span class="p">,</span> <span class="s1">&#39;ATC&#39;</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">]:</span>
            <span class="n">rho_DS</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC&#39;</span><span class="p">,</span> <span class="s1">&#39;CSG&#39;</span><span class="p">]:</span>
            <span class="n">rho_CSG</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">]:</span>
            <span class="n">rho_DIR</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC&#39;</span><span class="p">]:</span>
            <span class="n">rho_LOC</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">]:</span>
            <span class="n">rho_PG</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="o">==</span> <span class="s1">&#39;FG&#39;</span><span class="p">:</span>
            <span class="n">rho_FG</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">L_D_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DS_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ATC_rho</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">c_target</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c_id</span> <span class="o">==</span> <span class="n">c_target</span><span class="p">)):</span>
                <span class="n">c_L_D_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">c_DS_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ATC_rho</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">include_DSG</span><span class="p">:</span>
                    <span class="n">DS_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                        <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">include_DS</span><span class="p">:</span>
                            <span class="n">DS_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">DS_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">DS_count</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1">#for loc in comp[&#39;locations&#39;]:</span>
                <span class="c1">#    if include_CSG:</span>
                <span class="c1">#        u_dirs = comp[&#39;directions&#39;]</span>
                <span class="c1">#    else:</span>
                <span class="c1">#        u_dirs = np.unique(comp[&#39;directions&#39;])</span>
                <span class="c1">#    c_L_D_list.append([])</span>
                <span class="c1">#    for dir_ in u_dirs:</span>
                <span class="c1">#        c_DS_list.append(DS_count)</span>
                <span class="c1">#        for ds_i in range(DS_count):</span>
                <span class="c1">#            c_L_D_list[-1].append(dir_)</span>

                <span class="k">for</span> <span class="n">loc_u</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">]):</span>
                    <span class="n">c_L_D_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">csg_weights</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span>
                                                     <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">],</span>
                                                     <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="n">loc_u</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">include_CSG</span><span class="p">:</span>
                                <span class="n">csg_list</span> <span class="o">=</span> <span class="n">csg_weights</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">csg_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,]</span>
                            <span class="k">for</span> <span class="n">csg_</span> <span class="ow">in</span> <span class="n">csg_list</span><span class="p">:</span>
                                <span class="n">c_DS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DS_count</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DS_count</span><span class="p">):</span>
                                    <span class="n">c_L_D_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

                <span class="n">c_dims</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">c_L_D_list</span><span class="p">])</span>
                <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_dims</span><span class="p">)</span>
                <span class="n">L_D_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_L_D_list</span><span class="p">)</span>
                <span class="n">DS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_DS_list</span><span class="p">)</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dims</span><span class="p">)))</span> <span class="o">*</span> <span class="n">rho_FG</span>

        <span class="n">f_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="p">(</span><span class="n">c_L_D_list</span><span class="p">,</span> <span class="n">c_dims</span><span class="p">,</span> <span class="n">c_DS_list</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">L_D_list</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">DS_list</span><span class="p">)):</span>
            <span class="n">c_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">c_dims</span><span class="p">,</span> <span class="n">c_dims</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho_PG</span>

            <span class="c1"># dependencies btw directions</span>
            <span class="k">if</span> <span class="n">rho_DIR</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">loc_D_list</span> <span class="ow">in</span> <span class="n">c_L_D_list</span><span class="p">:</span>
                    <span class="n">l_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_D_list</span><span class="p">)</span>
                    <span class="n">c_rho</span><span class="p">[</span><span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">,</span>
                    <span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_DIR</span>
                    <span class="n">c_pos_id</span> <span class="o">=</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span>

            <span class="c1"># dependencies btw locations</span>
            <span class="k">if</span> <span class="n">rho_LOC</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">flat_dirs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="p">[[</span><span class="n">flat_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">dir_i</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">]</span> <span class="k">for</span> <span class="n">dirs</span> <span class="ow">in</span>
                 <span class="n">c_L_D_list</span><span class="p">]</span>
                <span class="n">flat_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flat_dirs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">u_dir</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">flat_dirs</span><span class="p">):</span>
                    <span class="n">dir_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flat_dirs</span> <span class="o">==</span> <span class="n">u_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                            <span class="n">c_rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_LOC</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">rho_CSG</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rho_target</span> <span class="o">==</span> <span class="s1">&#39;ATC&#39;</span><span class="p">)):</span>
                <span class="n">c_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">rho_target</span> <span class="o">==</span> <span class="s1">&#39;ATC&#39;</span><span class="p">:</span>
                    <span class="n">rho_to_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ATC_rho</span><span class="p">[</span><span class="n">c_id</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rho_to_use</span> <span class="o">=</span> <span class="n">rho_CSG</span>
                <span class="k">for</span> <span class="n">loc_D_list</span> <span class="ow">in</span> <span class="n">c_L_D_list</span><span class="p">:</span>
                    <span class="n">flat_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loc_D_list</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">u_dir</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">flat_dirs</span><span class="p">):</span>
                        <span class="n">dir_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flat_dirs</span> <span class="o">==</span> <span class="n">u_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                                <span class="n">c_rho</span><span class="p">[</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_to_use</span>
                    <span class="n">c_pos_id</span> <span class="o">=</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_D_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rho_DS</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l_dim</span> <span class="ow">in</span> <span class="n">c_DS_list</span><span class="p">:</span>
                    <span class="n">c_rho</span><span class="p">[</span><span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">,</span>
                          <span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_DS</span>
                    <span class="n">c_pos_id</span> <span class="o">=</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span>

            <span class="n">rho</span><span class="p">[</span><span class="n">f_pos_id</span><span class="p">:</span><span class="n">f_pos_id</span> <span class="o">+</span> <span class="n">c_dims</span><span class="p">,</span>
                <span class="n">f_pos_id</span><span class="p">:</span><span class="n">f_pos_id</span> <span class="o">+</span> <span class="n">c_dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_rho</span>
            <span class="n">f_pos_id</span> <span class="o">=</span> <span class="n">f_pos_id</span> <span class="o">+</span> <span class="n">c_dims</span>

        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rho</span>

    <span class="k">def</span> <span class="nf">_create_RV_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_qnt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rho_qnt</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_tags</span><span class="p">,</span> <span class="n">q_dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

        <span class="c1"># collect the parameters for each quantity dimension</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_id</span><span class="p">]</span>

            <span class="n">u_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">])</span>

            <span class="c1">#dir_weights = comp[&#39;dir_weights&#39;]</span>
            <span class="c1">#theta_list = []</span>
            <span class="c1">#[[theta_list.append(qnt * dw)</span>
            <span class="c1">#  for dw in dir_weights] for qnt in comp[&#39;quantities&#39;]]</span>

            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">]</span>
            <span class="n">q_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_theta</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>

            <span class="n">dist_list</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span>
            <span class="n">q_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_dist</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">)</span>

            <span class="n">cov_list</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">theta_list</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">,</span> <span class="n">cov_list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">dk</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
                    <span class="n">q_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_sig</span><span class="p">,</span> <span class="p">[</span><span class="n">cov</span><span class="o">*</span><span class="n">theta</span><span class="p">,])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_sig</span><span class="p">,</span> <span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="p">])</span>

            <span class="n">q_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tags</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c_id</span><span class="si">}</span><span class="s1">-QNT-</span><span class="si">{</span><span class="n">s_i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">d_i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">s_i</span><span class="p">,</span> <span class="n">d_i</span>
                                      <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span>
                                                  <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]))])</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_qnt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">q_dist</span><span class="o">==</span><span class="s1">&#39;N/A&#39;</span><span class="p">):</span>
            <span class="c1"># remove the unnecessary fields</span>
            <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q_dist</span><span class="o">==</span><span class="s1">&#39;N/A&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_dist</span><span class="p">,</span> <span class="n">q_tags</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">q_vals</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span> <span class="k">for</span> <span class="n">q_vals</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_dist</span><span class="p">,</span> <span class="n">q_tags</span><span class="p">]]</span>

            <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_theta</span><span class="p">)</span>

            <span class="c1"># add lower limits to ensure only positive quantities</span>
            <span class="c1"># zero is probably too low, and it might make sense to introduce upper</span>
            <span class="c1"># limits as well</span>
            <span class="n">tr_lower</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>
            <span class="n">tr_upper</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">q_tag</span><span class="p">,</span> <span class="n">theta_q</span><span class="p">,</span> <span class="n">sig_q</span><span class="p">,</span> <span class="n">dist_q</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">q_tags</span><span class="p">,</span> <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_dist</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">q_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dist_q</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="n">theta_q</span><span class="p">,</span> <span class="n">sig_q</span><span class="p">],</span>
                    <span class="n">truncation_limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr_lower</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">tr_upper</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="s1">&#39;QNT_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">q_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">rho</span>
            <span class="p">))</span>

            <span class="c1"># q_COV = np.outer(q_sig, q_sig) * rho</span>
            <span class="c1">#</span>
            <span class="c1"># # to avoid truncations affecting other dimensions when rho_QNT is large,</span>
            <span class="c1"># # assign a post-truncation correlation structure</span>
            <span class="c1"># corr_ref = &#39;post&#39;</span>
            <span class="c1">#</span>
            <span class="c1"># quantity_RV = RandomVariable(ID=100,</span>
            <span class="c1">#                              dimension_tags=q_tag,</span>
            <span class="c1">#                              distribution_kind=q_dist,</span>
            <span class="c1">#                              theta=q_theta,</span>
            <span class="c1">#                              COV=q_COV,</span>
            <span class="c1">#                              truncation_limits=[tr_lower, tr_upper],</span>
            <span class="c1">#                              corr_ref=corr_ref)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">q_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">q_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_fragilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">rho_fr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_id</span>
<span class="sd">        comp</span>
<span class="sd">        rho_fr</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># prepare the basic multivariate distribution data for one component subgroup considering all damage states</span>
        <span class="n">d_theta</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">,</span> <span class="n">d_tags</span><span class="p">,</span> <span class="n">d_distr_kind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

        <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">d_id</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
            <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">d_id</span><span class="p">]</span>
            <span class="n">d_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_theta</span><span class="p">,</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">])</span>
            <span class="n">d_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_tags</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FF-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">d_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">d_distr_kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_distr_kind</span><span class="p">,</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">])</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_theta</span><span class="p">)</span>

        <span class="c1"># get the total number of random variables for this fragility group</span>
        <span class="c1">#rv_count = len(comp[&#39;locations&#39;]) * len(comp[&#39;directions&#39;]) * dims</span>
        <span class="n">rv_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">csg_w</span><span class="p">)</span> <span class="k">for</span> <span class="n">csg_w</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]])</span> <span class="o">*</span> <span class="n">dims</span>

        <span class="c1"># create the (empty) input arrays for the RV</span>
        <span class="n">c_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rv_count</span><span class="p">)</span>
        <span class="n">c_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">rv_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">c_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rv_count</span><span class="p">)</span>
        <span class="n">c_distr_kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">rv_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="n">pos_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#for l_id in comp[&#39;locations&#39;]:</span>
        <span class="c1">#    # for each location-direction pair)</span>
        <span class="c1">#    for d_id, __ in enumerate(comp[&#39;directions&#39;]):</span>
        <span class="c1">#        # for each component-subgroup</span>
        <span class="c1">#        c_theta[pos_id:pos_id + dims] = d_theta</span>
        <span class="c1">#        c_sig[pos_id:pos_id + dims] = d_sig</span>
        <span class="c1">#        c_tags[pos_id:pos_id + dims] = [</span>
        <span class="c1">#            t + &#39;-LOC-{}-CSG-{}&#39;.format(l_id, d_id) for t in d_tags]</span>
        <span class="c1">#        c_distr_kind[pos_id:pos_id + dims] = d_distr_kind</span>
        <span class="c1">#        pos_id += dims</span>

        <span class="k">for</span> <span class="n">l_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="n">csg_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">],</span>
                                        <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]):</span>
            <span class="c1"># for each location-direction pair)</span>
            <span class="k">for</span> <span class="n">csg_id</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_list</span><span class="p">):</span>
                <span class="c1"># for each component-subgroup</span>
                <span class="n">c_theta</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_theta</span>
                <span class="n">c_sig</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_sig</span>
                <span class="n">c_tags</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">-CSG-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="n">csg_id</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tags</span><span class="p">]</span>
                <span class="n">c_distr_kind</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_distr_kind</span>
                <span class="n">pos_id</span> <span class="o">+=</span> <span class="n">dims</span>

        <span class="c1"># create the covariance matrix</span>
        <span class="n">c_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_fr</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=</span><span class="n">c_id</span><span class="p">,</span>
                                                <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">include_CSG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c_tags</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">c_tag</span><span class="p">,</span> <span class="n">sig_c</span><span class="p">,</span> <span class="n">theta_c</span><span class="p">,</span> <span class="n">dkind_c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">c_tags</span><span class="p">,</span> <span class="n">c_sig</span><span class="p">,</span> <span class="n">c_theta</span><span class="p">,</span> <span class="n">c_distr_kind</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">c_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dkind_c</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="n">theta_c</span><span class="p">,</span> <span class="n">sig_c</span><span class="p">]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;FF_set_</span><span class="si">{</span><span class="n">c_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">c_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">c_rho</span><span class="p">))</span>

            <span class="c1"># c_COV = np.outer(c_sig, c_sig) * c_rho</span>
            <span class="c1">#</span>
            <span class="c1"># fragility_RV = RandomVariable(ID=300 + c_id,</span>
            <span class="c1">#                               dimension_tags=c_tags,</span>
            <span class="c1">#                               distribution_kind=c_distr_kind,</span>
            <span class="c1">#                               theta=c_theta,</span>
            <span class="c1">#                               COV=c_COV)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">c_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_damage_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">d_tags</span><span class="p">,</span> <span class="n">d_theta</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set_kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mutually exclusive&#39;</span><span class="p">:</span>

                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">DS_set</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span>
                    <span class="n">DS_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">s_ds_keys</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">,</span> <span class="n">csg_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span>
                                                   <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">],</span>
                                                   <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]):</span>

                        <span class="k">for</span> <span class="n">csg_id</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_list</span><span class="p">):</span>

                            <span class="n">d_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DSG-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">dsg_i</span><span class="si">}</span><span class="s1">-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-&#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">-CSG-</span><span class="si">{</span><span class="n">csg_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">d_theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DS_weights</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">theta_d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_tags</span><span class="p">,</span> <span class="n">d_theta</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">theta_d</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">d_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_red_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">):</span>

        <span class="n">f_theta</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">,</span> <span class="n">f_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="n">d_theta</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">,</span> <span class="n">d_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

            <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">s_ds_keys</span><span class="p">:</span>
                    <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">][</span><span class="n">ds_i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;red_tag&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">d_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_theta</span><span class="p">,</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">][</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
                        <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">][</span><span class="s1">&#39;cov&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if there are no injuries assigned to this DS</span>
                        <span class="n">d_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_theta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
                    <span class="n">d_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_tag</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RED-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dsg_i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ds_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
                <span class="n">f_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_theta</span><span class="p">,</span> <span class="n">d_theta</span><span class="p">)</span>
                <span class="n">f_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_sig</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">)</span>
                <span class="n">f_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_tags</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span>
                                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tag</span><span class="p">])</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_target</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">f_theta</span><span class="o">==</span><span class="mf">0.</span><span class="p">):</span>
            <span class="c1"># remove the unnecessary fields</span>
            <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_theta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">f_theta</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">,</span> <span class="n">f_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f_vals</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">f_vals</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f_theta</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">,</span> <span class="n">f_tags</span><span class="p">]]</span>

            <span class="n">tr_upper</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">f_theta</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_theta</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">f_tag</span><span class="p">,</span> <span class="n">theta_f</span><span class="p">,</span> <span class="n">sig_f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">f_tags</span><span class="p">,</span> <span class="n">f_theta</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">f_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sig_f</span><span class="p">],</span>
                    <span class="n">truncation_limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tr_upper</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="s1">&#39;DV_RED_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">f_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">rho</span><span class="p">))</span>

            <span class="c1"># f_COV = np.outer(f_sig, f_sig) * rho</span>
            <span class="c1">#</span>
            <span class="c1"># red_tag_RV = RandomVariable(ID=400,</span>
            <span class="c1">#                             dimension_tags=f_tag,</span>
            <span class="c1">#                             distribution_kind=&#39;normal&#39;,</span>
            <span class="c1">#                             theta=np.ones(len(f_theta)),</span>
            <span class="c1">#                             COV=f_COV,</span>
            <span class="c1">#                             corr_ref=&#39;post&#39;,</span>
            <span class="c1">#                             truncation_limits=[np.zeros(len(f_theta)),</span>
            <span class="c1">#                                                tr_upper])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">f_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_repairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_cost</span><span class="p">,</span> <span class="n">rho_time</span><span class="p">,</span> <span class="n">rho_cNt</span><span class="p">):</span>

        <span class="c1"># prepare the cost and time parts of the data separately</span>
        <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_tags</span><span class="p">,</span> <span class="n">ct_dkind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">rho_target</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">rho_cost</span><span class="p">,</span> <span class="n">rho_time</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]):</span>

            <span class="n">f_sig</span><span class="p">,</span> <span class="n">f_tag</span><span class="p">,</span> <span class="n">f_dkind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

            <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

                <span class="n">d_sig</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">,</span> <span class="n">d_dkind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

                <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                    <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">s_ds_keys</span><span class="p">:</span>
                        <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">][</span><span class="n">ds_i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">((</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">DS</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">])</span>
                            <span class="n">d_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_dkind</span><span class="p">,</span>
                                                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
                            <span class="n">d_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_dkind</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="n">d_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">d_tag</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;REP-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">dsg_i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ds_i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="c1">#comp[&#39;ID&#39;] + &#39;-&#39; + str(</span>
                                <span class="c1">#    dsg_i) + &#39;-&#39; + str(</span>
                                <span class="c1">#    ds_i) + &#39;-{}&#39;.format(name))</span>

                <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
                    <span class="n">f_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_sig</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">)</span>
                    <span class="n">f_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_dkind</span><span class="p">,</span> <span class="n">d_dkind</span><span class="p">)</span>
                    <span class="n">f_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">f_tag</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tag</span><span class="p">])</span>

            <span class="n">ct_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_sig</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">)</span>
            <span class="n">ct_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">,</span> <span class="n">f_tag</span><span class="p">)</span>
            <span class="n">ct_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_dkind</span><span class="p">,</span> <span class="n">f_dkind</span><span class="p">)</span>

        <span class="n">rho_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_cost</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rho_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_time</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">)</span>
        <span class="n">ct_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dims</span><span class="p">,</span> <span class="n">dims</span><span class="p">))</span>

        <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">rho_cNt</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ct_rho</span><span class="p">[:</span><span class="n">dims</span><span class="p">,</span> <span class="p">:</span><span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_c</span>
            <span class="n">ct_rho</span><span class="p">[</span><span class="n">dims</span><span class="p">:,</span> <span class="n">dims</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rho_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># In the special case of mixing perfect correlation between</span>
            <span class="c1"># locations and directions, taking the envelope is not the</span>
            <span class="c1"># appropriate solution. Instead, the LOC &amp; DIR -&gt; PG approach is</span>
            <span class="c1"># used.</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">rho_cost</span> <span class="o">==</span> <span class="s1">&#39;LOC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rho_time</span> <span class="o">==</span><span class="s1">&#39;DIR&#39;</span><span class="p">))</span> <span class="ow">or</span>
                <span class="p">((</span><span class="n">rho_cost</span> <span class="o">==</span> <span class="s1">&#39;DIR&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rho_time</span> <span class="o">==</span> <span class="s1">&#39;LOC&#39;</span><span class="p">))):</span>
                <span class="n">rho_ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                                         <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                         <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We use the envelope in every other case.</span>
                <span class="n">rho_ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rho_c</span><span class="p">,</span> <span class="n">rho_t</span><span class="p">)</span>

            <span class="n">ct_rho</span><span class="p">[:</span><span class="n">dims</span><span class="p">,</span> <span class="p">:</span><span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_ct</span>
            <span class="n">ct_rho</span><span class="p">[</span><span class="n">dims</span><span class="p">:,</span> <span class="n">dims</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rho_ct</span>

            <span class="c1"># apply the same blocks to the off-diagonal positions</span>
            <span class="n">ct_rho</span><span class="p">[:</span><span class="n">dims</span><span class="p">,</span> <span class="n">dims</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rho_ct</span>
            <span class="n">ct_rho</span><span class="p">[</span><span class="n">dims</span><span class="p">:,</span> <span class="p">:</span><span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_ct</span>

        <span class="c1"># now remove the unnecessary fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ct_dkind</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>

            <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ct_dkind</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ct_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ct_rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ct_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ct_rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ct_dkind</span><span class="p">,</span> <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ct_vals</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">ct_vals</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ct_dkind</span><span class="p">,</span> <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_tags</span><span class="p">]]</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="p">(</span><span class="n">ct_tag</span><span class="p">,</span> <span class="n">sig_ct</span><span class="p">,</span> <span class="n">dkind_ct</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">,</span> <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_dkind</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">ct_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dkind_ct</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sig_ct</span><span class="p">],</span>
                    <span class="n">truncation_limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="s1">&#39;DV_REP_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">ct_rho</span><span class="p">))</span>

            <span class="c1"># ct_COV = np.outer(ct_sig, ct_sig) * ct_rho</span>
            <span class="c1">#</span>
            <span class="c1"># repair_RV = RandomVariable(ID=401,</span>
            <span class="c1">#                            dimension_tags=ct_tags,</span>
            <span class="c1">#                            distribution_kind=ct_dkind,</span>
            <span class="c1">#                            theta=np.ones(len(ct_sig)),</span>
            <span class="c1">#                            COV=ct_COV,</span>
            <span class="c1">#                            corr_ref=&#39;post&#39;,</span>
            <span class="c1">#                            truncation_limits=[np.zeros(len(ct_sig)),</span>
            <span class="c1">#                                               None])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ct_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">ct_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_injuries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">,</span> <span class="n">rho_lvls</span><span class="p">):</span>

        <span class="n">inj_lvls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span>

        <span class="c1"># prepare the parts for different levels of injury separately</span>
        <span class="n">full_theta</span><span class="p">,</span> <span class="n">full_sig</span><span class="p">,</span> <span class="n">full_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i_lvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inj_lvls</span><span class="p">):</span>

            <span class="n">f_theta</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">,</span> <span class="n">f_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

                <span class="n">d_theta</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">,</span> <span class="n">d_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

                <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                    <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">s_ds_keys</span><span class="p">:</span>
                        <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">][</span><span class="n">ds_i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;injuries&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">d_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">d_theta</span><span class="p">,</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">][</span><span class="s1">&#39;theta&#39;</span><span class="p">][</span><span class="n">i_lvl</span><span class="p">])</span>
                            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">d_sig</span><span class="p">,</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">][</span><span class="s1">&#39;cov&#39;</span><span class="p">][</span><span class="n">i_lvl</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># if there are no injuries assigned to this DS</span>
                            <span class="n">d_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_theta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
                        <span class="n">d_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">d_tag</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;INJ-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dsg_i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ds_i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">i_lvl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
                    <span class="n">f_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_theta</span><span class="p">,</span> <span class="n">d_theta</span><span class="p">)</span>
                    <span class="n">f_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_sig</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">)</span>
                    <span class="n">f_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_tag</span><span class="p">,</span>
                                      <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span>
                                                                   <span class="n">dir_</span><span class="p">)</span>
                                       <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tag</span><span class="p">])</span>

            <span class="n">full_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_theta</span><span class="p">,</span> <span class="n">f_theta</span><span class="p">)</span>
            <span class="n">full_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_sig</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">)</span>
            <span class="n">full_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_tags</span><span class="p">,</span> <span class="n">f_tag</span><span class="p">)</span>

        <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_tags</span><span class="p">)</span>
        <span class="n">full_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dims</span><span class="p">,</span> <span class="n">dims</span><span class="p">))</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span> <span class="o">//</span> <span class="n">inj_lvls</span>

        <span class="c1"># if correlation between different levels of severity is considered, add that to the matrix</span>
        <span class="k">if</span> <span class="n">rho_lvls</span><span class="p">:</span>
            <span class="n">rho_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_target</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inj_lvls</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inj_lvls</span><span class="p">):</span>
                    <span class="n">full_rho</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">dims</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">,</span>
                    <span class="n">j</span> <span class="o">*</span> <span class="n">dims</span><span class="p">:(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_i</span>

        <span class="c1"># and now add the values around the main diagonal</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inj_lvls</span><span class="p">):</span>
            <span class="n">rho_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_target</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">full_rho</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">dims</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dims</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_i</span>

            <span class="c1"># finally, remove the unnecessary lines</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">full_theta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">full_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">full_rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">full_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">full_rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">full_theta</span><span class="p">,</span> <span class="n">full_sig</span><span class="p">,</span> <span class="n">full_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f_vals</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">f_vals</span> <span class="ow">in</span>
                                          <span class="p">[</span><span class="n">full_theta</span><span class="p">,</span> <span class="n">full_sig</span><span class="p">,</span> <span class="n">full_tags</span><span class="p">]]</span>

        <span class="n">tr_upper</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">full_theta</span><span class="p">)</span> <span class="o">/</span> <span class="n">full_theta</span>

        <span class="k">if</span> <span class="n">full_tags</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">ii_tag</span><span class="p">,</span> <span class="n">sig_ii</span><span class="p">,</span> <span class="n">theta_ii</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">full_tags</span><span class="p">,</span> <span class="n">full_sig</span><span class="p">,</span> <span class="n">full_theta</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">ii_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sig_ii</span><span class="p">],</span>
                    <span class="n">truncation_limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tr_upper</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="s1">&#39;DV_INJ_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">full_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">full_rho</span><span class="p">))</span>

            <span class="c1"># full_COV = np.outer(full_sig, full_sig) * full_rho</span>
            <span class="c1">#</span>
            <span class="c1"># if full_tags.size &gt; 0:</span>
            <span class="c1">#     injury_RV = RandomVariable(ID=402,</span>
            <span class="c1">#                                dimension_tags=full_tags,</span>
            <span class="c1">#                                distribution_kind=&#39;normal&#39;,</span>
            <span class="c1">#                                theta=np.ones(len(full_sig)),</span>
            <span class="c1">#                                COV=full_COV,</span>
            <span class="c1">#                                corr_ref=&#39;post&#39;,</span>
            <span class="c1">#                                truncation_limits=[np.zeros(len(full_sig)),</span>
            <span class="c1">#                                                   tr_upper])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">full_tags</span>

    <span class="k">def</span> <span class="nf">_create_fragility_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">RVd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_dict</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="c1"># create a list for the fragility groups</span>
        <span class="n">FG_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_id</span><span class="p">))</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_id</span><span class="p">]</span>

            <span class="n">FG_ID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># create a list for the performance groups</span>
            <span class="n">performance_groups</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># one group for each of the stories prescribed by the user</span>
            <span class="n">PG_locations</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">]</span>
            <span class="n">PG_directions</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]</span>
            <span class="n">PG_csg_lists</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]</span>
            <span class="n">PG_dists</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span>
            <span class="n">PG_qnts</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">,</span> <span class="n">csg_list</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">qnt</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">PG_locations</span><span class="p">,</span> <span class="n">PG_directions</span><span class="p">,</span> <span class="n">PG_csg_lists</span><span class="p">,</span> <span class="n">PG_dists</span><span class="p">,</span> <span class="n">PG_qnts</span><span class="p">):</span>
                <span class="n">PG_ID</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">FG_ID</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">loc</span> <span class="o">+</span> <span class="n">dir_</span>

                <span class="c1"># get the quantity</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;N/A&#39;</span><span class="p">:</span>
                    <span class="n">QNT</span> <span class="o">=</span> <span class="n">qnt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># QNT = RandomVariableSubset(RVd[&#39;QNT&#39;],</span>
                    <span class="c1">#     tags=[f&#39;{c_id}-QNT-{loc}-{dir_}&#39;, ])</span>
                    <span class="n">QNT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_QNT_dict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c_id</span><span class="si">}</span><span class="s1">-QNT-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

                <span class="c1"># create the damage objects</span>
                <span class="c1"># consequences are calculated on a performance group level</span>

                <span class="c1"># create a list for the damage state groups and their tags</span>
                <span class="n">DSG_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">d_tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">dsg_i</span><span class="p">,</span> <span class="n">DSG_ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_dsg_keys</span><span class="p">):</span>
                    <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">DSG_ID</span><span class="p">]</span>
                    <span class="n">d_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FF-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span><span class="p">)</span>

                    <span class="c1"># create a list for the damage states</span>
                    <span class="n">DS_set</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">ds_i</span><span class="p">,</span> <span class="n">DS_ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_ds_keys</span><span class="p">):</span>
                        <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">][</span><span class="n">DS_ID</span><span class="p">]</span>

                        <span class="c1"># create the consequence functions</span>
                        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;repair_cost&#39;</span><span class="p">]</span>
                            <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_bounded_multilinear_median_DV</span><span class="p">(</span>
                                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                   <span class="p">(</span><span class="s1">&#39;medians&#39;</span><span class="p">,</span> <span class="s1">&#39;quantities&#39;</span><span class="p">)})</span>
                                   <span class="c1">#(&#39;median_max&#39;, &#39;median_min&#39;,</span>
                                   <span class="c1"># &#39;quantity_lower&#39;, &#39;quantity_upper&#39;)})</span>
                            <span class="n">cf_tag</span> <span class="o">=</span> <span class="s1">&#39;REP-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DS_ID</span> <span class="o">+</span> \
                                     <span class="s1">&#39;-cost&#39;</span> <span class="o">+</span> \
                                     <span class="s1">&#39;-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">)</span>
                            <span class="n">CF_RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span><span class="p">[</span><span class="n">cf_tag</span><span class="p">]</span>
                            <span class="c1"># CF_RV = RandomVariableSubset(RVd[&#39;DV_REP&#39;],</span>
                            <span class="c1">#                              tags=cf_tag)</span>
                            <span class="n">CF_cost</span> <span class="o">=</span> <span class="n">ConsequenceFunction</span><span class="p">(</span><span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                                          <span class="n">DV_distribution</span><span class="o">=</span><span class="n">CF_RV</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_cost</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;repair_time&#39;</span><span class="p">]</span>
                            <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_bounded_multilinear_median_DV</span><span class="p">(</span>
                                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                   <span class="p">(</span><span class="s1">&#39;medians&#39;</span><span class="p">,</span> <span class="s1">&#39;quantities&#39;</span><span class="p">)})</span>
                                   <span class="c1">#(&#39;median_max&#39;, &#39;median_min&#39;,</span>
                                   <span class="c1"># &#39;quantity_lower&#39;, &#39;quantity_upper&#39;)})</span>
                            <span class="n">cf_tag</span> <span class="o">=</span> <span class="s1">&#39;REP-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DS_ID</span> <span class="o">+</span> \
                                     <span class="s1">&#39;-time&#39;</span> <span class="o">+</span> \
                                     <span class="s1">&#39;-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">)</span>
                            <span class="n">CF_RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span><span class="p">[</span><span class="n">cf_tag</span><span class="p">]</span>
                            <span class="c1"># CF_RV = RandomVariableSubset(RVd[&#39;DV_REP&#39;],</span>
                            <span class="c1">#                              tags=cf_tag)</span>
                            <span class="n">CF_time</span> <span class="o">=</span> <span class="n">ConsequenceFunction</span><span class="p">(</span><span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                                          <span class="n">DV_distribution</span><span class="o">=</span><span class="n">CF_RV</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_time</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;red_tag&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;red_tag&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_constant_median_DV</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
                                <span class="n">cf_tag</span> <span class="o">=</span> <span class="s1">&#39;RED-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DS_ID</span> <span class="o">+</span> \
                                         <span class="s1">&#39;-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">)</span>
                                <span class="n">CF_RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_RED_dict</span><span class="p">[</span><span class="n">cf_tag</span><span class="p">]</span>
                                <span class="c1"># CF_RV = RandomVariableSubset(RVd[&#39;DV_RED&#39;],</span>
                                <span class="c1">#                              tags=cf_tag)</span>
                                <span class="n">CF_red_tag</span> <span class="o">=</span> <span class="n">ConsequenceFunction</span><span class="p">(</span><span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                                                 <span class="n">DV_distribution</span><span class="o">=</span><span class="n">CF_RV</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">CF_red_tag</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_red_tag</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">CF_inj_set</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">inj_i</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DS</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">][</span><span class="s1">&#39;theta&#39;</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                                    <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_constant_median_DV</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
                                    <span class="n">cf_tag</span> <span class="o">=</span> <span class="s1">&#39;INJ-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DS_ID</span> <span class="o">+</span> \
                                             <span class="s1">&#39;-</span><span class="si">{}</span><span class="s1">-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inj_i</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">)</span>
                                    <span class="n">CF_RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_INJ_dict</span><span class="p">[</span><span class="n">cf_tag</span><span class="p">]</span>
                                    <span class="c1"># CF_RV = RandomVariableSubset(RVd[&#39;DV_INJ&#39;],</span>
                                    <span class="c1">#                              tags=cf_tag)</span>
                                    <span class="n">CF_inj_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConsequenceFunction</span><span class="p">(</span>
                                        <span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                        <span class="n">DV_distribution</span><span class="o">=</span><span class="n">CF_RV</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">CF_inj_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_inj_set</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span>

                        <span class="c1"># add the DS to the list</span>
                        <span class="k">if</span> <span class="s1">&#39;affected_area&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">AA</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;affected_area&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">AA</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="c1"># TODO: make this smarter by making affected_area a property of DS</span>
                        <span class="n">DS_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DamageState</span><span class="p">(</span>
                            <span class="n">ID</span><span class="o">=</span><span class="n">ds_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="n">DS</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                            <span class="n">weight</span><span class="o">=</span><span class="n">DS</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">],</span>
                            <span class="n">affected_area</span><span class="o">=</span><span class="n">AA</span><span class="p">,</span>
                            <span class="n">repair_cost_CF</span><span class="o">=</span><span class="n">CF_cost</span><span class="p">,</span>
                            <span class="n">reconstruction_time_CF</span><span class="o">=</span><span class="n">CF_time</span><span class="p">,</span>
                            <span class="n">red_tag_CF</span><span class="o">=</span><span class="n">CF_red_tag</span><span class="p">,</span>
                            <span class="n">injuries_CF_set</span><span class="o">=</span><span class="n">CF_inj_set</span><span class="p">))</span>

                    <span class="c1"># add the DSG to the list</span>
                    <span class="n">DSG_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DamageStateGroup</span><span class="p">(</span>
                        <span class="n">ID</span><span class="o">=</span><span class="n">dsg_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">DS_set</span><span class="o">=</span><span class="n">DS_set</span><span class="p">,</span>
                        <span class="n">DS_set_kind</span><span class="o">=</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set_kind&#39;</span><span class="p">]))</span>

                <span class="c1"># create the fragility functions</span>
                <span class="n">FF_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#CSG_this = np.where(comp[&#39;directions&#39;]==dir_)[0]</span>
                <span class="c1">#PG_weights = np.asarray(comp[&#39;csg_weights&#39;])[CSG_this]</span>
                <span class="c1"># normalize the weights</span>
                <span class="c1">#PG_weights /= sum(PG_weights)</span>
                <span class="k">for</span> <span class="n">csg_id</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_list</span><span class="p">):</span>
                    <span class="c1"># assign the appropriate random variable to the fragility</span>
                    <span class="c1"># function</span>
                    <span class="n">ff_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">-CSG-</span><span class="si">{</span><span class="n">csg_id</span><span class="si">}</span><span class="s1">&#39;</span>
                               <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tags</span><span class="p">]</span>
                    <span class="n">EDP_limit</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span><span class="p">[</span><span class="n">ff_tag</span><span class="p">]</span> <span class="k">for</span> <span class="n">ff_tag</span> <span class="ow">in</span> <span class="n">ff_tags</span><span class="p">]</span>
                    <span class="c1"># RandomVariableSubset(RVd[&#39;FR-&#39; + c_id],</span>
                    <span class="c1">#                              tags=ff_tags)</span>
                    <span class="n">FF_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FragilityFunction</span><span class="p">(</span><span class="n">EDP_limit</span><span class="p">))</span>

                <span class="c1"># create the performance group</span>
                <span class="n">PG</span> <span class="o">=</span> <span class="n">PerformanceGroup</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">PG_ID</span><span class="p">,</span>
                                      <span class="n">location</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
                                      <span class="n">quantity</span><span class="o">=</span><span class="n">QNT</span><span class="p">,</span>
                                      <span class="n">fragility_functions</span><span class="o">=</span><span class="n">FF_set</span><span class="p">,</span>
                                      <span class="n">DSG_set</span><span class="o">=</span><span class="n">DSG_list</span><span class="p">,</span>
                                      <span class="n">csg_weights</span><span class="o">=</span><span class="n">csg_list</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="o">=</span><span class="n">dir_</span>
                                      <span class="p">)</span>
                <span class="n">performance_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PG</span><span class="p">)</span>

            <span class="c1"># create the fragility group</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="n">FragilityGroup</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">FG_ID</span><span class="p">,</span>
                                <span class="c1">#kind=comp[&#39;kind&#39;],</span>
                                <span class="n">demand_type</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;demand_type&#39;</span><span class="p">],</span>
                                <span class="n">performance_groups</span><span class="o">=</span><span class="n">performance_groups</span><span class="p">,</span>
                                <span class="n">directional</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directional&#39;</span><span class="p">],</span>
                                <span class="n">correlation</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">],</span>
                                <span class="n">demand_location_offset</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">],</span>
                                <span class="n">incomplete</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;incomplete&#39;</span><span class="p">],</span>
                                <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">FG_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span>
                                <span class="n">description</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                                <span class="n">unit</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
                                <span class="p">)</span>

            <span class="n">FG_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]:</span><span class="n">FG</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">FG_dict</span>

    <span class="k">def</span> <span class="nf">_sample_event_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sample_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]</span>

        <span class="c1"># month - uniform distribution over [0,11]</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_count</span><span class="p">)</span>

        <span class="c1"># weekday - binomial with p=5/7</span>
        <span class="n">weekday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">5.</span> <span class="o">/</span> <span class="mf">7.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_count</span><span class="p">)</span>

        <span class="c1"># hour - uniform distribution over [0,23]</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_count</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;month&#39;</span>   <span class="p">:</span> <span class="n">month</span><span class="p">,</span>
                                  <span class="s1">&#39;weekday?&#39;</span><span class="p">:</span> <span class="n">weekday</span><span class="p">,</span>
                                  <span class="s1">&#39;hour&#39;</span>    <span class="p">:</span> <span class="n">hour</span><span class="p">},</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_get_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the population characteristics to generate random population samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">POPin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POP_in</span>
        <span class="n">TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span>

        <span class="n">POP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TIME</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LOC&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]))])</span>

        <span class="c1"># if there is a temporal population model available...</span>
        <span class="k">if</span> <span class="s1">&#39;weekday&#39;</span> <span class="ow">in</span> <span class="n">POPin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">weekdays</span> <span class="o">=</span> <span class="n">TIME</span><span class="p">[</span><span class="n">TIME</span><span class="p">[</span><span class="s1">&#39;weekday?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">weekends</span> <span class="o">=</span> <span class="n">TIME</span><span class="p">[</span><span class="o">~</span><span class="n">TIME</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">weekdays</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">POP</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekday&#39;</span><span class="p">][</span><span class="s1">&#39;daily&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekday&#39;</span><span class="p">][</span><span class="s1">&#39;monthly&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)])</span>

                <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekend&#39;</span><span class="p">][</span><span class="s1">&#39;daily&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekend&#39;</span><span class="p">][</span><span class="s1">&#39;monthly&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">POP</span>

    <span class="k">def</span> <span class="nf">_calc_collapses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># There are three options for determining which realizations ended in</span>
        <span class="c1"># collapse.</span>
        <span class="n">GI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span>
        <span class="n">GR</span> <span class="o">=</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
        <span class="n">realizations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]</span>

        <span class="c1"># 1, The simplest case: prescribed collapse rate</span>
        <span class="k">if</span> <span class="n">GR</span><span class="p">[</span><span class="s1">&#39;coll_prob&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;estimated&#39;</span><span class="p">:</span>
            <span class="n">collapsed_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">realizations</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">GR</span><span class="p">[</span><span class="s1">&#39;coll_prob&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">realizations</span><span class="p">),</span>
                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># 2, Collapses estimated using EDP results</span>
        <span class="k">elif</span> <span class="n">GR</span><span class="p">[</span><span class="s1">&#39;CP_est_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;raw EDP&#39;</span><span class="p">:</span>
            <span class="n">demand_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">collapse_limits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">s_edp_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">d_id</span> <span class="ow">in</span> <span class="n">s_edp_keys</span><span class="p">:</span>
                <span class="n">d_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_in</span><span class="p">[</span><span class="n">d_id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_list</span><span class="p">)):</span>
                    <span class="n">demand_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;raw_data&#39;</span><span class="p">])</span>

                    <span class="n">coll_lim</span> <span class="o">=</span> <span class="n">GI</span><span class="p">[</span><span class="s1">&#39;collapse_limits&#39;</span><span class="p">][</span><span class="n">d_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">coll_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">coll_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

                    <span class="n">collapse_limits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">coll_lim</span><span class="p">])</span>

            <span class="n">collapse_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">collapse_limits</span><span class="p">))</span>
            <span class="n">demand_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">demand_data</span><span class="p">))</span>

            <span class="n">EDP_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">demand_data</span> <span class="o">&gt;</span> <span class="n">collapse_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">demand_data</span> <span class="o">&lt;</span> <span class="n">collapse_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">coll_prob</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">EDP_filter</span><span class="p">)</span>
            <span class="n">collapsed_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">realizations</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">coll_prob</span> <span class="o">*</span> <span class="n">realizations</span><span class="p">),</span>
                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># 3, Collapses estimated using sampled EDP distribution</span>
        <span class="k">elif</span> <span class="n">GR</span><span class="p">[</span><span class="s1">&#39;CP_est_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sampled EDP&#39;</span><span class="p">:</span>
            <span class="n">collapsed_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">s_edp_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="n">s_edp_keys</span><span class="p">:</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">demand_ID</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
                <span class="n">collapse_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;collapse_limits&#39;</span><span class="p">][</span><span class="n">kind</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">collapse_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">EDP_samples</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">samples_DF</span>
                    <span class="n">coll_df</span> <span class="o">=</span> <span class="n">EDP_samples</span><span class="p">[</span><span class="n">EDP_samples</span> <span class="o">&gt;</span> <span class="n">collapse_limit</span><span class="p">]</span>
                    <span class="n">collapsed_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">collapsed_IDs</span><span class="p">,</span> <span class="n">coll_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="c1"># get a list of IDs of the collapsed cases</span>
        <span class="n">collapsed_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">collapsed_IDs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">COL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">realizations</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">,</span> <span class="p">])</span>
        <span class="n">COL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">collapsed_IDs</span><span class="p">,</span> <span class="s1">&#39;COL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">COL</span><span class="p">,</span> <span class="n">collapsed_IDs</span>

    <span class="k">def</span> <span class="nf">_calc_damage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">NC_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span>
        <span class="n">DMG</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fg_id</span><span class="p">))</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">DSG</span> <span class="ow">in</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">DS</span> <span class="ow">in</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">:</span>
                    <span class="n">DS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">))</span>
            <span class="n">d_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">DS_list</span><span class="p">)</span>

            <span class="n">MI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">],</span>
                                             <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">_ID</span> <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">PG_set</span><span class="p">],</span>
                                             <span class="n">DS_list</span><span class="p">],</span>
                                            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DSG_DS&#39;</span><span class="p">])</span>

            <span class="n">FG_damages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NC_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MI</span><span class="p">))),</span>
                                      <span class="n">columns</span><span class="o">=</span><span class="n">MI</span><span class="p">,</span>
                                      <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span> <span class="n">RandomVariable</span><span class="p">):</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NC_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">)</span>

                <span class="c1"># get the corresponding demands</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">FG</span><span class="o">.</span><span class="n">_directional</span><span class="p">:</span>
                    <span class="n">demand_ID_list</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">demand_ID</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_type</span><span class="p">:</span>
                            <span class="n">demand_data</span> <span class="o">=</span> <span class="n">demand_ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">demand_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="n">PG</span><span class="o">.</span><span class="n">_location</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_location_offset</span><span class="p">:</span>
                                <span class="n">demand_ID_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demand_ID</span><span class="p">)</span>

                    <span class="n">EDP_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand_ID_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="n">demand_ID_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="n">new_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                            <span class="n">EDP_samples</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">new_samples</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">EDP_samples</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">EDP_samples</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

                    <span class="c1"># scale the max of inputs by 1.2 as per FEMA P58 vol 2 3.2.3</span>
                    <span class="n">EDP_samples</span> <span class="o">*=</span> <span class="mf">1.2</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">demand_ID</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EDP-&#39;</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_type</span> <span class="o">+</span>
                             <span class="s1">&#39;-LOC-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_location_offset</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;-DIR-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_direction</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">EDP_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the required demand is not available, then we are most</span>
                        <span class="c1"># likely analyzing a 3D structure using results from a 2D</span>
                        <span class="c1"># simulation. The best thing we can do in that particular</span>
                        <span class="c1"># case is to use the EDP from the 1 direction for all other</span>
                        <span class="c1"># directions.</span>
                        <span class="n">demand_ID</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EDP-&#39;</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_type</span> <span class="o">+</span>
                                     <span class="s1">&#39;-LOC-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_location_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-DIR-1&#39;</span><span class="p">)</span>
                        <span class="n">EDP_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>

                <span class="n">csg_w_list</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_csg_weights</span>

                <span class="k">for</span> <span class="n">csg_i</span><span class="p">,</span> <span class="n">csg_w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_w_list</span><span class="p">):</span>
                    <span class="n">DSG_df</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_FF_set</span><span class="p">[</span><span class="n">csg_i</span><span class="p">]</span><span class="o">.</span><span class="n">DSG_given_EDP</span><span class="p">(</span><span class="n">EDP_samples</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">DSG</span> <span class="ow">in</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">:</span>
                        <span class="n">in_this_DSG</span> <span class="o">=</span> <span class="n">DSG_df</span><span class="p">[</span><span class="n">DSG_df</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                        <span class="k">if</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                            <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">DS_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span>
                            <span class="n">FG_damages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DSG</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">DS_tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">csg_w</span>
                        <span class="k">elif</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span> <span class="o">==</span> <span class="s1">&#39;mutually exclusive&#39;</span><span class="p">:</span>
                            <span class="n">mut_ex_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;DSG-</span><span class="si">{</span><span class="n">fg_id</span><span class="si">}</span><span class="s1">-DSG-</span><span class="si">{</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="si">}</span><span class="s1">-&#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39;LOC-</span><span class="si">{</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span><span class="si">}</span><span class="s1">-&#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39;DIR-</span><span class="si">{</span><span class="n">PG</span><span class="o">.</span><span class="n">_direction</span><span class="si">}</span><span class="s1">-CSG-</span><span class="si">{</span><span class="n">csg_i</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="n">DS_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DSG_dict</span><span class="p">[</span><span class="n">mut_ex_id</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DSG</span><span class="p">]</span>

                            <span class="c1"># DS_weights = [DS._weight for DS in DSG._DS_set]</span>
                            <span class="c1"># DS_RV = RandomVariable(</span>
                            <span class="c1">#     ID=-1, dimension_tags=[&#39;me_DS&#39;, ],</span>
                            <span class="c1">#     distribution_kind=&#39;multinomial&#39;,</span>
                            <span class="c1">#     p_set=DS_weights)</span>
                            <span class="c1"># DS_df = DS_RV.sample_distribution(</span>
                            <span class="c1">#     len(in_this_DSG)) + 1</span>

                            <span class="k">for</span> <span class="n">DS</span> <span class="ow">in</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">:</span>
                                <span class="n">DS_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span>
                                <span class="n">in_this_DS</span> <span class="o">=</span> <span class="n">DS_df</span><span class="p">[</span><span class="n">DS_df</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">FG_damages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DS</span><span class="p">,</span>
                                               <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">DS_tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">csg_w</span>
                        <span class="k">elif</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span> <span class="o">==</span> <span class="s1">&#39;simultaneous&#39;</span><span class="p">:</span>
                            <span class="n">DS_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">DS</span><span class="o">.</span><span class="n">_weight</span> <span class="k">for</span> <span class="n">DS</span> <span class="ow">in</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">]</span>
                            <span class="n">DS_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_this_DSG</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">DS_weights</span><span class="p">)))</span>
                            <span class="n">which_DS</span> <span class="o">=</span> <span class="n">DS_df</span> <span class="o">&lt;</span> <span class="n">DS_weights</span>
                            <span class="n">any_DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">which_DS</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">no_DS_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">any_DS</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_DS_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">DS_df_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                                    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">no_DS_ids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">DS_weights</span><span class="p">)))</span>
                                <span class="n">which_DS_add</span> <span class="o">=</span> <span class="n">DS_df_add</span> <span class="o">&lt;</span> <span class="n">DS_weights</span>
                                <span class="n">which_DS</span><span class="p">[</span><span class="n">no_DS_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">which_DS_add</span>

                                <span class="n">any_DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">which_DS_add</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">no_DS_ids</span> <span class="o">=</span> <span class="n">no_DS_ids</span><span class="p">[</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">any_DS</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

                            <span class="k">for</span> <span class="n">ds_i</span><span class="p">,</span> <span class="n">DS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">):</span>
                                <span class="n">DS_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span>
                                <span class="n">in_this_DS</span> <span class="o">=</span> <span class="n">which_DS</span><span class="p">[:,</span> <span class="n">ds_i</span><span class="p">]</span>
                                <span class="n">FG_damages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DSG</span><span class="p">[</span><span class="n">in_this_DS</span><span class="p">],</span> <span class="p">(</span>
                                <span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">DS_tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">csg_w</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;Unknown damage state type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span><span class="p">)</span>
                            <span class="p">)</span>

                <span class="n">FG_damages</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">pg_i</span> <span class="o">*</span> <span class="n">d_count</span><span class="p">:(</span><span class="n">pg_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_count</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">FG_damages</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">PG_qnt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">DMG</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">DMG</span><span class="p">,</span> <span class="n">FG_damages</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">DMG</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ncID</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="n">DMG</span> <span class="o">=</span> <span class="n">DMG</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DMG</span>

    <span class="k">def</span> <span class="nf">_calc_red_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">NC_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span>
        <span class="n">DV_RED</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:]]</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">DS_list</span> <span class="o">=</span> <span class="n">DS_list</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">DS_list</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">MI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">],</span>
                                             <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">_ID</span> <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">PG_set</span><span class="p">],</span>
                                             <span class="n">DS_list</span><span class="p">],</span>
                                            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DSG_DS&#39;</span><span class="p">])</span>

            <span class="n">FG_RED</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NC_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MI</span><span class="p">))),</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="n">MI</span><span class="p">,</span>
                                  <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span> <span class="n">RandomVariable</span><span class="p">):</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NC_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">)</span>

                <span class="n">PG_DMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="p">:]]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">PG_qnt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">d_i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DS_list</span><span class="p">):</span>
                    <span class="n">dsg_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">ds_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="n">DS</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">DS</span><span class="o">.</span><span class="n">_red_tag_CF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">RED_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">red_tag_dmg_limit</span><span class="p">(</span>
                            <span class="n">sample_size</span><span class="o">=</span><span class="n">NC_samples</span><span class="p">)</span>
                        <span class="n">RED_samples</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ncID</span>

                        <span class="n">is_red</span> <span class="o">=</span> <span class="n">PG_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                            <span class="n">RED_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="n">FG_RED</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">is_red</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">FG_RED</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">),</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">FG_RED</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">DV_RED</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">DV_RED</span><span class="p">,</span> <span class="n">FG_RED</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="n">DV_RED</span> <span class="o">=</span> <span class="n">DV_RED</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DV_RED</span>

    <span class="k">def</span> <span class="nf">_calc_irreparable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">NC_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span>

        <span class="c1"># determine which realizations lead to irreparable damage</span>
        <span class="c1"># get the max residual drifts</span>
        <span class="n">RID_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">PID_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s_edp_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="n">s_edp_keys</span><span class="p">:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">demand_ID</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;RID&#39;</span><span class="p">:</span>
                <span class="n">r_max</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">RID_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">RID_max</span> <span class="o">=</span> <span class="n">r_max</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">RID_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">RID_max</span><span class="p">,</span> <span class="n">r_max</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;PID&#39;</span><span class="p">:</span>
                <span class="n">d_max</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">PID_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">PID_max</span> <span class="o">=</span> <span class="n">d_max</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PID_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">PID_max</span><span class="p">,</span> <span class="n">d_max</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">RID_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">PID_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># we need to estimate residual drifts based on peak drifts</span>
                <span class="n">RID_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NC_samples</span><span class="p">)</span>

                <span class="c1"># based on FEMA P-58 Vol. 1 5.4</span>
                <span class="n">delta_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;yield_drift&#39;</span><span class="p">]</span>
                <span class="n">small</span> <span class="o">=</span> <span class="n">PID_max</span> <span class="o">&lt;</span> <span class="n">delta_y</span>
                <span class="n">medium</span> <span class="o">=</span> <span class="n">PID_max</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">delta_y</span>
                <span class="n">large</span> <span class="o">=</span> <span class="n">PID_max</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">delta_y</span>

                <span class="n">RID_max</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">=</span> <span class="n">PID_max</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">delta_y</span>
                <span class="n">RID_max</span><span class="p">[</span><span class="n">medium</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">PID_max</span><span class="p">[</span><span class="n">medium</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta_y</span><span class="p">)</span>
                <span class="n">RID_max</span><span class="p">[</span><span class="n">small</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

                <span class="c1"># add extra uncertainty</span>
                <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">small</span><span class="p">))</span>
                <span class="n">RID_max</span><span class="p">[</span><span class="n">RID_max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">RID_max</span><span class="p">[</span><span class="n">RID_max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no drift data is available, then we cannot provide an estimate</span>
                <span class="c1"># of irreparability. We assume that all non-collapse realizations</span>
                <span class="c1"># are repairable in this case.</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="c1"># get the probabilities of irreparability</span>
        <span class="c1"># irrep_frag = self._AIM_in[&#39;general&#39;][&#39;irreparable_res_drift&#39;]</span>
        <span class="c1"># RV_irrep = RandomVariable(ID=-1, dimension_tags=[&#39;RED_irrep&#39;, ],</span>
        <span class="c1">#                           distribution_kind=&#39;lognormal&#39;,</span>
        <span class="c1">#                           theta=irrep_frag[&#39;Median&#39;],</span>
        <span class="c1">#                           COV=irrep_frag[&#39;Beta&#39;] ** 2.</span>
        <span class="c1">#                           )</span>
        <span class="c1"># RED_irrep = RV_irrep.sample_distribution(NC_samples)[&#39;RED_irrep&#39;].values</span>

        <span class="n">RED_irrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">[</span><span class="s1">&#39;RED_irrep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># determine if the realizations are repairable</span>
        <span class="n">irreparable</span> <span class="o">=</span> <span class="n">RID_max</span> <span class="o">&gt;</span> <span class="n">RED_irrep</span>
        <span class="n">irreparable_IDs</span> <span class="o">=</span> <span class="n">ncID</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">irreparable</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">irreparable_IDs</span>

    <span class="k">def</span> <span class="nf">_calc_repair_cost_and_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="n">DMG_by_FG_and_DS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">repID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;repairable&#39;</span><span class="p">]</span>
        <span class="n">REP_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">repID</span><span class="p">)</span>
        <span class="n">DV_COST</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">REP_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span>
                               <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">repID</span><span class="p">)</span>
        <span class="n">DV_TIME</span> <span class="o">=</span> <span class="n">DV_COST</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:]]</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">DS_list</span> <span class="o">=</span> <span class="n">DS_list</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">DS_list</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>

                <span class="k">for</span> <span class="n">d_i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DS_list</span><span class="p">):</span>
                    <span class="n">dsg_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">ds_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="n">DS</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                    <span class="n">TOT_qnt</span> <span class="o">=</span> <span class="n">DMG_by_FG_and_DS</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repID</span><span class="p">,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repID</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span>

                    <span class="c1"># repair cost</span>
                    <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
                        <span class="n">COST_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">unit_repair_cost</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="n">TOT_qnt</span><span class="p">)</span>
                        <span class="n">DV_COST</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>
                        <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">COST_samples</span> <span class="o">*</span> <span class="n">PG_qnt</span>

                    <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
                        <span class="c1"># repair time</span>
                        <span class="n">TIME_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">unit_reconstruction_time</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="n">TOT_qnt</span><span class="p">)</span>
                        <span class="n">DV_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>
                        <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">TIME_samples</span> <span class="o">*</span> <span class="n">PG_qnt</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">DV_COST</span> <span class="o">=</span> <span class="n">DV_COST</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DV_COST</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">DV_TIME</span> <span class="o">=</span> <span class="n">DV_TIME</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DV_TIME</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">DV_COST</span><span class="p">,</span> <span class="n">DV_TIME</span>

    <span class="k">def</span> <span class="nf">_calc_collapse_injuries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inj_lvls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span>

        <span class="c1"># calculate injuries for the collapsed cases</span>
        <span class="c1"># generate collapse modes</span>
        <span class="n">colID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">]</span>
        <span class="n">C_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colID</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">C_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">inj_lvls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span>
            <span class="n">coll_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;collapse_modes&#39;</span><span class="p">]</span>
            <span class="n">P_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmk</span> <span class="k">for</span> <span class="n">cmk</span> <span class="ow">in</span> <span class="n">coll_modes</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="c1"># P_modes = [coll_modes[k][&#39;w&#39;] for k in P_keys]</span>

            <span class="c1"># create the DataFrame that collects the decision variables</span>
            <span class="n">inj_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CM&#39;</span><span class="p">,]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inj_lvls</span><span class="p">):</span>
                <span class="n">inj_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;INJ-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">COL_INJ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">C_samples</span><span class="p">,</span> <span class="n">inj_lvls</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                                   <span class="n">columns</span><span class="o">=</span><span class="n">inj_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">colID</span><span class="p">)</span>

            <span class="c1"># CM_RV = RandomVariable(ID=-1, dimension_tags=[&#39;CM&#39;, ],</span>
            <span class="c1">#                        distribution_kind=&#39;multinomial&#39;,</span>
            <span class="c1">#                        p_set=P_modes)</span>
            <span class="c1">#COL_INJ[&#39;CM&#39;] = CM_RV.sample_distribution(C_samples).values</span>
            <span class="n">COL_INJ</span><span class="p">[</span><span class="s1">&#39;CM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">[</span><span class="s1">&#39;CM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># get the popoulation values corresponding to the collapsed cases</span>
            <span class="n">P_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span>

            <span class="c1"># calculate the exposure of the popoulation</span>
            <span class="k">for</span> <span class="n">cm_i</span><span class="p">,</span> <span class="n">cmk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">P_keys</span><span class="p">):</span>
                <span class="n">mode_IDs</span> <span class="o">=</span> <span class="n">COL_INJ</span><span class="p">[</span><span class="n">COL_INJ</span><span class="p">[</span><span class="s1">&#39;CM&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cm_i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                <span class="n">CFAR</span> <span class="o">=</span> <span class="n">coll_modes</span><span class="p">[</span><span class="n">cmk</span><span class="p">][</span><span class="s1">&#39;affected_area&#39;</span><span class="p">]</span>
                <span class="n">INJ</span> <span class="o">=</span> <span class="n">coll_modes</span><span class="p">[</span><span class="n">cmk</span><span class="p">][</span><span class="s1">&#39;injuries&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">loc_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CFAR</span><span class="p">)):</span>
                    <span class="n">loc_label</span> <span class="o">=</span> <span class="s1">&#39;LOC</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">loc_label</span> <span class="ow">in</span> <span class="n">P_sel</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">inj_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inj_lvls</span><span class="p">):</span>
                            <span class="n">INJ_i</span> <span class="o">=</span> <span class="n">P_sel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mode_IDs</span><span class="p">,</span> <span class="n">loc_label</span><span class="p">]</span> <span class="o">*</span> <span class="n">CFAR</span><span class="p">[</span><span class="n">loc_i</span><span class="p">]</span> <span class="o">*</span> \
                                    <span class="n">INJ</span><span class="p">[</span><span class="n">inj_i</span><span class="p">]</span>
                            <span class="n">COL_INJ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mode_IDs</span><span class="p">,</span> <span class="s1">&#39;INJ-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inj_i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">COL_INJ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mode_IDs</span><span class="p">,</span> <span class="s1">&#39;INJ-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inj_i</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">INJ_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">COL_INJ</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_calc_non_collapse_injuries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">NC_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span>
        <span class="n">DV_INJ_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NC_samples</span><span class="p">,</span>
                                                       <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span>
                                             <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                             <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">)])</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:]]</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">DS_list</span> <span class="o">=</span> <span class="n">DS_list</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">DS_list</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>

                <span class="k">for</span> <span class="n">d_i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DS_list</span><span class="p">):</span>
                    <span class="n">dsg_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">ds_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="n">DS</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">DS</span><span class="o">.</span><span class="n">_affected_area</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">P_affected</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                                      <span class="o">*</span> <span class="n">DS</span><span class="o">.</span><span class="n">_affected_area</span> <span class="o">/</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;plan_area&#39;</span><span class="p">])</span>

                        <span class="n">QNT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span>

                        <span class="c1"># estimate injuries</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">):</span>
                            <span class="n">INJ_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">unit_injuries</span><span class="p">(</span><span class="n">severity_level</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                                           <span class="n">sample_size</span><span class="o">=</span><span class="n">NC_samples</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">INJ_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">INJ_samples</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ncID</span>
                                <span class="n">P_aff_i</span> <span class="o">=</span> <span class="n">P_affected</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>
                                          <span class="s1">&#39;LOC</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span><span class="p">)]</span>
                                <span class="n">INJ_i</span> <span class="o">=</span> <span class="n">INJ_samples</span> <span class="o">*</span> <span class="n">P_aff_i</span> <span class="o">*</span> <span class="n">QNT</span>
                                <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>
                                <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">INJ_i</span>

                                <span class="c1"># remove the useless columns from DV_INJ</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">):</span>
            <span class="n">DV_INJ</span> <span class="o">=</span> <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DV_INJ</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">DV_INJ</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">):</span>
            <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DV_INJ_dict</span></div>


<div class="viewcode-block" id="HAZUS_Assessment"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment">[docs]</a><span class="k">class</span> <span class="nc">HAZUS_Assessment</span><span class="p">(</span><span class="n">Assessment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Assessment class that implements the damage and loss assessment method</span>
<span class="sd">    following the HAZUS Technical Manual and the HAZUS software.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hazard:  {&#39;EQ&#39;, &#39;HU&#39;}</span>
<span class="sd">        Identifies the type of hazard. EQ corresponds to earthquake, HU</span>
<span class="sd">        corresponds to hurricane.</span>
<span class="sd">        default: &#39;EQ&#39;.</span>
<span class="sd">    inj_lvls: int</span>
<span class="sd">        Defines the discretization used to describe the severity of injuries.</span>
<span class="sd">        The HAZUS earthquake methodology uses 4 levels.</span>
<span class="sd">        default: 4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hazard</span><span class="o">=</span><span class="s1">&#39;EQ&#39;</span><span class="p">,</span> <span class="n">inj_lvls</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span> <span class="o">=</span> <span class="n">inj_lvls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hazard</span> <span class="o">=</span> <span class="n">hazard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span> <span class="o">=</span> <span class="s1">&#39;HAZUS_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hazard</span><span class="p">)</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;type: HAZUS Assessment&#39;</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;hazard: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hazard</span><span class="p">))</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>

<div class="viewcode-block" id="HAZUS_Assessment.read_inputs"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.read_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">read_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_DL_input</span><span class="p">,</span> <span class="n">path_EDP_input</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and process the input files to describe the loss assessment task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_DL_input: string</span>
<span class="sd">            Location of the Damage and Loss input file. The file is expected to</span>
<span class="sd">            be a JSON with data stored in a standard format described in detail</span>
<span class="sd">            in the Input section of the documentation.</span>
<span class="sd">        path_EDP_input: string</span>
<span class="sd">            Location of the EDP input file. The file is expected to follow the</span>
<span class="sd">            output formatting of Dakota. The Input section of the documentation</span>
<span class="sd">            provides more information about the expected formatting.</span>
<span class="sd">        verbose: boolean, default: False</span>
<span class="sd">            If True, the method echoes the information read from the files.</span>
<span class="sd">            This can be useful to ensure that the information in the file is</span>
<span class="sd">            properly read by the method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_inputs</span><span class="p">(</span><span class="n">path_DL_input</span><span class="p">,</span>
                                                  <span class="n">path_EDP_input</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># assume that the asset is a building</span>
        <span class="c1"># TODO: If we want to apply HAZUS to non-building assets, several parts of this methodology need to be extended.</span>
        <span class="n">BIM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span>

        <span class="c1"># read component and population data ----------------------------------</span>
        <span class="c1"># components</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Damage and Loss data files...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span> <span class="o">=</span> <span class="n">read_component_DL_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;data_sources&#39;</span><span class="p">][</span><span class="s1">&#39;path_CMP_data&#39;</span><span class="p">],</span> <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">],</span>
            <span class="n">assessment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Available Fragility Groups:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1"> demand:</span><span class="si">{}</span><span class="s1"> PGs: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;demand_type&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">])))</span>

        <span class="c1"># population (if needed)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">][</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;event_time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Population data files...&#39;</span><span class="p">)</span>
                <span class="n">POP</span> <span class="o">=</span> <span class="n">read_population_distribution</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;data_sources&#39;</span><span class="p">][</span><span class="s1">&#39;path_POP_data&#39;</span><span class="p">],</span>
                    <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;occupancy_type&#39;</span><span class="p">],</span>
                    <span class="n">assessment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_assessment_type</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">POP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peak&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

            <span class="n">POP</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIM</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;population&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_POP_in</span> <span class="o">=</span> <span class="n">POP</span></div>

<div class="viewcode-block" id="HAZUS_Assessment.define_random_variables"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.define_random_variables">[docs]</a>    <span class="k">def</span> <span class="nf">define_random_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the random variables used for loss assessment.</span>

<span class="sd">        Following the HAZUS methodology, only the groups of parameters below</span>
<span class="sd">        are considered random. Correlations within groups are not considered</span>
<span class="sd">        because each Fragility Group has only one Performance Group with a</span>
<span class="sd">        in this implementation.</span>

<span class="sd">        1. Demand (EDP) distribution</span>

<span class="sd">        Describe the uncertainty in the demands. Unlike other random variables,</span>
<span class="sd">        the EDPs are characterized by the EDP input data provided earlier. All</span>
<span class="sd">        EDPs are handled in one multivariate lognormal distribution. If more</span>
<span class="sd">        than one sample is provided, the distribution is fit to the EDP data.</span>
<span class="sd">        Otherwise, the provided data point is assumed to be the median value</span>
<span class="sd">        and the additional uncertainty prescribed describes the dispersion. See</span>
<span class="sd">        _create_RV_demands() for more details.</span>

<span class="sd">        2. Fragility EDP limits</span>

<span class="sd">        Describe the uncertainty in the EDP limit that corresponds to</span>
<span class="sd">        exceedance of each Damage State. EDP limits are grouped by Fragility</span>
<span class="sd">        Groups. See _create_RV_fragilities() for details.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">define_random_variables</span><span class="p">()</span>

        <span class="n">DEP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>

        <span class="c1"># create the random variables -----------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># quantities 100</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Quantities...&#39;</span><span class="p">)</span>
        <span class="n">QNT_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_quantities</span><span class="p">(</span><span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">])</span>

        <span class="c1"># self._RV_dict.update({</span>
        <span class="c1">#     &#39;QNT&#39;: self._create_RV_quantities(DEP[&#39;quantities&#39;])})</span>

        <span class="k">if</span> <span class="n">QNT_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">QNT_tags</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_QNT_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">QNT_tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the components have random quantities assigned&#39;</span><span class="p">)</span>

        <span class="c1"># fragilities 300</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Damage State Limits...&#39;</span><span class="p">)</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="n">FF_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_fragilities</span><span class="p">(</span><span class="n">c_id</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span>
                                                  <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;fragilities&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">FF_tags</span><span class="p">))</span>

            <span class="c1"># self._RV_dict.update({</span>
            <span class="c1">#     &#39;FR-&#39; + c_name:</span>
            <span class="c1">#         self._create_RV_fragilities(c_id, comp,DEP[&#39;fragilities&#39;])})</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">FF_tags</span><span class="p">)))</span>

        <span class="c1"># for key, val in self._RV_dict.items():</span>
        <span class="c1">#     if &#39;FR-&#39; in key:</span>
        <span class="c1">#         log_msg(&#39;\t\t\t{}: {}&#39;.format(key, len(val.theta)))</span>

        <span class="c1"># damages (mutually exclusive cases and later simultaneous ones too)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Damage States...&#39;</span><span class="p">)</span>
        <span class="n">DS_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_damage_states</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">DS_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DS_tags</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DSG_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">DS_tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the components have random damage states assigned&#39;</span><span class="p">)</span>

        <span class="c1"># decision variables</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Reconstruction Costs and Times...&#39;</span><span class="p">)</span>
            <span class="n">REP_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_repairs</span><span class="p">(</span>
                <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;rec_costs&#39;</span><span class="p">],</span> <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;rec_times&#39;</span><span class="p">],</span> <span class="n">DEP</span><span class="p">[</span><span class="s1">&#39;cost_and_time&#39;</span><span class="p">])</span>

            <span class="c1"># self._RV_dict.update({</span>
            <span class="c1">#     &#39;DV_REP&#39;: self._create_RV_repairs(DEP[&#39;rec_costs&#39;],</span>
            <span class="c1">#                                       DEP[&#39;rec_times&#39;],</span>
            <span class="c1">#                                       DEP[&#39;cost_and_time&#39;])})</span>

            <span class="k">if</span> <span class="n">REP_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">RV dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">REP_tags</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">REP_tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">None of the components have probabilistic &#39;</span>
                        <span class="s1">&#39;consequence functions&#39;</span><span class="p">)</span>

        <span class="c1"># demands 200</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">EDPs...&#39;</span><span class="p">)</span>

        <span class="n">EDP_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_RV_demands</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">EDP_tags</span><span class="p">)</span>
        <span class="c1">#self._RV_dict.update({&#39;EDP&#39;: self._create_RV_demands()})</span>

        <span class="c1"># sample the random variables -----------------------------------------</span>
        <span class="n">log_msg</span><span class="p">()</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Sampling the random variables...&#39;</span><span class="p">)</span>

        <span class="n">realization_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="n">realization_count</span><span class="p">)</span>

        <span class="c1"># is_coupled = self._AIM_in[&#39;general&#39;][&#39;coupled_assessment&#39;]</span>
        <span class="c1">#</span>
        <span class="c1"># s_rv_keys = sorted(self._RV_dict.keys())</span>
        <span class="c1"># for r_i in s_rv_keys:</span>
        <span class="c1">#     rv = self._RV_dict[r_i]</span>
        <span class="c1">#     if rv is not None:</span>
        <span class="c1">#         log_msg(&#39;\t{}...&#39;.format(r_i))</span>
        <span class="c1">#         rv.sample_distribution(</span>
        <span class="c1">#             sample_size=realization_count,</span>
        <span class="c1">#             preserve_order=((r_i==&#39;EDP&#39;) and is_coupled))</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Sampling completed.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HAZUS_Assessment.define_loss_model"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.define_loss_model">[docs]</a>    <span class="k">def</span> <span class="nf">define_loss_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the stochastic loss model based on the inputs provided earlier.</span>

<span class="sd">        Following the HAZUS methodology, the component assemblies specified in</span>
<span class="sd">        the Damage and Loss input file are used to create Fragility Groups.</span>
<span class="sd">        Each Fragility Group corresponds to one assembly that represents every</span>
<span class="sd">        component of the given type in the structure. See</span>
<span class="sd">        _create_fragility_groups() for more details about the creation of</span>
<span class="sd">        Fragility Groups.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">define_loss_model</span><span class="p">()</span>

        <span class="c1"># fragility groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fragility_groups</span><span class="p">()</span></div>

        <span class="c1"># demands</span>
        <span class="c1"># self._EDP_dict = dict(</span>
        <span class="c1">#     [(tag, RandomVariableSubset(self._RV_dict[&#39;EDP&#39;], tags=tag))</span>
        <span class="c1">#      for tag in self._RV_dict[&#39;EDP&#39;]._dimension_tags])</span>

<div class="viewcode-block" id="HAZUS_Assessment.calculate_damage"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.calculate_damage">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_damage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Characterize the damage experienced in each random event realization.</span>

<span class="sd">        First, the time of the event (month, weekday/weekend, hour) is randomly</span>
<span class="sd">        generated for each realization. Given the event time, if we are interested</span>
<span class="sd">        in injuries, the number of people present at each floor of the building is</span>
<span class="sd">        sampled. The event time is only important if we are interested in injuries,</span>
<span class="sd">        but it is calculated every time because it is not a large overhead and it</span>
<span class="sd">        serves as the basis of indexing every other array.</span>

<span class="sd">        Second, the quantities of components in each damage state are estimated.</span>
<span class="sd">        See _calc_damage() for more details on damage estimation.</span>

<span class="sd">        Finally, the realizations that led to collapse are filtered from the damage</span>
<span class="sd">        data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_damage</span><span class="p">()</span>

        <span class="c1"># event time - month, weekday, and hour realizations</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sampling event time...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_event_time</span><span class="p">()</span>

        <span class="c1"># if we are interested in injuries...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">][</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>
            <span class="c1"># get the population conditioned on event time</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sampling the population...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_population</span><span class="p">()</span>

        <span class="c1"># assume that all cases are non-collapse for damage assessment</span>
        <span class="n">non_collapsed_IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">:</span> <span class="n">non_collapsed_IDs</span><span class="p">})</span>

        <span class="c1"># calculate damage</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating the damage in the non-collapsed cases...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_damage</span><span class="p">()</span>

        <span class="c1"># apply the prescribed damge logic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;damage_logic&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">DL</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;damage_logic&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">DL</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;propagate&#39;</span><span class="p">:</span>
                    <span class="c1"># identify the source and target FG ids</span>
                    <span class="n">source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">DL</span><span class="p">[</span><span class="s1">&#39;source_FG&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">_ID</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">DL</span><span class="p">[</span><span class="s1">&#39;target_FG&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">_ID</span>

                    <span class="c1"># get the source DMG info</span>
                    <span class="n">source_DMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">source_id</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DSG_DS&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                    <span class="c1"># get the PGs in the target FG</span>
                    <span class="n">target_PGs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">DL</span><span class="p">[</span><span class="s1">&#39;target_FG&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">_performance_groups</span>

                    <span class="c1"># for each PG</span>
                    <span class="k">for</span> <span class="n">target_PG</span> <span class="ow">in</span> <span class="n">target_PGs</span><span class="p">:</span>

                        <span class="c1"># get the total quantity</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span> <span class="n">RandomVariable</span><span class="p">):</span>
                            <span class="n">qnt_tot</span> <span class="o">=</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_quantity</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">qnt_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span>
                                                  <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

                        <span class="c1"># get all DSG_DS combinations in the target_PG</span>
                        <span class="n">target_DSG_DS_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)]</span><span class="o">.</span><span class="n">columns</span>

                        <span class="k">for</span> <span class="n">source_DS</span><span class="p">,</span> <span class="n">target_DS</span> <span class="ow">in</span> <span class="n">DL</span><span class="p">[</span><span class="s1">&#39;DS_links&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                            <span class="c1"># get the damaged quantity</span>
                            <span class="n">qnt_dmg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

                            <span class="c1"># get the undamaged quantity</span>
                            <span class="n">qnt_undmg</span> <span class="o">=</span> <span class="n">qnt_tot</span> <span class="o">-</span> <span class="n">qnt_dmg</span>

                            <span class="c1"># get the mapping based on source_dmg and source DS</span>
                            <span class="n">dmg_map</span> <span class="o">=</span> <span class="n">source_DMG</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">source_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">source_DS</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">]</span>

                            <span class="c1"># get the damage states exceeded by target_DS</span>
                            <span class="n">exc_DS</span> <span class="o">=</span> <span class="n">target_DSG_DS_list</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_DSG_DS_list</span> <span class="o">==</span> <span class="n">target_DS</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

                            <span class="c1"># sum up the damage in the exceeded DSs + no damage</span>
                            <span class="n">exc_dmg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dmg_map</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">exc_DS</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

                            <span class="n">exc_dmg</span> <span class="o">=</span> <span class="n">exc_dmg</span> <span class="o">+</span> <span class="n">qnt_undmg</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dmg_map</span><span class="p">]</span>

                            <span class="c1"># save this damage to the target_DS and zero to lower DSs</span>
                            <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">exc_DS</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dmg_map</span><span class="p">,</span> <span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">ds_i</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dmg_map</span><span class="p">,</span> <span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">target_PG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">target_DS</span><span class="p">)]</span> <span class="o">=</span> <span class="n">exc_dmg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unkown damage logic: </span><span class="si">{</span><span class="n">DL</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># collapses are indicated by the ultimate DS in HAZUS</span>
        <span class="n">DMG_agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;4_2&#39;</span> <span class="ow">in</span> <span class="n">DMG_agg</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">collapse_flag</span> <span class="o">=</span> <span class="n">DMG_agg</span><span class="p">[</span><span class="s1">&#39;4_2&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">collapse_flag</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DMG_agg</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;collapse&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="p">[</span><span class="n">collapse_flag</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)})</span>
        <span class="c1"># Note: Non-collapse IDs are not updated because we use the same</span>
        <span class="c1"># procedure to estimate injuries (and potentially other decision vars)</span>
        <span class="c1"># under collapse and non-collapse cases</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">,</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">collapse_flag</span><span class="p">,</span> <span class="s1">&#39;COL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="HAZUS_Assessment.calculate_losses"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.calculate_losses">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Characterize the consequences of damage in each random event realization.</span>

<span class="sd">        For the sake of efficiency, only the decision variables requested in</span>
<span class="sd">        the input file are estimated. The following consequences are handled by</span>
<span class="sd">        this method for a HAZUS assessment:</span>

<span class="sd">        Reconstruction time and cost</span>
<span class="sd">        Get a cost and time estimate for each Damage State in each Performance</span>
<span class="sd">        Group. For more information about estimating reconstruction cost and</span>
<span class="sd">        time see _calc_repair_cost_and_time() methods.</span>

<span class="sd">        Injuries</span>
<span class="sd">        The number of injuries are based on the probability of injuries of</span>
<span class="sd">        various severity specified in the component data file. For more</span>
<span class="sd">        information about estimating injuries _calc_non_collapse_injuries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_losses</span><span class="p">()</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="c1"># reconstruction cost and time</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="c1"># all damages are considered repairable in HAZUS</span>
            <span class="n">repairable_IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;repairable&#39;</span><span class="p">:</span> <span class="n">repairable_IDs</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;irreparable&#39;</span><span class="p">:</span> <span class="p">[]})</span>

            <span class="c1"># reconstruction cost and time for repairable cases</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating Reconstruction cost and time...&#39;</span><span class="p">)</span>
            <span class="n">DV_COST</span><span class="p">,</span> <span class="n">DV_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_repair_cost_and_time</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">:</span> <span class="n">DV_COST</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;rec_time&#39;</span><span class="p">:</span> <span class="n">DV_TIME</span><span class="p">})</span>

        <span class="c1"># injuries due to collapse</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>

            <span class="c1"># injuries in non-collapsed cases</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculating Injuries in Non-Collapsed Cases...&#39;</span><span class="p">)</span>
            <span class="n">DV_INJ_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_non_collapse_injuries</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;injuries&#39;</span><span class="p">:</span> <span class="n">DV_INJ_dict</span><span class="p">})</span></div>

<div class="viewcode-block" id="HAZUS_Assessment.aggregate_results"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.aggregate_results">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_msg</span><span class="p">(</span><span class="n">log_div</span><span class="p">)</span>
        <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;Aggregating results...&#39;</span><span class="p">)</span>

        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="n">MI_raw</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;collapses&#39;</span><span class="p">,</span> <span class="s1">&#39;collapsed&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;highest damage state&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;highest damage state&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;highest damage state&#39;</span><span class="p">,</span> <span class="s1">&#39;NSD&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost impractical&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">MI_raw</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="c1">#(&#39;reconstruction&#39;, &#39;time impractical?&#39;),</span>
                <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>
            <span class="n">MI_raw</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;inhabitants&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev3&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="s1">&#39;sev4&#39;</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;event_time&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;off&#39;</span><span class="p">)):</span>
            <span class="n">MI_raw</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="s1">&#39;weekday?&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">colID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">repID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;repairable&#39;</span><span class="p">]</span>
            <span class="n">irID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">]</span>

        <span class="n">MI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">MI_raw</span><span class="p">)</span>

        <span class="n">SUMMARY</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">MI</span><span class="p">))),</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">MI</span><span class="p">)</span>
        <span class="n">SUMMARY</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="c1"># event time (if needed)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;event_time&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;off&#39;</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;weekday?&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;event time&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">prop</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span>

        <span class="c1"># collapses</span>
        <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;collapses&#39;</span><span class="p">,</span> <span class="s1">&#39;collapsed&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># damage</span>
        <span class="c1"># remove the ground failure FGs first</span>
        <span class="n">DMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">FG_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">FG_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GF&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">DMG</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">FG_name</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">comp_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA&#39;</span><span class="p">,</span> <span class="s1">&#39;NSD&#39;</span><span class="p">]:</span>
            <span class="n">fg_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span> <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">fg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">comp_type</span><span class="p">)]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fg_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

                <span class="n">DMG_agg</span> <span class="o">=</span> <span class="n">DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">fg_list</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DSG_DS&#39;</span><span class="p">,],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="n">DMG_agg</span><span class="p">[</span><span class="s1">&#39;DS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DMG_agg</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;DS&#39;</span><span class="p">:</span>
                        <span class="n">DMG_agg</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">DMG_agg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;highest damage state&#39;</span><span class="p">,</span> <span class="n">comp_type</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DMG_agg</span><span class="p">[</span><span class="s1">&#39;DS&#39;</span><span class="p">]</span>

        <span class="c1"># reconstruction cost</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">repl_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;replacement_cost&#39;</span><span class="p">]</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_cost</span>

            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost impractical&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">repair_impractical_IDs</span> <span class="o">=</span> <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">repl_cost</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repair_impractical_IDs</span><span class="p">,</span>
                        <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost impractical&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repair_impractical_IDs</span><span class="p">,</span>
                        <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_cost</span>

            <span class="c1"># only keep the non-collapsed cases in the DVs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># reconstruction time</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">repl_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;replacement_time&#39;</span><span class="p">]</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">colID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_time</span>

            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repair_impractical_IDs</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">repl_time</span>

            <span class="c1"># only keep the non-collapsed cases in the DVs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># injuries</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]:</span>

            <span class="c1"># inhabitants</span>
            <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;inhabitants&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">sev_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="c1"># both collapse and non-collapse cases</span>
                <span class="n">sev_tag</span> <span class="o">=</span> <span class="s1">&#39;sev</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sev_id</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">SUMMARY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span><span class="p">,</span> <span class="n">sev_tag</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">][</span><span class="n">sev_id</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># keep only the non-collapse damage data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_COL</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_dict</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SUMMARY</span> <span class="o">=</span> <span class="n">SUMMARY</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HAZUS_Assessment.save_outputs"><a class="viewcode-back" href="../../common/developer_manual/API/pelicun/API_pelicun_control.html#pelicun.control.HAZUS_Assessment.save_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">save_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HAZUS_Assessment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save_outputs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">include_CSG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">include_DSG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_DS</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rho_target</span>
<span class="sd">        c_target</span>
<span class="sd">        include_CSG</span>
<span class="sd">        include_DSG</span>
<span class="sd">        include_DS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set the correlation structure</span>
        <span class="n">rho_FG</span><span class="p">,</span> <span class="n">rho_PG</span><span class="p">,</span> <span class="n">rho_LOC</span><span class="p">,</span> <span class="n">rho_DIR</span><span class="p">,</span> <span class="n">rho_CSG</span><span class="p">,</span> <span class="n">rho_DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC&#39;</span><span class="p">,</span> <span class="s1">&#39;CSG&#39;</span><span class="p">,</span> <span class="s1">&#39;ATC&#39;</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">]:</span>
            <span class="n">rho_DS</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC&#39;</span><span class="p">,</span> <span class="s1">&#39;CSG&#39;</span><span class="p">]:</span>
            <span class="n">rho_CSG</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIR&#39;</span><span class="p">]:</span>
            <span class="n">rho_DIR</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;LOC&#39;</span><span class="p">]:</span>
            <span class="n">rho_LOC</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">]:</span>
            <span class="n">rho_PG</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">rho_target</span> <span class="o">==</span> <span class="s1">&#39;FG&#39;</span><span class="p">:</span>
            <span class="n">rho_FG</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">L_D_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DS_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ATC_rho</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">c_target</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c_id</span> <span class="o">==</span> <span class="n">c_target</span><span class="p">)):</span>
                <span class="n">c_L_D_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">c_DS_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ATC_rho</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">include_DSG</span><span class="p">:</span>
                    <span class="n">DS_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                        <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">include_DS</span><span class="p">:</span>
                            <span class="n">DS_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">DS_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">DS_count</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1">#for loc in comp[&#39;locations&#39;]:</span>
                <span class="c1">#    if include_CSG:</span>
                <span class="c1">#        u_dirs = comp[&#39;directions&#39;]</span>
                <span class="c1">#    else:</span>
                <span class="c1">#        u_dirs = np.unique(comp[&#39;directions&#39;])</span>
                <span class="c1">#    c_L_D_list.append([])</span>
                <span class="c1">#    for dir_ in u_dirs:</span>
                <span class="c1">#        c_DS_list.append(DS_count)</span>
                <span class="c1">#        for ds_i in range(DS_count):</span>
                <span class="c1">#            c_L_D_list[-1].append(dir_)</span>

                <span class="k">for</span> <span class="n">loc_u</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">]):</span>
                    <span class="n">c_L_D_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">csg_weights</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span>
                                                     <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">],</span>
                                                     <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="n">loc_u</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">include_CSG</span><span class="p">:</span>
                                <span class="n">csg_list</span> <span class="o">=</span> <span class="n">csg_weights</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">csg_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,]</span>
                            <span class="k">for</span> <span class="n">csg_</span> <span class="ow">in</span> <span class="n">csg_list</span><span class="p">:</span>
                                <span class="n">c_DS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DS_count</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DS_count</span><span class="p">):</span>
                                    <span class="n">c_L_D_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

                <span class="n">c_dims</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">c_L_D_list</span><span class="p">])</span>
                <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_dims</span><span class="p">)</span>
                <span class="n">L_D_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_L_D_list</span><span class="p">)</span>
                <span class="n">DS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_DS_list</span><span class="p">)</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dims</span><span class="p">)))</span> <span class="o">*</span> <span class="n">rho_FG</span>

        <span class="n">f_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="p">(</span><span class="n">c_L_D_list</span><span class="p">,</span> <span class="n">c_dims</span><span class="p">,</span> <span class="n">c_DS_list</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">L_D_list</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">DS_list</span><span class="p">)):</span>
            <span class="n">c_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">c_dims</span><span class="p">,</span> <span class="n">c_dims</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho_PG</span>

            <span class="c1"># dependencies btw directions</span>
            <span class="k">if</span> <span class="n">rho_DIR</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">loc_D_list</span> <span class="ow">in</span> <span class="n">c_L_D_list</span><span class="p">:</span>
                    <span class="n">l_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_D_list</span><span class="p">)</span>
                    <span class="n">c_rho</span><span class="p">[</span><span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">,</span>
                    <span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_DIR</span>
                    <span class="n">c_pos_id</span> <span class="o">=</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span>

            <span class="c1"># dependencies btw locations</span>
            <span class="k">if</span> <span class="n">rho_LOC</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">flat_dirs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="p">[[</span><span class="n">flat_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">dir_i</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">]</span> <span class="k">for</span> <span class="n">dirs</span> <span class="ow">in</span>
                 <span class="n">c_L_D_list</span><span class="p">]</span>
                <span class="n">flat_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flat_dirs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">u_dir</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">flat_dirs</span><span class="p">):</span>
                    <span class="n">dir_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flat_dirs</span> <span class="o">==</span> <span class="n">u_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                            <span class="n">c_rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_LOC</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">rho_CSG</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rho_target</span> <span class="o">==</span> <span class="s1">&#39;ATC&#39;</span><span class="p">)):</span>
                <span class="n">c_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">rho_target</span> <span class="o">==</span> <span class="s1">&#39;ATC&#39;</span><span class="p">:</span>
                    <span class="n">rho_to_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ATC_rho</span><span class="p">[</span><span class="n">c_id</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rho_to_use</span> <span class="o">=</span> <span class="n">rho_CSG</span>
                <span class="k">for</span> <span class="n">loc_D_list</span> <span class="ow">in</span> <span class="n">c_L_D_list</span><span class="p">:</span>
                    <span class="n">flat_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loc_D_list</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">u_dir</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">flat_dirs</span><span class="p">):</span>
                        <span class="n">dir_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flat_dirs</span> <span class="o">==</span> <span class="n">u_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dir_ids</span><span class="p">:</span>
                                <span class="n">c_rho</span><span class="p">[</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_to_use</span>
                    <span class="n">c_pos_id</span> <span class="o">=</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_D_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rho_DS</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c_pos_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l_dim</span> <span class="ow">in</span> <span class="n">c_DS_list</span><span class="p">:</span>
                    <span class="n">c_rho</span><span class="p">[</span><span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">,</span>
                          <span class="n">c_pos_id</span><span class="p">:</span><span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_DS</span>
                    <span class="n">c_pos_id</span> <span class="o">=</span> <span class="n">c_pos_id</span> <span class="o">+</span> <span class="n">l_dim</span>

            <span class="n">rho</span><span class="p">[</span><span class="n">f_pos_id</span><span class="p">:</span><span class="n">f_pos_id</span> <span class="o">+</span> <span class="n">c_dims</span><span class="p">,</span>
                <span class="n">f_pos_id</span><span class="p">:</span><span class="n">f_pos_id</span> <span class="o">+</span> <span class="n">c_dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_rho</span>
            <span class="n">f_pos_id</span> <span class="o">=</span> <span class="n">f_pos_id</span> <span class="o">+</span> <span class="n">c_dims</span>

        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rho</span>

    <span class="k">def</span> <span class="nf">_create_RV_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_qnt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rho_qnt</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_tags</span><span class="p">,</span> <span class="n">q_dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

        <span class="c1"># collect the parameters for each quantity dimension</span>
        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_id</span><span class="p">]</span>

            <span class="n">u_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">])</span>

            <span class="c1">#dir_weights = comp[&#39;dir_weights&#39;]</span>
            <span class="c1">#theta_list = []</span>
            <span class="c1">#[[theta_list.append(qnt * dw)</span>
            <span class="c1">#  for dw in dir_weights] for qnt in comp[&#39;quantities&#39;]]</span>

            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">]</span>
            <span class="n">q_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_theta</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>

            <span class="n">dist_list</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span>
            <span class="n">q_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_dist</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">)</span>

            <span class="n">cov_list</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">theta_list</span><span class="p">,</span> <span class="n">dist_list</span><span class="p">,</span> <span class="n">cov_list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">dk</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
                    <span class="n">q_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_sig</span><span class="p">,</span> <span class="p">[</span><span class="n">cov</span><span class="o">*</span><span class="n">theta</span><span class="p">,])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_sig</span><span class="p">,</span> <span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="p">])</span>

            <span class="n">q_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tags</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c_id</span><span class="si">}</span><span class="s1">-QNT-</span><span class="si">{</span><span class="n">s_i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">d_i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">s_i</span><span class="p">,</span> <span class="n">d_i</span>
                                      <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span>
                                                  <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]))])</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_qnt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">q_dist</span><span class="o">==</span><span class="s1">&#39;N/A&#39;</span><span class="p">):</span>
            <span class="c1"># remove the unnecessary fields</span>
            <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q_dist</span><span class="o">==</span><span class="s1">&#39;N/A&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_dist</span><span class="p">,</span> <span class="n">q_tags</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">q_vals</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span> <span class="k">for</span> <span class="n">q_vals</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_dist</span><span class="p">,</span> <span class="n">q_tags</span><span class="p">]]</span>

            <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_theta</span><span class="p">)</span>

            <span class="c1"># add lower limits to ensure only positive quantities</span>
            <span class="c1"># zero is probably too low, and it might make sense to introduce upper</span>
            <span class="c1"># limits as well</span>
            <span class="n">tr_lower</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>
            <span class="n">tr_upper</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">q_tag</span><span class="p">,</span> <span class="n">theta_q</span><span class="p">,</span> <span class="n">sig_q</span><span class="p">,</span> <span class="n">dist_q</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">q_tags</span><span class="p">,</span> <span class="n">q_theta</span><span class="p">,</span> <span class="n">q_sig</span><span class="p">,</span> <span class="n">q_dist</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">q_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dist_q</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="n">theta_q</span><span class="p">,</span> <span class="n">sig_q</span><span class="p">],</span>
                    <span class="n">truncation_limits</span><span class="o">=</span><span class="p">[</span><span class="n">tr_lower</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">tr_upper</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="s1">&#39;QNT_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">q_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">rho</span><span class="p">))</span>

            <span class="c1"># q_COV = np.outer(q_sig, q_sig) * rho</span>
            <span class="c1">#</span>
            <span class="c1"># # to avoid truncations affecting other dimensions when rho_QNT is large,</span>
            <span class="c1"># # assign a post-truncation correlation structure</span>
            <span class="c1"># corr_ref = &#39;post&#39;</span>
            <span class="c1">#</span>
            <span class="c1"># quantity_RV = RandomVariable(ID=100,</span>
            <span class="c1">#                              dimension_tags=q_tag,</span>
            <span class="c1">#                              distribution_kind=q_dist,</span>
            <span class="c1">#                              theta=q_theta,</span>
            <span class="c1">#                              COV=q_COV,</span>
            <span class="c1">#                              truncation_limits=[tr_lower, tr_upper],</span>
            <span class="c1">#                              corr_ref=corr_ref)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">q_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_fragilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">rho_fr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_id</span>
<span class="sd">        comp</span>
<span class="sd">        rho_fr</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># prepare the basic multivariate distribution data for one component subgroup considering all damage states</span>
        <span class="n">d_theta</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">,</span> <span class="n">d_tags</span><span class="p">,</span> <span class="n">d_distr_kind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

        <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">d_id</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
            <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">d_id</span><span class="p">]</span>
            <span class="n">d_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_theta</span><span class="p">,</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">])</span>
            <span class="n">d_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_tags</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FF-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">d_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">d_distr_kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_distr_kind</span><span class="p">,</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">])</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_theta</span><span class="p">)</span>

        <span class="c1"># get the total number of random variables for this fragility group</span>
        <span class="c1"># TODO: add the possibility of multiple locations and directions</span>
        <span class="c1">#rv_count = len(comp[&#39;locations&#39;]) * len(comp[&#39;directions&#39;]) * dims</span>
        <span class="n">rv_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">csg_w</span><span class="p">)</span> <span class="k">for</span> <span class="n">csg_w</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]])</span> <span class="o">*</span> <span class="n">dims</span>

        <span class="c1"># create the (empty) input arrays for the RV</span>
        <span class="n">c_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rv_count</span><span class="p">)</span>
        <span class="n">c_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">rv_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">c_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rv_count</span><span class="p">)</span>
        <span class="n">c_distr_kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">rv_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="n">pos_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#for l_id in comp[&#39;locations&#39;]:</span>
        <span class="c1">#    # for each location-direction pair)</span>
        <span class="c1">#    for d_id, __ in enumerate(comp[&#39;directions&#39;]):</span>
        <span class="c1">#        # for each component-subgroup</span>
        <span class="c1">#        c_theta[pos_id:pos_id + dims] = d_theta</span>
        <span class="c1">#        c_sig[pos_id:pos_id + dims] = d_sig</span>
        <span class="c1">#        c_tags[pos_id:pos_id + dims] = [</span>
        <span class="c1">#            t + &#39;-LOC-{}-CSG-{}&#39;.format(l_id, d_id) for t in d_tags]</span>
        <span class="c1">#        c_distr_kind[pos_id:pos_id + dims] = d_distr_kind</span>
        <span class="c1">#        pos_id += dims</span>

        <span class="k">for</span> <span class="n">l_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="n">csg_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">],</span>
                                        <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]):</span>
            <span class="c1"># for each location-direction pair)</span>
            <span class="k">for</span> <span class="n">csg_id</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_list</span><span class="p">):</span>
                <span class="c1"># for each component-subgroup</span>
                <span class="n">c_theta</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_theta</span>
                <span class="n">c_sig</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_sig</span>
                <span class="n">c_tags</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;-LOC-</span><span class="si">{}</span><span class="s1">-DIR-</span><span class="si">{}</span><span class="s1">-CSG-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="n">csg_id</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tags</span><span class="p">]</span>
                <span class="n">c_distr_kind</span><span class="p">[</span><span class="n">pos_id</span><span class="p">:</span><span class="n">pos_id</span> <span class="o">+</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_distr_kind</span>
                <span class="n">pos_id</span> <span class="o">+=</span> <span class="n">dims</span>

        <span class="c1"># create the covariance matrix</span>
        <span class="c1">#c_rho = self._create_correlation_matrix(rho_fr, c_target=c_id,</span>
        <span class="c1">#                                        include_DSG=True,</span>
        <span class="c1">#                                        include_CSG=True)</span>
        <span class="n">c_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">rv_count</span><span class="p">,</span> <span class="n">rv_count</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">c_tags</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">c_tag</span><span class="p">,</span> <span class="n">sig_c</span><span class="p">,</span> <span class="n">theta_c</span><span class="p">,</span> <span class="n">dkind_c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">c_tags</span><span class="p">,</span> <span class="n">c_sig</span><span class="p">,</span> <span class="n">c_theta</span><span class="p">,</span> <span class="n">c_distr_kind</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">c_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dkind_c</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="n">theta_c</span><span class="p">,</span> <span class="n">sig_c</span><span class="p">]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;FF_set_</span><span class="si">{</span><span class="n">c_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">c_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">c_rho</span><span class="p">))</span>

            <span class="c1"># c_COV = np.outer(c_sig, c_sig) * c_rho</span>
            <span class="c1">#</span>
            <span class="c1"># fragility_RV = RandomVariable(ID=300 + c_id,</span>
            <span class="c1">#                               dimension_tags=c_tags,</span>
            <span class="c1">#                               distribution_kind=c_distr_kind,</span>
            <span class="c1">#                               theta=c_theta,</span>
            <span class="c1">#                               COV=c_COV)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">c_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_damage_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">d_tags</span><span class="p">,</span> <span class="n">d_theta</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

            <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set_kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mutually exclusive&#39;</span><span class="p">:</span>

                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">DS_set</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span>
                    <span class="n">DS_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">s_ds_keys</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">,</span> <span class="n">csg_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span>
                                                   <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">],</span>
                                                   <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]):</span>

                        <span class="k">for</span> <span class="n">csg_id</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_list</span><span class="p">):</span>

                            <span class="n">d_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DSG-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">dsg_i</span><span class="si">}</span><span class="s1">-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-&#39;</span>
                                          <span class="sa">f</span><span class="s1">&#39;DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">-CSG-</span><span class="si">{</span><span class="n">csg_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">d_theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DS_weights</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">theta_d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_tags</span><span class="p">,</span> <span class="n">d_theta</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">d_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">theta_d</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">d_tags</span>

    <span class="k">def</span> <span class="nf">_create_RV_repairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_cost</span><span class="p">,</span> <span class="n">rho_time</span><span class="p">,</span> <span class="n">rho_cNt</span><span class="p">):</span>

        <span class="c1"># prepare the cost and time parts of the data separately</span>
        <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_tags</span><span class="p">,</span> <span class="n">ct_dkind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">rho_target</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">rho_cost</span><span class="p">,</span> <span class="n">rho_time</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]):</span>

            <span class="n">f_sig</span><span class="p">,</span> <span class="n">f_tag</span><span class="p">,</span> <span class="n">f_dkind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

            <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_fg_keys</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>

                <span class="n">d_sig</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">,</span> <span class="n">d_dkind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

                <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">dsg_i</span> <span class="ow">in</span> <span class="n">s_dsg_keys</span><span class="p">:</span>
                    <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">dsg_i</span><span class="p">]</span>
                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">ds_i</span> <span class="ow">in</span> <span class="n">s_ds_keys</span><span class="p">:</span>
                        <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">][</span><span class="n">ds_i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">((</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">DS</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">])</span>
                            <span class="n">d_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_dkind</span><span class="p">,</span>
                                                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_sig</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
                            <span class="n">d_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_dkind</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="n">d_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">d_tag</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;REP-</span><span class="si">{</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">dsg_i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ds_i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="c1">#comp[&#39;ID&#39;] + &#39;-&#39; + str(</span>
                                <span class="c1">#    dsg_i) + &#39;-&#39; + str(</span>
                                <span class="c1">#    ds_i) + &#39;-{}&#39;.format(name))</span>

                <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
                    <span class="n">f_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_sig</span><span class="p">,</span> <span class="n">d_sig</span><span class="p">)</span>
                    <span class="n">f_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_dkind</span><span class="p">,</span> <span class="n">d_dkind</span><span class="p">)</span>
                    <span class="n">f_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">f_tag</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tag</span><span class="p">])</span>

            <span class="n">ct_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_sig</span><span class="p">,</span> <span class="n">f_sig</span><span class="p">)</span>
            <span class="n">ct_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">,</span> <span class="n">f_tag</span><span class="p">)</span>
            <span class="n">ct_dkind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_dkind</span><span class="p">,</span> <span class="n">f_dkind</span><span class="p">)</span>

        <span class="n">rho_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_cost</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rho_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="n">rho_time</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">)</span>
        <span class="n">ct_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dims</span><span class="p">,</span> <span class="n">dims</span><span class="p">))</span>

        <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">rho_cNt</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ct_rho</span><span class="p">[:</span><span class="n">dims</span><span class="p">,</span> <span class="p">:</span><span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_c</span>
            <span class="n">ct_rho</span><span class="p">[</span><span class="n">dims</span><span class="p">:,</span> <span class="n">dims</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rho_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># In the special case of mixing perfect correlation between</span>
            <span class="c1"># locations and directions, taking the envelope is not the</span>
            <span class="c1"># appropriate solution. Instead, the LOC &amp; DIR -&gt; PG approach is</span>
            <span class="c1"># used.</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">rho_cost</span> <span class="o">==</span> <span class="s1">&#39;LOC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rho_time</span> <span class="o">==</span><span class="s1">&#39;DIR&#39;</span><span class="p">))</span> <span class="ow">or</span>
                <span class="p">((</span><span class="n">rho_cost</span> <span class="o">==</span> <span class="s1">&#39;DIR&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rho_time</span> <span class="o">==</span> <span class="s1">&#39;LOC&#39;</span><span class="p">))):</span>
                <span class="n">rho_ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_correlation_matrix</span><span class="p">(</span><span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="n">c_target</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                                         <span class="n">include_DSG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                         <span class="n">include_DS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We use the envelope in every other case.</span>
                <span class="n">rho_ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rho_c</span><span class="p">,</span> <span class="n">rho_t</span><span class="p">)</span>

            <span class="n">ct_rho</span><span class="p">[:</span><span class="n">dims</span><span class="p">,</span> <span class="p">:</span><span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_ct</span>
            <span class="n">ct_rho</span><span class="p">[</span><span class="n">dims</span><span class="p">:,</span> <span class="n">dims</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rho_ct</span>

            <span class="c1"># apply the same blocks to the off-diagonal positions</span>
            <span class="n">ct_rho</span><span class="p">[:</span><span class="n">dims</span><span class="p">,</span> <span class="n">dims</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rho_ct</span>
            <span class="n">ct_rho</span><span class="p">[</span><span class="n">dims</span><span class="p">:,</span> <span class="p">:</span><span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_ct</span>

        <span class="c1"># now remove the unnecessary fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ct_dkind</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>

            <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ct_dkind</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ct_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ct_rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ct_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ct_rho</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ct_dkind</span><span class="p">,</span> <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ct_vals</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">ct_vals</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ct_dkind</span><span class="p">,</span> <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_tags</span><span class="p">]]</span>

            <span class="c1"># Create the RVs</span>
            <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="p">(</span><span class="n">ct_tag</span><span class="p">,</span> <span class="n">sig_ct</span><span class="p">,</span> <span class="n">dkind_ct</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">,</span> <span class="n">ct_sig</span><span class="p">,</span> <span class="n">ct_dkind</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">ct_tag</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dkind_ct</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sig_ct</span><span class="p">],</span>
                    <span class="n">truncation_limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                <span class="s1">&#39;DV_REP_set&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RV_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">(</span><span class="n">ct_tags</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">ct_rho</span><span class="p">))</span>

            <span class="c1"># ct_COV = np.outer(ct_sig, ct_sig) * ct_rho</span>
            <span class="c1">#</span>
            <span class="c1"># repair_RV = RandomVariable(ID=401,</span>
            <span class="c1">#                            dimension_tags=ct_tags,</span>
            <span class="c1">#                            distribution_kind=ct_dkind,</span>
            <span class="c1">#                            theta=np.ones(len(ct_sig)),</span>
            <span class="c1">#                            COV=ct_COV,</span>
            <span class="c1">#                            corr_ref=&#39;post&#39;,</span>
            <span class="c1">#                            truncation_limits=[np.zeros(len(ct_sig)),</span>
            <span class="c1">#                                               None])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ct_tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">ct_tags</span>

    <span class="k">def</span> <span class="nf">_create_fragility_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">RVd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RV_dict</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="c1"># use the building replacement cost to calculate the absolute</span>
        <span class="c1"># reconstruction cost for component groups</span>
        <span class="n">repl_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;replacement_cost&#39;</span><span class="p">]</span>

        <span class="c1"># create a list for the fragility groups</span>
        <span class="n">FG_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">c_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_id</span><span class="p">))</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_in</span><span class="p">[</span><span class="n">c_id</span><span class="p">]</span>

            <span class="n">FG_ID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># create a list for the performance groups</span>
            <span class="n">performance_groups</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># one group for each of the stories prescribed by the user</span>
            <span class="n">PG_locations</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">]</span>
            <span class="n">PG_directions</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]</span>
            <span class="n">PG_csg_lists</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;csg_weights&#39;</span><span class="p">]</span>
            <span class="n">PG_dists</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span>
            <span class="n">PG_qnts</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_</span><span class="p">,</span> <span class="n">csg_list</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">qnt</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">PG_locations</span><span class="p">,</span> <span class="n">PG_directions</span><span class="p">,</span> <span class="n">PG_csg_lists</span><span class="p">,</span> <span class="n">PG_dists</span><span class="p">,</span> <span class="n">PG_qnts</span><span class="p">):</span>
                <span class="n">PG_ID</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">FG_ID</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">loc</span> <span class="o">+</span> <span class="n">dir_</span>

                <span class="c1"># get the quantity</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;N/A&#39;</span><span class="p">:</span>
                    <span class="n">QNT</span> <span class="o">=</span> <span class="n">qnt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">QNT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_QNT_dict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c_id</span><span class="si">}</span><span class="s1">-QNT-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                    <span class="c1"># QNT = RandomVariableSubset(RVd[&#39;QNT&#39;],</span>
                    <span class="c1">#     tags=[f&#39;{c_id}-QNT-{loc}-{dir_}&#39;, ])</span>

                <span class="c1"># create the damage objects</span>
                <span class="c1"># consequences are calculated on a performance group level</span>

                <span class="c1"># create a list for the damage state groups and their tags</span>
                <span class="n">DSG_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">d_tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">s_dsg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">dsg_i</span><span class="p">,</span> <span class="n">DSG_ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_dsg_keys</span><span class="p">):</span>
                    <span class="n">DSG</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;DSG_set&#39;</span><span class="p">][</span><span class="n">DSG_ID</span><span class="p">]</span>
                    <span class="n">d_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FF-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span><span class="p">)</span>

                    <span class="c1"># create a list for the damage states</span>
                    <span class="n">DS_set</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">s_ds_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">ds_i</span><span class="p">,</span> <span class="n">DS_ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_ds_keys</span><span class="p">):</span>
                        <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="p">[</span><span class="s1">&#39;DS_set&#39;</span><span class="p">][</span><span class="n">DS_ID</span><span class="p">]</span>

                        <span class="c1"># create the consequence functions</span>
                        <span class="c1"># note: consequences in HAZUS are conditioned on</span>
                        <span class="c1"># damage with no added uncertainty</span>

                        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;repair_cost&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;repair_cost&#39;</span><span class="p">]</span>
                            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="n">data_scaled</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">])</span>
                            <span class="n">data_scaled</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">repl_cost</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_bounded_multilinear_median_DV</span><span class="p">(</span>
                                    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                       <span class="p">(</span><span class="s1">&#39;medians&#39;</span><span class="p">,</span> <span class="s1">&#39;quantities&#39;</span><span class="p">)})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_constant_median_DV</span><span class="p">(</span>
                                    <span class="n">data_scaled</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                <span class="n">cf_tag</span> <span class="o">=</span> <span class="s1">&#39;REP-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DS_ID</span> <span class="o">+</span> \
                                         <span class="s1">&#39;-cost&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span>

                                <span class="n">CF_RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span><span class="p">[</span><span class="n">cf_tag</span><span class="p">]</span>
                                <span class="c1"># CF_RV = RandomVariableSubset(RVd[&#39;DV_REP&#39;],</span>
                                <span class="c1">#                              tags=cf_tag)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">CF_RV</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="n">CF_cost</span> <span class="o">=</span> <span class="n">ConsequenceFunction</span><span class="p">(</span><span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                                          <span class="n">DV_distribution</span><span class="o">=</span><span class="n">CF_RV</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_cost</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;repair_time&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;repair_time&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_bounded_multilinear_median_DV</span><span class="p">(</span>
                                    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                       <span class="p">(</span><span class="s1">&#39;medians&#39;</span><span class="p">,</span> <span class="s1">&#39;quantities&#39;</span><span class="p">)})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_constant_median_DV</span><span class="p">(</span>
                                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;distribution_kind&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                <span class="n">cf_tag</span> <span class="o">=</span> <span class="s1">&#39;REP-&#39;</span> <span class="o">+</span> <span class="n">c_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DSG_ID</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">DS_ID</span> <span class="o">+</span> \
                                         <span class="s1">&#39;-time&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">&#39;</span>

                                <span class="n">CF_RV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DV_REP_dict</span><span class="p">[</span><span class="n">cf_tag</span><span class="p">]</span>
                                <span class="c1"># CF_RV = RandomVariableSubset(RVd[&#39;DV_REP&#39;],</span>
                                <span class="c1">#                              tags=cf_tag)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">CF_RV</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="n">CF_time</span> <span class="o">=</span> <span class="n">ConsequenceFunction</span><span class="p">(</span><span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                                          <span class="n">DV_distribution</span><span class="o">=</span><span class="n">CF_RV</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_time</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># note: no red tag in HAZUS assessments</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;injuries&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">CF_inj_set</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">inj_i</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                                <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;injuries&#39;</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                                    <span class="n">f_median</span> <span class="o">=</span> <span class="n">prep_constant_median_DV</span><span class="p">(</span>
                                        <span class="n">theta</span><span class="p">)</span>
                                    <span class="n">CF_inj_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConsequenceFunction</span><span class="p">(</span>
                                        <span class="n">DV_median</span><span class="o">=</span><span class="n">f_median</span><span class="p">,</span>
                                        <span class="n">DV_distribution</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">CF_inj_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">CF_inj_set</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">]</span>

                        <span class="n">DS_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DamageState</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">ds_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">description</span><span class="o">=</span><span class="n">DS</span><span class="p">[</span>
                                                      <span class="s1">&#39;description&#39;</span><span class="p">],</span>
                                                  <span class="n">weight</span><span class="o">=</span><span class="n">DS</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">],</span>
                                                  <span class="n">repair_cost_CF</span><span class="o">=</span><span class="n">CF_cost</span><span class="p">,</span>
                                                  <span class="n">reconstruction_time_CF</span><span class="o">=</span><span class="n">CF_time</span><span class="p">,</span>
                                                  <span class="n">injuries_CF_set</span><span class="o">=</span><span class="n">CF_inj_set</span>
                                                  <span class="p">))</span>

                    <span class="c1"># add the DSG to the list</span>
                    <span class="n">DSG_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DamageStateGroup</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">dsg_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="n">DS_set</span><span class="o">=</span><span class="n">DS_set</span><span class="p">,</span>
                                                     <span class="n">DS_set_kind</span><span class="o">=</span><span class="n">DSG</span><span class="p">[</span>
                                                         <span class="s1">&#39;DS_set_kind&#39;</span><span class="p">]</span>
                                                     <span class="p">))</span>

                <span class="c1"># create the fragility functions</span>
                <span class="n">FF_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#CSG_this = np.where(comp[&#39;directions&#39;] == dir_)[0]</span>
                <span class="c1">#PG_weights = np.asarray(comp[&#39;csg_weights&#39;])[CSG_this]</span>
                <span class="c1"># normalize the weights</span>
                <span class="c1">#PG_weights /= sum(PG_weights)</span>
                <span class="k">for</span> <span class="n">csg_id</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_list</span><span class="p">):</span>
                    <span class="c1"># assign the appropriate random variable to the fragility</span>
                    <span class="c1"># function</span>
                    <span class="n">ff_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-LOC-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-DIR-</span><span class="si">{</span><span class="n">dir_</span><span class="si">}</span><span class="s1">-CSG-</span><span class="si">{</span><span class="n">csg_id</span><span class="si">}</span><span class="s1">&#39;</span>
                               <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d_tags</span><span class="p">]</span>
                    <span class="n">EDP_limit</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_FF_dict</span><span class="p">[</span><span class="n">ff_tag</span><span class="p">]</span> <span class="k">for</span> <span class="n">ff_tag</span> <span class="ow">in</span> <span class="n">ff_tags</span><span class="p">]</span>
                    <span class="c1"># EDP_limit = RandomVariableSubset(RVd[&#39;FR-&#39; + c_id],</span>
                    <span class="c1">#                                  tags=ff_tags)</span>
                    <span class="n">FF_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FragilityFunction</span><span class="p">(</span><span class="n">EDP_limit</span><span class="p">))</span>

                <span class="c1"># create the performance group</span>
                <span class="n">PG</span> <span class="o">=</span> <span class="n">PerformanceGroup</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">PG_ID</span><span class="p">,</span>
                                      <span class="n">location</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
                                      <span class="n">quantity</span><span class="o">=</span><span class="n">QNT</span><span class="p">,</span>
                                      <span class="n">fragility_functions</span><span class="o">=</span><span class="n">FF_set</span><span class="p">,</span>
                                      <span class="n">DSG_set</span><span class="o">=</span><span class="n">DSG_list</span><span class="p">,</span>
                                      <span class="n">csg_weights</span><span class="o">=</span><span class="n">csg_list</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="o">=</span><span class="n">dir_</span>
                                      <span class="p">)</span>
                <span class="n">performance_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PG</span><span class="p">)</span>

            <span class="c1"># create the fragility group</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="n">FragilityGroup</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">FG_ID</span><span class="p">,</span>
                                <span class="c1">#kind=comp[&#39;kind&#39;],</span>
                                <span class="n">demand_type</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;demand_type&#39;</span><span class="p">],</span>
                                <span class="n">performance_groups</span><span class="o">=</span><span class="n">performance_groups</span><span class="p">,</span>
                                <span class="n">directional</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;directional&#39;</span><span class="p">],</span>
                                <span class="n">correlation</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">],</span>
                                <span class="n">demand_location_offset</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">],</span>
                                <span class="n">incomplete</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;incomplete&#39;</span><span class="p">],</span>
                                <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">FG_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span>
                                <span class="n">description</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                                <span class="n">unit</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
                                <span class="p">)</span>

            <span class="n">FG_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">comp</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]:</span> <span class="n">FG</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">FG_dict</span>

    <span class="k">def</span> <span class="nf">_sample_event_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sample_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;realizations&#39;</span><span class="p">]</span>

        <span class="c1"># month - uniform distribution over [0,11]</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_count</span><span class="p">)</span>

        <span class="c1"># weekday - binomial with p=5/7</span>
        <span class="n">weekday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">5.</span> <span class="o">/</span> <span class="mf">7.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_count</span><span class="p">)</span>

        <span class="c1"># hour - uniform distribution over [0,23]</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_count</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;month&#39;</span>   <span class="p">:</span> <span class="n">month</span><span class="p">,</span>
                                  <span class="s1">&#39;weekday?&#39;</span><span class="p">:</span> <span class="n">weekday</span><span class="p">,</span>
                                  <span class="s1">&#39;hour&#39;</span>    <span class="p">:</span> <span class="n">hour</span><span class="p">},</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_get_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the population characteristics to generate random population samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">POPin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POP_in</span>
        <span class="n">TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TIME</span>

        <span class="n">POP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TIME</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LOC&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]))])</span>

        <span class="c1"># if there is a temporal population model available...</span>
        <span class="k">if</span> <span class="s1">&#39;weekday&#39;</span> <span class="ow">in</span> <span class="n">POPin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">weekdays</span> <span class="o">=</span> <span class="n">TIME</span><span class="p">[</span><span class="n">TIME</span><span class="p">[</span><span class="s1">&#39;weekday?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">weekends</span> <span class="o">=</span> <span class="n">TIME</span><span class="p">[</span><span class="o">~</span><span class="n">TIME</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">weekdays</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">POP</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekday&#39;</span><span class="p">][</span><span class="s1">&#39;daily&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekday&#39;</span><span class="p">][</span><span class="s1">&#39;monthly&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekdays</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)])</span>

                <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekend&#39;</span><span class="p">][</span><span class="s1">&#39;daily&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">POPin</span><span class="p">[</span><span class="s1">&#39;weekend&#39;</span><span class="p">][</span><span class="s1">&#39;monthly&#39;</span><span class="p">])[</span>
                        <span class="n">TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weekends</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">POP</span>

    <span class="k">def</span> <span class="nf">_calc_damage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">NC_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span>

        <span class="n">FG_dmg_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fg_id</span><span class="p">))</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">DSG</span> <span class="ow">in</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">DS</span> <span class="ow">in</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">:</span>
                    <span class="n">DS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">))</span>
            <span class="n">d_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">DS_list</span><span class="p">)</span>

            <span class="n">MI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">],</span>
                                             <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">_ID</span> <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">PG_set</span><span class="p">],</span>
                                             <span class="n">DS_list</span><span class="p">],</span>
                                            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FG&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;DSG_DS&#39;</span><span class="p">])</span>

            <span class="n">FG_damages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NC_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MI</span><span class="p">))),</span>
                                      <span class="n">columns</span><span class="o">=</span><span class="n">MI</span><span class="p">,</span>
                                      <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span> <span class="n">RandomVariable</span><span class="p">):</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PG_qnt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NC_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">PG</span><span class="o">.</span><span class="n">_quantity</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">ncID</span><span class="p">)</span>

                <span class="c1"># get the corresponding demands</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">FG</span><span class="o">.</span><span class="n">_directional</span><span class="p">:</span>
                    <span class="n">demand_ID_list</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">demand_ID</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_type</span><span class="p">:</span>
                            <span class="n">demand_data</span> <span class="o">=</span> <span class="n">demand_ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">demand_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="n">PG</span><span class="o">.</span><span class="n">_location</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_location_offset</span><span class="p">:</span>
                                <span class="n">demand_ID_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demand_ID</span><span class="p">)</span>

                    <span class="n">EDP_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand_ID_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="n">demand_ID_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="n">new_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                            <span class="n">EDP_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">new_samples</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                     <span class="n">EDP_samples</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">demand_ID</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EDP-&#39;</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_type</span> <span class="o">+</span>
                             <span class="s1">&#39;-LOC-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_location_offset</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;-DIR-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_direction</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">demand_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">EDP_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the required demand is not available, then we are most</span>
                        <span class="c1"># likely analyzing a 3D structure using results from a 2D</span>
                        <span class="c1"># simulation. The best thing we can do in that particular</span>
                        <span class="c1"># case is to use the EDP from the 1 direction for all other</span>
                        <span class="c1"># directions.</span>
                        <span class="n">demand_ID</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EDP-&#39;</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_type</span> <span class="o">+</span>
                                     <span class="s1">&#39;-LOC-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span> <span class="o">+</span> <span class="n">FG</span><span class="o">.</span><span class="n">_demand_location_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-DIR-1&#39;</span><span class="p">)</span>
                        <span class="n">EDP_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EDP_dict</span><span class="p">[</span><span class="n">demand_ID</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>

                <span class="n">csg_w_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_csg_weights</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">csg_i</span><span class="p">,</span> <span class="n">csg_w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csg_w_list</span><span class="p">):</span>
                    <span class="n">DSG_df</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_FF_set</span><span class="p">[</span><span class="n">csg_i</span><span class="p">]</span><span class="o">.</span><span class="n">DSG_given_EDP</span><span class="p">(</span><span class="n">EDP_samples</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">DSG</span> <span class="ow">in</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">:</span>
                        <span class="n">in_this_DSG</span> <span class="o">=</span> <span class="n">DSG_df</span><span class="p">[</span><span class="n">DSG_df</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                        <span class="k">if</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                            <span class="n">DS</span> <span class="o">=</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">DS_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span>
                            <span class="n">FG_damages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DSG</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">DS_tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">csg_w</span>
                        <span class="k">elif</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span> <span class="o">==</span> <span class="s1">&#39;mutually exclusive&#39;</span><span class="p">:</span>
                            <span class="n">mut_ex_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;DSG-</span><span class="si">{</span><span class="n">fg_id</span><span class="si">}</span><span class="s1">-DSG-</span><span class="si">{</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="si">}</span><span class="s1">-&#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39;LOC-</span><span class="si">{</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span><span class="si">}</span><span class="s1">-&#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39;DIR-</span><span class="si">{</span><span class="n">PG</span><span class="o">.</span><span class="n">_direction</span><span class="si">}</span><span class="s1">-CSG-</span><span class="si">{</span><span class="n">csg_i</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="n">DS_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DSG_dict</span><span class="p">[</span><span class="n">mut_ex_id</span><span class="p">]</span><span class="o">.</span><span class="n">samples_DF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="n">in_this_DSG</span><span class="p">]</span>

                            <span class="c1"># DS_weights = [DS._weight for DS in DSG._DS_set]</span>
                            <span class="c1"># DS_RV = RandomVariable(</span>
                            <span class="c1">#     ID=-1, dimension_tags=[&#39;me_DS&#39;, ],</span>
                            <span class="c1">#     distribution_kind=&#39;multinomial&#39;,</span>
                            <span class="c1">#     p_set=DS_weights)</span>
                            <span class="c1"># DS_df = DS_RV.sample_distribution(</span>
                            <span class="c1">#     len(in_this_DSG)) + 1</span>

                            <span class="k">for</span> <span class="n">DS</span> <span class="ow">in</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">:</span>
                                <span class="n">DS_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span>
                                <span class="n">in_this_DS</span> <span class="o">=</span> <span class="n">DS_df</span><span class="p">[</span><span class="n">DS_df</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">FG_damages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DS</span><span class="p">,</span>
                                               <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">DS_tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">csg_w</span>
                        <span class="k">elif</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span> <span class="o">==</span> <span class="s1">&#39;simultaneous&#39;</span><span class="p">:</span>
                            <span class="n">DS_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">DS</span><span class="o">.</span><span class="n">_weight</span> <span class="k">for</span> <span class="n">DS</span> <span class="ow">in</span> <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">]</span>
                            <span class="n">DS_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_this_DSG</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">DS_weights</span><span class="p">)))</span>
                            <span class="n">which_DS</span> <span class="o">=</span> <span class="n">DS_df</span> <span class="o">&lt;</span> <span class="n">DS_weights</span>
                            <span class="n">any_DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">which_DS</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">no_DS_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">any_DS</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_DS_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">DS_df_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                                    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">no_DS_ids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">DS_weights</span><span class="p">)))</span>
                                <span class="n">which_DS_add</span> <span class="o">=</span> <span class="n">DS_df_add</span> <span class="o">&lt;</span> <span class="n">DS_weights</span>
                                <span class="n">which_DS</span><span class="p">[</span><span class="n">no_DS_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">which_DS_add</span>

                                <span class="n">any_DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">which_DS_add</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">no_DS_ids</span> <span class="o">=</span> <span class="n">no_DS_ids</span><span class="p">[</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">any_DS</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

                            <span class="k">for</span> <span class="n">ds_i</span><span class="p">,</span> <span class="n">DS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">):</span>
                                <span class="n">DS_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DSG</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">DS</span><span class="o">.</span><span class="n">_ID</span><span class="p">)</span>
                                <span class="n">in_this_DS</span> <span class="o">=</span> <span class="n">which_DS</span><span class="p">[:,</span> <span class="n">ds_i</span><span class="p">]</span>
                                <span class="n">FG_damages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">in_this_DSG</span><span class="p">[</span><span class="n">in_this_DS</span><span class="p">],</span> <span class="p">(</span>
                                    <span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">DS_tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">csg_w</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;Unknown damage state type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">DSG</span><span class="o">.</span><span class="n">_DS_set_kind</span><span class="p">)</span>
                            <span class="p">)</span>

                <span class="n">FG_damages</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">pg_i</span> <span class="o">*</span> <span class="n">d_count</span><span class="p">:(</span><span class="n">pg_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_count</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">FG_damages</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">pg_i</span> <span class="o">*</span> <span class="n">d_count</span><span class="p">:(</span><span class="n">pg_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_count</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">PG_qnt</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


            <span class="n">FG_dmg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FG_damages</span><span class="p">)</span>

        <span class="n">DMG</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">FG_dmg_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">DMG</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ncID</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="n">DMG</span> <span class="o">=</span> <span class="n">DMG</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DMG</span>

    <span class="k">def</span> <span class="nf">_calc_repair_cost_and_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>
        <span class="n">DVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIM_in</span><span class="p">[</span><span class="s1">&#39;decision_variables&#39;</span><span class="p">]</span>

        <span class="n">DMG_by_FG_and_DS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">repID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;repairable&#39;</span><span class="p">]</span>
        <span class="n">DV_COST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repID</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">DV_TIME</span> <span class="o">=</span> <span class="n">DV_COST</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fg_id</span><span class="p">))</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:]]</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">DS_list</span> <span class="o">=</span> <span class="n">DS_list</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">DS_list</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">d_i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DS_list</span><span class="p">):</span>

                <span class="n">dsg_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">ds_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="n">TOT_qnt</span> <span class="o">=</span> <span class="n">DMG_by_FG_and_DS</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repID</span><span class="p">,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span>

                <span class="c1"># check what can we expect later</span>
                <span class="c1"># pull the DS from the first PG</span>
                <span class="n">DS_test</span> <span class="o">=</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
                    <span class="n">COST_samples</span> <span class="o">=</span> <span class="n">DS_test</span><span class="o">.</span><span class="n">unit_repair_cost</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="n">TOT_qnt</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">COST_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># there are no costs assigned to this DS</span>
                        <span class="n">DV_COST</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">DV_COST</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d_tag</span><span class="p">]]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">COST_samples</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                        <span class="c1"># the assigned costs are random numbers</span>
                        <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                            <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>
                            <span class="n">DS</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                            <span class="n">COST_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">unit_repair_cost</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="n">TOT_qnt</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                            <span class="n">DV_COST</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DV_COST</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">COST_samples</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># the assigned costs are identical for all realizations</span>
                        <span class="n">DV_COST</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d_tag</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">COST_samples</span>

                <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
                    <span class="n">TIME_samples</span> <span class="o">=</span> <span class="n">DS_test</span><span class="o">.</span><span class="n">unit_reconstruction_time</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="n">TOT_qnt</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">TIME_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># there are no repair times assigned to this DS</span>
                        <span class="n">DV_TIME</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">DV_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d_tag</span><span class="p">]]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">TIME_samples</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                        <span class="c1"># the assigned repair times are random numbers</span>
                        <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                            <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>
                            <span class="n">DS</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                            <span class="n">TIME_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">unit_reconstruction_time</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="n">TOT_qnt</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                            <span class="n">DV_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DV_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">TIME_samples</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># the assigned repair times are identical for all realizations</span>
                        <span class="n">DV_TIME</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d_tag</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">TIME_samples</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_cost&#39;</span><span class="p">]:</span>
            <span class="n">DV_COST</span> <span class="o">=</span> <span class="n">DV_COST</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DV_COST</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">DVs</span><span class="p">[</span><span class="s1">&#39;rec_time&#39;</span><span class="p">]:</span>
            <span class="n">DV_TIME</span> <span class="o">=</span> <span class="n">DV_TIME</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DV_TIME</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">DV_COST</span><span class="p">,</span> <span class="n">DV_TIME</span>

    <span class="k">def</span> <span class="nf">_calc_non_collapse_injuries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>

        <span class="n">ncID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID_dict</span><span class="p">[</span><span class="s1">&#39;non-collapse&#39;</span><span class="p">]</span>
        <span class="n">P_affected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">]</span>

        <span class="n">NC_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncID</span><span class="p">)</span>
        <span class="n">DV_INJ_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncID</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">s_fg_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fg_id</span> <span class="ow">in</span> <span class="n">s_fg_keys</span><span class="p">:</span>
            <span class="n">log_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fg_id</span><span class="p">))</span>
            <span class="n">FG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FG_dict</span><span class="p">[</span><span class="n">fg_id</span><span class="p">]</span>

            <span class="n">PG_set</span> <span class="o">=</span> <span class="n">FG</span><span class="o">.</span><span class="n">_performance_groups</span>

            <span class="n">DS_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DMG</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:]]</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">DS_list</span> <span class="o">=</span> <span class="n">DS_list</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">DS_list</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">d_i</span><span class="p">,</span> <span class="n">d_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DS_list</span><span class="p">):</span>
                    <span class="n">dsg_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">ds_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d_tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="c1"># check what can we expect later</span>
                    <span class="c1"># pull the DS from the first PG</span>
                    <span class="n">DS_test</span> <span class="o">=</span> <span class="n">PG_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>
                    <span class="n">INJ_samples</span> <span class="o">=</span> <span class="n">DS_test</span><span class="o">.</span><span class="n">unit_injuries</span><span class="p">(</span><span class="n">severity_level</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                                        <span class="n">sample_size</span><span class="o">=</span><span class="n">NC_samples</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">INJ_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># there are no injuries assigned to this DS</span>
                        <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d_tag</span><span class="p">]]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">INJ_samples</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                        <span class="c1"># the assigned injuries are random numbers</span>
                        <span class="n">rnd_inj</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># the assigned injuries are identical for all realizations</span>
                        <span class="n">rnd_inj</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">pg_i</span><span class="p">,</span> <span class="n">PG</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PG_set</span><span class="p">):</span>

                        <span class="n">PG_ID</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_ID</span>
                        <span class="n">DS</span> <span class="o">=</span> <span class="n">PG</span><span class="o">.</span><span class="n">_DSG_set</span><span class="p">[</span><span class="n">dsg_i</span><span class="p">]</span><span class="o">.</span><span class="n">_DS_set</span><span class="p">[</span><span class="n">ds_i</span><span class="p">]</span>

                        <span class="c1"># get injury samples if needed</span>
                        <span class="k">if</span> <span class="n">rnd_inj</span><span class="p">:</span>
                            <span class="n">INJ_samples</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">unit_injuries</span><span class="p">(</span>
                                <span class="n">severity_level</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="n">NC_samples</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                        <span class="n">P_aff_i</span> <span class="o">=</span> <span class="n">P_affected</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;LOC</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PG</span><span class="o">.</span><span class="n">_location</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">INJ_samples</span>
                        <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">FG</span><span class="o">.</span><span class="n">_ID</span><span class="p">,</span> <span class="n">PG_ID</span><span class="p">,</span> <span class="n">d_tag</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">P_aff_i</span>

        <span class="c1"># remove the useless columns from DV_INJ</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">):</span>
            <span class="n">DV_INJ</span> <span class="o">=</span> <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DV_INJ</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">DV_INJ</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># sort the columns to enable index slicing later</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_lvls</span><span class="p">):</span>
            <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DV_INJ_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DV_INJ_dict</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright (c) 2018-2021, Leland Stanford Junior University and The Regents of the University of California.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-158130480-7', 'auto');
    
    ga('send', 'pageview');
    </script>

    
    

  <style>
         .wy-nav-content { max-width: none; }
  </style>

<script>
    /*
    let selectedFilters = [];
    const images  = document.getElementsByClassName("gallery-item");
    const filters = [...document.querySelectorAll('.filter select')];
    const toggles = [...document.querySelectorAll('.filter input')];

    var show = function (elem) {
        elem.style.display = 'block';
    };
    var hide = function (elem) {
        elem.style.display = 'none';
    };
    var toggleFilter =  function(el,elid) {
        const filter = document.getElementById(elid);
        filter.disabled = !el.checked;
       
        if ("createEvent" in document) {
            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("change", false, true);
            filter.dispatchEvent(evt);
        }
        else
            filter.fireEvent("change");
    };
    
    for (const filter of filters) {
        filter.addEventListener('change', function(event) {
            selectedFilters = filters.map(filter => filter.disabled ? '' : filter.value).filter(Boolean);
            console.log(selectedFilters);
            for (const image of images) {
                if (selectedFilters.every(filter => image.classList.contains(filter))) {
                    show(image);
                }
                else {hide(image)};
            };
        })
    };
    */
</script>


</body>
</html>