

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pelicun.model.loss_model &mdash; pelicun  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=f9bf6728" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="../../../_static/hide_empty_pre.js?v=a807066b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F2F2F2" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/pelicun-Logo-grey.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/license.html">1. Copyright and license</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/cite.html">2. Citing pelicun</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/cite.html#logo">3. Logo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/acknowledgments.html">4. Acknowledgments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about/acknowledgments.html#national-science-foundation">4.1. National Science Foundation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/acknowledgments.html#contributors">4.2. Contributors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes/index.html">5. Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../release_notes/index.html#version-3-0">5.1. Version 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../release_notes/index.html#version-2-0">5.2. Version 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../release_notes/index.html#version-1-0">5.3. Version 1.0</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/install.html">1. Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/install.html#staying-up-to-date">1.1. Staying up to date</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/pelicun_framework.html">2. The Pelicun Framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#abbreviations">2.1. Abbreviations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#introduction-to-pelicun">2.2. Introduction to Pelicun</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#overview">2.3. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#performance-assessment-workflow">2.4. Performance Assessment Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#response-model">2.5. Response Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#performance-model">2.6. Performance Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#damage-model">2.7. Damage Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/pelicun_framework.html#loss-model">2.8. Loss Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/feature_overview.html">3. Overview of pelicun features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#saving-loading-samples">3.1. Saving/loading samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#logging-support">3.2. Logging support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#uncertainty-quantification">3.3. Uncertainty quantification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#assessment-types">3.4. Assessment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#demand-simulation">3.5. Demand simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#damage-estimation">3.6. Damage estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#loss-estimation">3.7. Loss estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#command-line-support">3.8. Command-line support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#standalone-tools">3.9. Standalone tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/feature_overview.html#feature-overview-and-examples">3.10. Feature overview and examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/damage_and_loss_library.html">4. Damage and loss library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/bug_reports_and_feature_requests.html">5. Bug reports and feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/resources_for_new_python_users.html">6. Resources for new python users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">7. Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/notebooks/example_1.html">7.1. Example 1: Simple loss function.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/notebooks/example_2.html">7.2. Example 2: Damage state validation.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/notebooks/example_3.html">7.3. Example 3: Combining fragility-based damage consequences and loss functions.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/index.html">8. API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/_autosummary/pelicun.html">8.1. pelicun</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/getting_started.html">1. Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/getting_started.html#code-of-conduct">1.1. Code of conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/getting_started.html#how-to-contribute">1.2. How to contribute</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/development_environment.html">2. Setting up a development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/code_quality.html">3. Coding practice</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/code_quality.html#code-quality-assurance">3.1. Code quality assurance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/code_quality.html#unit-tests">3.2. Unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/code_quality.html#documentation">3.3. Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/internals.html">4. Package architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/internals.html#overview-of-files">4.1. Overview of files</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #F2F2F2" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pelicun</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pelicun.model.loss_model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pelicun.model.loss_model</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2018 Leland Stanford Junior University</span>
<span class="c1"># Copyright (c) 2018 The Regents of the University of California</span>
<span class="c1">#</span>
<span class="c1"># This file is part of pelicun.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer in the documentation</span>
<span class="c1"># and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># 3. Neither the name of the copyright holder nor the names of its contributors</span>
<span class="c1"># may be used to endorse or promote products derived from this software without</span>
<span class="c1"># specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span>
<span class="c1"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c1"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c1"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c1"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c1"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the BSD 3-Clause License along with</span>
<span class="c1"># pelicun. If not, see &lt;http://www.opensource.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># Contributors:</span>
<span class="c1"># Adam Zsarn√≥czay</span>
<span class="c1"># John Vouvakis Manousakis</span>


<span class="sd">&quot;&quot;&quot;Loss model objects and associated methods.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">overload</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegularGridInterpolator</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun</span><span class="w"> </span><span class="kn">import</span> <span class="n">base</span><span class="p">,</span> <span class="n">file_io</span><span class="p">,</span> <span class="n">uq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.model.demand_model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_assemble_required_demand_data</span><span class="p">,</span>
    <span class="n">_get_required_demand_type</span><span class="p">,</span>
    <span class="n">_verify_edps_available</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.model.pelicun_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">PelicunModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.pelicun_warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">InconsistentUnitsError</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.assessment</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssessmentBase</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">idx</span>


<div class="viewcode-block" id="LossModel">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LossModel</span><span class="p">(</span><span class="n">PelicunModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages loss information used in assessments.</span>

<span class="sd">    Contains a loss model for components with Damage States (DS) and</span>
<span class="sd">    one for components with Loss Functions (LF).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ds_model&#39;</span><span class="p">,</span> <span class="s1">&#39;dv_units&#39;</span><span class="p">,</span> <span class="s1">&#39;lf_model&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">assessment</span><span class="p">:</span> <span class="n">AssessmentBase</span><span class="p">,</span>
        <span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">),</span>
        <span class="n">dv_units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize LossModel objects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        assessment: pelicun.AssessmentBase</span>
<span class="sd">            Parent assessment</span>
<span class="sd">        decision_variables: tuple</span>
<span class="sd">            Defines the decision variables to be included in the loss</span>
<span class="sd">            calculations. Defaults to those supported, but fewer can be</span>
<span class="sd">            used if desired. When fewer are used, the loss parameters for</span>
<span class="sd">            those not used will not be required.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">assessment</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="p">:</span> <span class="n">RepairModel_DS</span> <span class="o">=</span> <span class="n">RepairModel_DS</span><span class="p">(</span><span class="n">assessment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="p">:</span> <span class="n">RepairModel_LF</span> <span class="o">=</span> <span class="n">RepairModel_LF</span><span class="p">(</span><span class="n">assessment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span> <span class="o">=</span> <span class="n">decision_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dv_units</span> <span class="o">=</span> <span class="n">dv_units</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines the samples of the ds_model and lf_model sub-models.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The combined loss sample.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle `None` cases</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span>

        <span class="c1"># If both are not None, combine</span>

        <span class="n">ds_model_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span>

        <span class="c1"># add a `ds` level to the lf_model sample</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># add</span>
        <span class="n">new_index</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="c1"># reorder</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="n">new_index</span><span class="p">[</span><span class="n">ds_model_levels</span><span class="p">]</span>
        <span class="n">new_multiindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span><span class="n">new_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_multiindex</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines the loss params of the ds_model and lf_model sub-models.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The combined loss parameter table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle `None` cases</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">loss_params</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_params</span>

        <span class="c1"># If both are not None, combine</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">loss_params</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decision_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the decision variables.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Decision variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pick the object from one of the models</span>
        <span class="c1"># it&#39;s the same for the other(s).</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">decision_variables</span>

    <span class="nd">@decision_variables</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decision_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the decision variables.</span>

<span class="sd">        Supported: {`Cost`, `Time`, `Energy`, `Carbon`}.</span>
<span class="sd">        Could also be any other string, as long as the provided loss</span>
<span class="sd">        parameters contain that decision variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assign the same DVs to the included loss models.</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">decision_variables</span> <span class="o">=</span> <span class="n">decision_variables</span>

<div class="viewcode-block" id="LossModel.add_loss_map">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.add_loss_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_loss_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_map_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_map_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a loss map to the loss model.</span>

<span class="sd">        A loss map defines what loss parameter definition should be</span>
<span class="sd">        used for each component ID in the asset model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_map_path: str or pd.DataFrame or None</span>
<span class="sd">            Path to a csv file or DataFrame object that maps</span>
<span class="sd">            components IDs to their loss parameter definitions.</span>
<span class="sd">        loss_map_policy: str or None</span>
<span class="sd">            If None, does not modify the loss map.</span>
<span class="sd">            If set to `fill`, each component ID that is present in</span>
<span class="sd">            the asset model but not in the loss map is mapped to</span>
<span class="sd">            itself, but `excessiveRID` is excluded.</span>
<span class="sd">            If set to `fill_all`, each component ID that is present in</span>
<span class="sd">            the asset model but not in the loss map is mapped to</span>
<span class="sd">            itself without exceptions.</span>


<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If both arguments are None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loading loss map...&#39;</span><span class="p">)</span>

        <span class="c1"># If no loss map is provided and no default is requested,</span>
        <span class="c1"># there is no loss map and we can&#39;t proceed.</span>
        <span class="k">if</span> <span class="n">loss_map_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">loss_map_policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Please provide a loss map and/or a loss map extension policy.&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># get a list of unique component IDs</span>
        <span class="n">cmp_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">list_unique_component_ids</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">loss_map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loss map is provided.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Read the loss map into a variable</span>
            <span class="n">loss_map</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                <span class="n">loss_map_path</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">reindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss_map</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="c1"># &lt;backwards compatibility&gt;</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="s1">&#39;DMG&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span><span class="p">]):</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;The `DMG-` flag in the loss_map index is deprecated &#39;</span>
                    <span class="s1">&#39;and no longer necessary. &#39;</span>
                    <span class="s1">&#39;Please do not prepend `DMG-` before the component &#39;</span>
                    <span class="s1">&#39;names in the loss map.&#39;</span>
                <span class="p">)</span>
                <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Using default loss map.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Instantiate an empty loss map.</span>
            <span class="n">loss_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Repair&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)})</span>
            <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">loss_map_policy</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_all&#39;</span><span class="p">}:</span>
            <span class="c1"># Populate missing rows with cmp_id -&gt; cmp_id</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">cmp_set</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">loss_map_policy</span> <span class="o">==</span> <span class="s1">&#39;fill&#39;</span> <span class="ow">and</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;excessiveRID&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">loss_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">component</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">component</span>

        <span class="k">elif</span> <span class="n">loss_map_policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Don&#39;t do anything.</span>
            <span class="k">pass</span>

        <span class="c1"># TODO(AZ): add other loss map policies.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Unknown loss map policy: `</span><span class="si">{</span><span class="n">loss_map_policy</span><span class="si">}</span><span class="s1">`.&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Assign the loss map to the available loss models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss_map</span> <span class="o">=</span> <span class="n">loss_map</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loss map loaded successfully.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="LossModel.load_model">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.load_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="n">loss_map</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&lt;backwards compatibility&gt;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;`load_model` is deprecated and will be dropped in &#39;</span>
            <span class="s1">&#39;future versions of pelicun. &#39;</span>
            <span class="s1">&#39;Please use `load_model_parameters` instead.&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_loss_map</span><span class="p">(</span><span class="n">loss_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">(</span><span class="n">data_paths</span><span class="p">,</span> <span class="n">decision_variables</span><span class="p">)</span></div>


<div class="viewcode-block" id="LossModel.load_model_parameters">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.load_model_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load loss model parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_paths: list of (string | DataFrame)</span>
<span class="sd">            List of paths to data or files with loss model</span>
<span class="sd">            information. Default XY datasets can be accessed as</span>
<span class="sd">            PelicunDefault/XY. Order matters. Parameters defined in</span>
<span class="sd">            prior elements in the list take precedence over the same</span>
<span class="sd">            parameters in subsequent data paths. I.e., place the</span>
<span class="sd">            Default datasets in the back.</span>
<span class="sd">        decision_variables: tuple</span>
<span class="sd">            Defines the decision variables to be included in the loss</span>
<span class="sd">            calculations. Defaults to those supported, but fewer can be</span>
<span class="sd">            used if desired. When fewer are used, the loss parameters for</span>
<span class="sd">            those not used will not be required.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">decision_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># &lt;backwards compatibility&gt;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span> <span class="o">=</span> <span class="n">decision_variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;The `decision_variables` argument has been removed. &#39;</span>
                <span class="s1">&#39;Please set your desired decision variables like so: &#39;</span>
                <span class="s1">&#39;{assessment object}.loss.decision_variables &#39;</span>
                <span class="s2">&quot;= (&#39;dv1&#39;, &#39;dv2&#39;, ...) before calling &quot;</span>
                <span class="s1">&#39;{assessment object}.add_loss_map().&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">div</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loading loss parameters...&#39;</span><span class="p">)</span>

        <span class="c1"># replace `PelicunDefault/` flag with default data path</span>
        <span class="n">data_paths</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">substitute_default_path</span><span class="p">(</span><span class="n">data_paths</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># load loss parameter data into the models</span>
        <span class="c1">#</span>

        <span class="k">for</span> <span class="n">data_path</span> <span class="ow">in</span> <span class="n">data_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_data_path</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Loss model parameters loaded successfully.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># remove items</span>
        <span class="c1">#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Removing unused loss model parameters.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">loss_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_models</span><span class="p">:</span>
            <span class="c1"># drop unused loss parameter definitions</span>
            <span class="n">loss_model</span><span class="o">.</span><span class="n">drop_unused_loss_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loss_map</span><span class="p">)</span>
            <span class="c1"># remove components with incomplete loss parameters</span>
            <span class="n">loss_model</span><span class="o">.</span><span class="n">remove_incomplete_components</span><span class="p">()</span>

        <span class="c1"># drop unused damage state columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">drop_unused_damage_states</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># obtain DV units</span>
        <span class="c1">#</span>
        <span class="n">dv_units</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dv_units</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dv_units</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dv_units</span> <span class="o">=</span> <span class="n">dv_units</span>

        <span class="c1">#</span>
        <span class="c1"># convert units</span>
        <span class="c1">#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Converting loss model parameter units.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">loss_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_models</span><span class="p">:</span>
            <span class="n">loss_model</span><span class="o">.</span><span class="n">convert_loss_parameter_units</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># verify loss parameter availability</span>
        <span class="c1">#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Checking loss model parameter &#39;</span>
            <span class="s1">&#39;availability for all components in the asset model.&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_loss_parameter_availability</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_from_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;bldg_repair_DB&#39;</span> <span class="ow">in</span> <span class="n">data_path</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;bldg_repair_DB&#39;</span><span class="p">,</span> <span class="s1">&#39;loss_repair_DB&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;`bldg_repair_DB` is deprecated and will &#39;</span>
                <span class="s1">&#39;be dropped in future versions of pelicun. &#39;</span>
                <span class="s1">&#39;Please use `loss_repair_DB` instead.&#39;</span>
            <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
            <span class="n">data_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">log</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

        <span class="c1"># Check for unit consistency</span>
        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;dv&#39;</span><span class="p">]</span>
        <span class="n">units_isolated</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[(</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]]</span>
        <span class="n">units_isolated</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">])</span>
        <span class="n">units_isolated_grp</span> <span class="o">=</span> <span class="n">units_isolated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">)[</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="n">unit_counts</span> <span class="o">=</span> <span class="n">units_isolated_grp</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">more_than_one</span> <span class="o">=</span> <span class="n">unit_counts</span><span class="p">[</span><span class="n">unit_counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">more_than_one</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InconsistentUnitsError</span>

        <span class="c1"># determine if the loss model parameters are for damage</span>
        <span class="c1"># states or loss functions</span>
        <span class="k">if</span> <span class="n">_is_for_ds_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_is_for_lf_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Invalid loss model parameters: </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<div class="viewcode-block" id="LossModel.calculate">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.calculate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the loss of each component block.</span>

<span class="sd">        Note: This method simply calculates the loss of each component</span>
<span class="sd">        block without any special treatment to `replacement`</span>
<span class="sd">        consequences. This can be done at a later step with the</span>
<span class="sd">        `aggregate_losses` method.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the size of the demand sample and the damage sample</span>
<span class="sd">            don&#39;t match.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">div</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Calculating losses...&#39;</span><span class="p">)</span>

        <span class="c1"># Get the damaged quantities in each damage state for each</span>
        <span class="c1"># component of interest.</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">sample</span>
        <span class="k">assert</span> <span class="n">demand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">demand_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">demand_offset</span>
        <span class="k">assert</span> <span class="n">demand_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">nondirectional_multipliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nondir_multi_dict</span>
        <span class="k">assert</span> <span class="n">nondirectional_multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cmp_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">cmp_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cmp_sample</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;series&#39;</span><span class="p">)</span>
        <span class="n">cmp_marginal_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cmp_marginal_params</span>
        <span class="k">assert</span> <span class="n">cmp_marginal_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO(JVM): FIND A WAY to avoid making a copy of this.</span>
            <span class="n">dmg_quantities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmg_quantities</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The demand sample contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span><span class="si">}</span><span class="s1"> realizations, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;but the damage sample contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dmg_quantities</span><span class="p">)</span><span class="si">}</span><span class="s1">. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Loss calculation cannot proceed when &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;these numbers are different. &#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">dmg_quantities</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
            <span class="n">demand</span><span class="p">,</span>
            <span class="n">cmp_sample</span><span class="p">,</span>
            <span class="n">cmp_marginal_params</span><span class="p">,</span>
            <span class="n">demand_offset</span><span class="p">,</span>
            <span class="n">nondirectional_multipliers</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loss calculation successful.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LossModel.consequence_scaling">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.consequence_scaling">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">consequence_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaling_specification</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply scale factors to losses.</span>

<span class="sd">        Applies scale factors to the loss sample according to the</span>
<span class="sd">        given scaling specification. The scaling specification should</span>
<span class="sd">        be a path to a CSV file. It should contain a `Decision</span>
<span class="sd">        Variable` column with a specified decision variable in each</span>
<span class="sd">        row. Other optional columns are `Component`, `Location`,</span>
<span class="sd">        `Direction`. Each row acts as an independent scaling</span>
<span class="sd">        operation, with the scale factor defined in the `Scale Factor`</span>
<span class="sd">        column, which is required. If any value is missing in the</span>
<span class="sd">        optional columns, it is assumed that the scale factor should</span>
<span class="sd">        be applied to all entries of the loss sample where the other</span>
<span class="sd">        column values match. For example, if the specification has a</span>
<span class="sd">        single row with `Decision Variable` set to &#39;Cost&#39;, `Scale</span>
<span class="sd">        Factor` set to 2.0, and no other columns, this will double the</span>
<span class="sd">        &#39;Cost&#39; DV. If instead `Location` was also set to `1`, it would</span>
<span class="sd">        double the Cost of all components that have that location. The</span>
<span class="sd">        columns `Location` and `Direction` can contain ranges, like</span>
<span class="sd">        this: `1--3` means `1`, `2`, and `3`. If a range is used in</span>
<span class="sd">        both `Location` and `Direction`, the factor of that row will</span>
<span class="sd">        be applied once to all combinations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scaling_specification: str</span>
<span class="sd">            Path to a CSV file containing the scaling specification.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If required columns are missing or contain NaNs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Specify expected dtypes from the start.</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Decision Variable&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Component&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Direction&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Scale Factor&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">scaling_specification_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">scaling_specification</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s1">&#39;Decision Variable&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scaling_specification_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="ow">or</span> <span class="n">scaling_specification_df</span><span class="p">[</span><span class="s1">&#39;Decision Variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The `Decision Variable` column is missing &#39;</span>
                <span class="s1">&#39;from the scaling specification or contains NaN values.&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s1">&#39;Scale Factor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scaling_specification_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="ow">or</span> <span class="n">scaling_specification_df</span><span class="p">[</span><span class="s1">&#39;Scale Factor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The `Scale Factor` column is missing &#39;</span>
                <span class="s1">&#39;from the scaling specification or contains NaN values.&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Add missing optional columns with NaN values</span>
        <span class="n">optional_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Component&#39;</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">optional_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scaling_specification_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">scaling_specification_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Rename the columns to the internally used values</span>
        <span class="n">name_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Decision Variable&#39;</span><span class="p">:</span> <span class="s1">&#39;dv&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Component&#39;</span><span class="p">:</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Direction&#39;</span><span class="p">:</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Scale Factor&#39;</span><span class="p">:</span> <span class="s1">&#39;scaling&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">scaling_specification_df</span> <span class="o">=</span> <span class="n">scaling_specification_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">name_map</span><span class="p">)</span>

        <span class="c1"># Expand ranges in &#39;loc&#39; and &#39;dir&#39;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_expand_range</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>  <span class="c1"># noqa: ANN001, ANN202</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;--&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="c1"># Generate all combinations of loc and dir ranges</span>
        <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">scaling_specification_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">_expand_range</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]),</span> <span class="n">_expand_range</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]))),</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">],</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dv</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">],</span> <span class="n">dmg</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dmg&#39;</span><span class="p">],</span> <span class="n">scaling</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">]),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">expanded_df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Now, for each unique combination in expanded_df, apply</span>
        <span class="c1"># consequence scaling</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">scaling_conditions</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_consequence_scaling</span><span class="p">(</span>
                <span class="n">scaling_conditions</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">],</span> <span class="n">raise_missing</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_consequence_scaling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scaling_conditions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">scale_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">raise_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a scale factor to selected loss sample columns.</span>

<span class="sd">        The scaling conditions are passed as a dictionary mapping</span>
<span class="sd">        level names with their required value for the condition to be</span>
<span class="sd">        met. It has to contain `dv` as one of its keys, defining the</span>
<span class="sd">        decision variable where the factors should be applied. Other</span>
<span class="sd">        valid levels include:</span>
<span class="sd">        - `dmg`: containing a source component name,</span>
<span class="sd">        - `loc`: containing a location,</span>
<span class="sd">        - `dir`: containing a direction,</span>
<span class="sd">        - `uid`: containing a Unique Component ID (UID).</span>

<span class="sd">        If any of the keys is missing, it is assumed that the scaling</span>
<span class="sd">        factor should be applied to all relevant consequences (those</span>
<span class="sd">        matching the remaining values of the hierarchical index).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scaling_conditions: dict</span>
<span class="sd">            A dictionary mapping level names with a single value. Only the</span>
<span class="sd">            rows where the index levels have the provided values will be</span>
<span class="sd">            affected. The dictionary can be empty, in which case all rows</span>
<span class="sd">            will be affected, or contain only some levels and values, in</span>
<span class="sd">            which case only the matching rows will be affected.</span>
<span class="sd">        scale_factor: float</span>
<span class="sd">            Scale factor to use.</span>
<span class="sd">        raise_missing: bool</span>
<span class="sd">            Raise an error if no rows are matching the given conditions.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the scaling_conditions dictionary does not contain a</span>
<span class="sd">            `dv` key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure we won&#39;t apply the same factor to all DVs at once,</span>
        <span class="c1"># highly unlikely anyone would actually want to do this.</span>
        <span class="k">if</span> <span class="s1">&#39;dv&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scaling_conditions</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The index of the `scaling_conditions` dictionary &#39;</span>
                <span class="s1">&#39;should contain a level named `dv` listing the &#39;</span>
                <span class="s1">&#39;relevant decision variable.&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_models</span><span class="p">:</span>
            <span class="c1"># check if it&#39;s empty</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># ensure the levels exist (but don&#39;t check if specified</span>
            <span class="c1"># values exist yet)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scaling_conditions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;`scaling_conditions` contains an unknown level: `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">`.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># apply scale factors</span>
            <span class="n">base</span><span class="o">.</span><span class="n">multiply_factor_multiple_levels</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">scaling_conditions</span><span class="p">,</span>
                <span class="n">scale_factor</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">raise_missing</span><span class="o">=</span><span class="n">raise_missing</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="LossModel.save_sample">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.save_sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_units</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a combined sample of the `ds_model` and `lf_model`.</span>

<span class="sd">        This method handles the storage of a sample of loss estimates,</span>
<span class="sd">        which can either be saved directly to a file or returned as a</span>
<span class="sd">        DataFrame for further manipulation. When saving to a file,</span>
<span class="sd">        additional information such as unit conversion factors and</span>
<span class="sd">        column units can be included. If the data is not being saved</span>
<span class="sd">        to a file, the method can return the DataFrame with or without</span>
<span class="sd">        units as specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str, optional</span>
<span class="sd">            The path to the file where the loss sample should be</span>
<span class="sd">            saved. If not provided, the sample is not saved to disk</span>
<span class="sd">            but returned.</span>
<span class="sd">        save_units: bool, default: False</span>
<span class="sd">            Indicates whether to include a row with unit information</span>
<span class="sd">            in the returned DataFrame. This parameter is ignored if a</span>
<span class="sd">            file path is provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None or tuple</span>
<span class="sd">            If `filepath` is provided, the function returns None after</span>
<span class="sd">            saving the data.</span>
<span class="sd">            If no `filepath` is specified, returns:</span>
<span class="sd">            * DataFrame containing the loss sample.</span>
<span class="sd">            * Optionally, a Series containing the units for each</span>
<span class="sd">            column if `save_units` is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">div</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Saving loss sample...&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">cmp_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">dv_units</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="n">valid_dv_types</span> <span class="o">=</span> <span class="n">dv_units</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_cmp_ids</span> <span class="o">=</span> <span class="n">dv_units</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmp_id</span><span class="p">,</span> <span class="n">dv_type</span> <span class="ow">in</span> <span class="n">cmp_units</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dv_type</span> <span class="ow">in</span> <span class="n">valid_dv_types</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cmp_id</span> <span class="ow">in</span> <span class="n">valid_cmp_ids</span><span class="p">):</span>
                <span class="n">dv_units</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dv_type</span><span class="p">,</span> <span class="n">cmp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmp_units</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cmp_id</span><span class="p">,</span> <span class="n">dv_type</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">save_to_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">dv_units</span><span class="p">,</span>
            <span class="n">unit_conversion_factors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">,</span>
            <span class="n">use_simpleindex</span><span class="o">=</span><span class="p">(</span><span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loss sample successfully saved.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_units</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">units</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="LossModel.load_sample">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.load_sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &lt;backwards compatibility&gt;.</span>

<span class="sd">        Saves the sample of the `ds_model`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;`{loss model}.load_sample` is deprecated and will raise &#39;</span>
            <span class="s1">&#39;in future versions of pelicun. Please use &#39;</span>
            <span class="s1">&#39;{loss model}.ds_model.load_sample instead.&#39;</span>
        <span class="p">)</span>
        <span class="n">dv_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">load_sample</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dv_units</span> <span class="o">=</span> <span class="n">dv_units</span></div>


<div class="viewcode-block" id="LossModel.aggregate_losses">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.LossModel.aggregate_losses">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_losses</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">replacement_configuration</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_combination</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">future</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate the losses produced by each component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        replacement_configuration: Tuple, optional</span>
<span class="sd">            Tuple containing a RandomVariableRegistry and a</span>
<span class="sd">            dictionary. The RandomVariableRegistry is defining</span>
<span class="sd">            building replacement consequence RVs for the active</span>
<span class="sd">            decision variables. The dictionary defines exceedance</span>
<span class="sd">            thresholds. If the aggregated value for a decision</span>
<span class="sd">            variable (conditioned on no replacement) exceeds the</span>
<span class="sd">            threshold, then replacement is triggered. This can happen</span>
<span class="sd">            for multiple decision variables at the same</span>
<span class="sd">            realization. The consequence keyword `replacement` is</span>
<span class="sd">            reserved to represent exclusive triggering of the</span>
<span class="sd">            replacement consequences, and other consequences are</span>
<span class="sd">            ignored for those realizations where replacement is</span>
<span class="sd">            triggered. When assigned to None, then `replacement` is</span>
<span class="sd">            still treated as an exclusive consequence (other</span>
<span class="sd">            consequences are set to zero when replacement is nonzero)</span>
<span class="sd">            but it is not being additionally triggered by the</span>
<span class="sd">            exceedance of any thresholds. The aggregated loss sample</span>
<span class="sd">            contains an additional column with information on whether</span>
<span class="sd">            replacement was already present or triggered by a</span>
<span class="sd">            threshold exceedance for each realization.</span>
<span class="sd">        loss_combination: dict, optional</span>
<span class="sd">            Dictionary defining how losses for specific components</span>
<span class="sd">            should be aggregated for a given decision variable. It has</span>
<span class="sd">            the following structure: {`dv`: {(`c1`, `c2`): `arr`,</span>
<span class="sd">            ...}, ...}, where `dv` is some decision variable, (`c1`,</span>
<span class="sd">            `c2`) is a tuple defining a component pair, `arr` is a NxN</span>
<span class="sd">            numpy array defining a combination table, and `...` means</span>
<span class="sd">            that more key-value pairs with the same schema can exist</span>
<span class="sd">            in the dictionaries.  The loss sample is expected to</span>
<span class="sd">            contain columns that include both `c1` and `c2` listed as</span>
<span class="sd">            the component. The combination is applied to all pairs of</span>
<span class="sd">            columns where the components are `c1` and `c2`, and all of</span>
<span class="sd">            the rest of the multiindex levels match (`loc`, `dir`,</span>
<span class="sd">            `uid`). This means, for example, that when combining wind</span>
<span class="sd">            and flood losses, the asset model should contain both a</span>
<span class="sd">            wind and a flood component defined at the same</span>
<span class="sd">            location-direction.  `arr` can also be an M-dimensional</span>
<span class="sd">            numpy array where each dimension has length N (NxNx...xN).</span>
<span class="sd">            This structure allows for the loss combination of M</span>
<span class="sd">            components.  In this case the (`c1`, `c2`) tuple should</span>
<span class="sd">            contain M elements instead of two.</span>
<span class="sd">        future: bool, optional</span>
<span class="sd">            Defaults to False. When set to True, it enables the</span>
<span class="sd">            updated return type.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Regardless of the value of the arguments, this method does not</span>
<span class="sd">        alter the state of the loss model, i.e., it does not modify</span>
<span class="sd">        the values of the `.sample` attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataframe or tuple</span>
<span class="sd">            Dataframe with the aggregated loss of each realization,</span>
<span class="sd">            and another boolean dataframe with information on which DV</span>
<span class="sd">            thresholds were exceeded in each realization, triggering</span>
<span class="sd">            replacement. If no thresholds are specified it only</span>
<span class="sd">            contains False values. The second dataframe is only</span>
<span class="sd">            returned with `future` set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO(JVM): When we start working on the documentation,</span>
        <span class="c1"># simplify the docstring above and point the relevant detailed</span>
        <span class="c1"># section in the documentation.</span>

        <span class="c1"># validate input</span>
        <span class="k">if</span> <span class="n">replacement_configuration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input_replacement_thresholds</span><span class="p">(</span><span class="n">replacement_configuration</span><span class="p">)</span>
        <span class="c1"># validate loss_combination input</span>
        <span class="k">if</span> <span class="n">loss_combination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input_loss_combination</span><span class="p">(</span><span class="n">loss_combination</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># operate on copes of the loss samples to avoid altering them.</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds_sample</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lf_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lf_sample</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_construct_columns</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;Time&#39;</span>
            <span class="p">]</span>
            <span class="c1"># Note: The `Time` DV gets special treatment.</span>
            <span class="c1"># create the summary DF</span>
            <span class="k">if</span> <span class="s1">&#39;Time&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;repair_time-sequential&#39;</span><span class="p">,</span> <span class="s1">&#39;repair_time-parallel&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">columns</span>

        <span class="k">if</span> <span class="n">ds_sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lf_sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;There are no losses.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">_construct_columns</span><span class="p">())</span>

        <span class="c1">#</span>
        <span class="c1">#  handle `replacement`, regardless of whether</span>
        <span class="c1"># `replacement_thresholds` is empty. (if `replacement`</span>
        <span class="c1"># occurs, we ignore the losses from other componnets)</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="n">ds_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_replacement_exclusive</span><span class="p">(</span><span class="n">ds_sample</span><span class="p">,</span> <span class="n">lf_sample</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># combine samples</span>
        <span class="c1">#</span>

        <span class="c1"># levels to preserve (this aggregates `ds` for the ds_model)</span>
        <span class="n">column_levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="n">combined_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">combined_sample</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">column_levels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># perform loss combinations (special non-additive</span>
        <span class="c1"># aggregations, e.g., Wind + Flood)</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="n">loss_combination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_loss_combinations</span><span class="p">(</span><span class="n">loss_combination</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># consider replacement threshold values</span>
        <span class="c1">#</span>

        <span class="n">sample</span><span class="p">,</span> <span class="n">exceedance_bool_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_replacement_thresholds</span><span class="p">(</span>
            <span class="n">sample</span><span class="p">,</span> <span class="n">replacement_configuration</span>
        <span class="p">)</span>

        <span class="c1"># Sum-up component losses</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">_construct_columns</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;`aggregate_losses` has been expanded to support the &#39;</span>
                <span class="s1">&#39;consideration of the exceedance of loss threshold &#39;</span>
                <span class="s1">&#39;values leading to asset replacement &#39;</span>
                <span class="s1">&#39;(like excessive repair costs). The new implementation &#39;</span>
                <span class="s1">&#39;returns a tuple where the first element is the &#39;</span>
                <span class="s1">&#39;aggregated losses and the second contains information &#39;</span>
                <span class="s1">&#39;on which decision variables triggered replacement &#39;</span>
                <span class="s1">&#39;considering the specified replacement trhesholds. &#39;</span>
                <span class="s1">&#39;To obtain the new output and silence this warning, &#39;</span>
                <span class="s1">&#39;please specify `future=True` as an argument to this method.&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df_agg</span>

        <span class="k">return</span> <span class="n">df_agg</span><span class="p">,</span> <span class="n">exceedance_bool_df</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_input_loss_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_combination</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dv</span><span class="p">,</span> <span class="n">combinations</span> <span class="ow">in</span> <span class="n">loss_combination</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;`loss_combination` contains the key &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">dv</span><span class="si">}</span><span class="s1">` which is not found in the active &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;decision variables. These are: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">components</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">combinations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Invalid type for components in loss combination &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;for `</span><span class="si">{</span><span class="n">dv</span><span class="si">}</span><span class="s1">`: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="si">}</span><span class="s1">. It should be a tuple.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;All elements of the components tuple in loss &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;combination for `</span><span class="si">{</span><span class="n">dv</span><span class="si">}</span><span class="s1">` should be strings.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Invalid type for array in loss combination &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;for `</span><span class="si">{</span><span class="n">dv</span><span class="si">}</span><span class="s1">`: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)</span><span class="si">}</span><span class="s1">. It should be a numpy array.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_input_replacement_thresholds</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">replacement_configuration</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span>
            <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">replacement_consequence_rv_reg</span><span class="p">,</span> <span class="n">replacement_ratios</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">replacement_configuration</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement_consequence_rv_reg</span><span class="p">,</span> <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Invalid type for replacement consequence RV registry: &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">replacement_consequence_rv_reg</span><span class="p">)</span><span class="si">}</span><span class="s1">. It should be &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;uq.RandomVariableRegistry.&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;`replacement_consequence_RV_reg` contains the key &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">` which is not found in the active &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;decision variables. These are: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_error_setup</span><span class="p">(</span>
                    <span class="s1">&#39;Loss/ReplacementThreshold/RaiseOnUnknownKeys&#39;</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">replacement_ratios</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;`replacement_ratios` contains the key &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">` which is not found in the active &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;decision variables. These are: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_error_setup</span><span class="p">(</span>
                    <span class="s1">&#39;Loss/ReplacementThreshold/RaiseOnUnknownKeys&#39;</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># The replacement_consequence_RV_reg should contain an RV for</span>
        <span class="c1"># all active DVs, regardless of whether there is a replacement</span>
        <span class="c1"># threshold for that DV, because when replacememnt is</span>
        <span class="c1"># triggered, we need to assign a consequence for all DVs.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Missing replacement consequence RV &#39;</span> <span class="sa">f</span><span class="s1">&#39;for `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">`.&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_loss_combinations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">loss_combination</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform loss combinations of specified components.</span>

<span class="sd">        This function deconstructs the loss combination arrays,</span>
<span class="sd">        identifies the combinable components, and applies the</span>
<span class="sd">        specified loss combinations to the sample data. The</span>
<span class="sd">        transformed sample, including the combined columns, is</span>
<span class="sd">        returned as a new DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_combination: dict</span>
<span class="sd">            A dictionary containing the loss combination</span>
<span class="sd">            information. The structure is nested dictionaries where</span>
<span class="sd">            the outer keys are decision variables, inner keys are</span>
<span class="sd">            components to combine, and the values are array objects</span>
<span class="sd">            representing the combination data.</span>

<span class="sd">        sample: pandas.DataFrame</span>
<span class="sd">            The input DataFrame containing the sample data. The</span>
<span class="sd">            columns are assumed to be a MultiIndex with at least the</span>
<span class="sd">            levels (decision_variable, loss_id, component_id,</span>
<span class="sd">            location, direction, uid).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A new DataFrame with the combined loss data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># deconstruct combination arrays to extract the input domains</span>
        <span class="n">loss_combination_converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deconstruct_loss_combination_arrays</span><span class="p">(</span>
            <span class="n">loss_combination</span>
        <span class="p">)</span>

        <span class="c1"># initialize variables</span>

        <span class="c1"># sample as dictionary for fast column retrieval</span>
        <span class="n">dsample</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

        <span class="c1"># Transformed sample (includes the combined columns), as</span>
        <span class="c1"># dictionary. Will be turned into a dataframe in the end.</span>
        <span class="c1"># This avoids manipulating the original sample dataframe which</span>
        <span class="c1"># would be slow.</span>
        <span class="n">dcsample</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># add columns to the new sample dictionary.</span>
        <span class="c1"># those that should be combined</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss_combination_add_combinable</span><span class="p">(</span>
            <span class="n">dsample</span><span class="p">,</span> <span class="n">loss_combination_converted</span><span class="p">,</span> <span class="n">dcsample</span>
        <span class="p">)</span>
        <span class="c1"># and the remaining</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dsample</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dcsample</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>  <span class="c1"># noqa: PERF403</span>

        <span class="c1"># turn into a dataframe</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dcsample</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_loss_combination_add_combinable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dsample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">loss_combination_converted</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dcsample</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add combinable loss data.</span>

<span class="sd">        This function identifies groups of `loc`-`dir`-`uid` that can</span>
<span class="sd">        be combined for each decision variable and computes the</span>
<span class="sd">        combined loss using interpolation functions. It modifies the</span>
<span class="sd">        given datasets `dsample` and `dcsample` in-place, removing</span>
<span class="sd">        combinable columns from dsample and adding the combined losses</span>
<span class="sd">        to dcsample.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dsample: dict</span>
<span class="sd">            A dictionary representing the loss sample data, where keys</span>
<span class="sd">            are tuples of the form (decision_variable, loss_id,</span>
<span class="sd">            component_id, location, direction, uid) and values are the</span>
<span class="sd">            corresponding data arrays.</span>

<span class="sd">        loss_combination_converted: dict</span>
<span class="sd">            A dictionary containing loss combination data. The</span>
<span class="sd">            structure is nested dictionaries where the outer keys are</span>
<span class="sd">            decision variables, inner keys are components to combine,</span>
<span class="sd">            and the values are tuples of combination parameters</span>
<span class="sd">            (domains and reference values).</span>

<span class="sd">        dcsample: dict</span>
<span class="sd">            A dictionary to store the combined loss data, where keys</span>
<span class="sd">            are tuples of the form (decision_variable, &#39;combination&#39;,</span>
<span class="sd">            combined_component_string, location, direction, uid) and</span>
<span class="sd">            values are the combined loss data arrays.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dmg_to_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_component_ids_to_loss_ids</span><span class="p">(</span><span class="n">dsample</span><span class="p">)</span>

        <span class="c1"># identify all `loc`-`dir`-`uid`s that can be grouped for each</span>
        <span class="c1"># decision variable.</span>
        <span class="n">potential_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_potential_groups</span><span class="p">(</span><span class="n">dsample</span><span class="p">)</span>

        <span class="c1"># cache already defined interpolation functions. This obviates</span>
        <span class="c1"># the need to define all of them and we can just define them</span>
        <span class="c1"># on the spot when needed, and reuse them if available.</span>
        <span class="n">interpolation_function_cache</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="p">(</span>
            <span class="n">decision_variable</span><span class="p">,</span>
            <span class="n">combination_data</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">loss_combination_converted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">components_to_combine</span><span class="p">,</span>
                <span class="n">combination_parameters</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">combination_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># determine if the components to combine are part of</span>
                <span class="c1"># an available group</span>
                <span class="n">target_group</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">available_group</span> <span class="ow">in</span> <span class="n">potential_groups</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]:</span>
                    <span class="c1"># check if `components_to_combine` is a subset of</span>
                    <span class="c1"># that available group</span>
                    <span class="k">if</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">components_to_combine</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">available_group</span><span class="p">:</span>
                        <span class="n">target_group</span> <span class="o">=</span> <span class="n">available_group</span>
                        <span class="k">break</span>
                <span class="k">assert</span> <span class="n">target_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="c1"># construct relevant loss sample columns</span>
                <span class="k">for</span> <span class="n">loc_dir_uid</span> <span class="ow">in</span> <span class="n">potential_groups</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">][</span><span class="n">target_group</span><span class="p">]:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">decision_variable</span><span class="p">,</span> <span class="n">dmg_to_loss</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">loc_dir_uid</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">target_group</span>
                    <span class="p">]</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">dsample</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span>
                    <span class="c1"># define/get interpolation function</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">interpolation_function_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">components_to_combine</span><span class="p">)</span>
                        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interpolation_function_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">components_to_combine</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">domains</span><span class="p">,</span> <span class="n">reference_values</span> <span class="o">=</span> <span class="n">combination_parameters</span>
                        <span class="n">interp_func</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
                            <span class="n">domains</span><span class="p">,</span> <span class="n">reference_values</span>
                        <span class="p">)</span>
                    <span class="k">assert</span> <span class="n">interp_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">combined_loss</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">combined_loss_col</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">decision_variable</span><span class="p">,</span>
                        <span class="s1">&#39;combination&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components_to_combine</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>
                        <span class="o">*</span><span class="n">loc_dir_uid</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">dcsample</span><span class="p">[</span><span class="n">combined_loss_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_loss</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="n">dsample</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_identify_potential_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># noqa: PLR6301</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify potential groups of `loc`-`dir`-`uid` for each DV.</span>

<span class="sd">        This function identifies all combinations of `loc`-`dir`-`uid`</span>
<span class="sd">        that can be grouped for each decision variable based on the</span>
<span class="sd">        provided data sample.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dsample: iterable</span>
<span class="sd">            An iterable where each containing tuple contains</span>
<span class="sd">            information about the components and their attributes. The</span>
<span class="sd">            expected format of each tuple is (decision_variable,</span>
<span class="sd">            loss_id, component_id, location, direction, uid).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary where keys are decision variables and values</span>
<span class="sd">            are nested dictionaries. The nested dictionaries map</span>
<span class="sd">            frozensets of component IDs to lists of (location,</span>
<span class="sd">            direction, uid) tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouped</span><span class="p">:</span> <span class="n">defaultdict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dsample</span><span class="p">:</span>
            <span class="n">c_dv</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c_dmg</span><span class="p">,</span> <span class="n">c_loc</span><span class="p">,</span> <span class="n">c_dir</span><span class="p">,</span> <span class="n">c_uid</span> <span class="o">=</span> <span class="n">col</span>
            <span class="n">grouped</span><span class="p">[</span><span class="n">c_dv</span><span class="p">][</span><span class="n">c_loc</span><span class="p">,</span> <span class="n">c_dir</span><span class="p">,</span> <span class="n">c_uid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_dmg</span><span class="p">)</span>
        <span class="c1"># invert so that we have component sets mapped to</span>
        <span class="c1"># `loc`-`dir`-`uid`s.</span>
        <span class="n">inverted</span><span class="p">:</span> <span class="n">defaultdict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c_dv</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">loc_dir_uid</span><span class="p">,</span> <span class="n">component_set</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">[</span><span class="n">c_dv</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">inverted</span><span class="p">[</span><span class="n">c_dv</span><span class="p">][</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">component_set</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc_dir_uid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inverted</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_map_component_ids_to_loss_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># noqa: PLR6301</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map component IDs to loss IDs.</span>

<span class="sd">        This function maps components to losses based on the loss</span>
<span class="sd">        sample&#39;s columns. It assumes that multiple component IDs can</span>
<span class="sd">        have the same loss ID, but the same component ID cannot have</span>
<span class="sd">        multiple loss IDs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dsample: tuple dictionary keys</span>
<span class="sd">            Each tuple contains information about the components and</span>
<span class="sd">            corresponding losses.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary where keys are component IDs and values are</span>
<span class="sd">            loss IDs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dmg_to_loss</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dsample</span><span class="p">:</span>
            <span class="n">c_loss</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c_dmg</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dmg_to_loss</span><span class="p">[</span><span class="n">c_dmg</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_loss</span>
        <span class="k">return</span> <span class="n">dmg_to_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_deconstruct_loss_combination_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_combination</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># noqa: PLR6301</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deconstruct loss combination arrays.</span>

<span class="sd">        This function converts a nested dictionary of loss combination</span>
<span class="sd">        arrays into a format suitable for further processing. It</span>
<span class="sd">        extracts the array values and the index information from each</span>
<span class="sd">        array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_combination: dict</span>
<span class="sd">           A dictionary where keys are decision variables and values</span>
<span class="sd">           are another dictionary. The inner dictionary has keys as</span>
<span class="sd">           components to combine and values as numpy array</span>
<span class="sd">           objects representing the combination data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with the same structure as the input</span>
<span class="sd">            `loss_combination`.  For each decision variable and</span>
<span class="sd">            component combination, the array is replaced with a</span>
<span class="sd">            tuple containing the combination domain and the combination</span>
<span class="sd">            array itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loss_combination_converted</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">decision_variable</span><span class="p">,</span> <span class="n">combination_data</span> <span class="ow">in</span> <span class="n">loss_combination</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">loss_combination_converted</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">components_to_combine</span><span class="p">,</span>
                <span class="n">combination_array</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">combination_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">combination_index</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">combination_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">combination_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">)</span>
                <span class="n">loss_combination_converted</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">][</span>
                    <span class="n">components_to_combine</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">combination_index</span><span class="p">,</span>
                    <span class="n">combination_array</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_combination_converted</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sum up component losses.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Dataframe with the aggregated losses.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># group results by DV type and location</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
            <span class="c1"># Time</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">decision_variable</span> <span class="o">==</span> <span class="s1">&#39;Time&#39;</span>
                <span class="ow">and</span> <span class="s1">&#39;Time&#39;</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">df_agg</span><span class="p">[</span><span class="s1">&#39;repair_time-sequential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">df_agg</span><span class="p">[</span><span class="s1">&#39;repair_time-parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">decision_variable</span> <span class="o">==</span> <span class="s1">&#39;Time&#39;</span>
                <span class="ow">and</span> <span class="s1">&#39;Time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;repair_time-parallel&#39;</span><span class="p">,</span> <span class="s1">&#39;repair_time-sequential&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="c1"># All other</span>
            <span class="k">elif</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">):</span>
                <span class="n">df_agg</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">decision_variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span>
                    <span class="n">decision_variable</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;repair_</span><span class="si">{</span><span class="n">decision_variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Convert units ..</span>
        <span class="n">column_measures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;repair_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-sequential&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-parallel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">column_units</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dv_units</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">title</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_measures</span><span class="p">]</span>
        <span class="n">dv_units</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">column_units</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_agg</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">save_to_csv</span><span class="p">(</span>
            <span class="n">df_agg</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">dv_units</span><span class="p">,</span>
            <span class="n">unit_conversion_factors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">,</span>
            <span class="n">use_simpleindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">df_agg_mi</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">convert_to_MultiIndex</span><span class="p">(</span><span class="n">df_agg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_agg_mi</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg_mi</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_agg</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_agg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_replacement_thresholds</span><span class="p">(</span>  <span class="c1"># noqa: PLR6301</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">replacement_configuration</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="c1"># If there is no `replacement_configuration`, simply return.</span>
        <span class="k">if</span> <span class="n">replacement_configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># `exceedance_bool_df` is empty in this case.</span>
            <span class="n">exceedance_bool_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sample</span><span class="p">,</span> <span class="n">exceedance_bool_df</span>

        <span class="n">replacement_consequence_rv_reg</span><span class="p">,</span> <span class="n">replacement_ratios</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">replacement_configuration</span>
        <span class="p">)</span>
        <span class="n">exceedance_bool_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Sample replacement consequences from the registry</span>
        <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="s1">&#39;MonteCarlo&#39;</span><span class="p">)</span>

        <span class="n">sample_dvs</span> <span class="o">=</span> <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sample_dv</span> <span class="ow">in</span> <span class="n">sample_dvs</span><span class="p">:</span>
            <span class="n">sub_sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">sample_dv</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;replacement&#39;</span> <span class="ow">in</span> <span class="n">sub_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">):</span>
                <span class="c1"># If `replacement` already exists as a consequence,</span>
                <span class="c1"># determine the realizations where it is non-zero.</span>
                <span class="n">no_replacement_mask</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="o">~</span><span class="p">(</span><span class="n">sub_sample</span><span class="p">[</span><span class="s1">&#39;replacement&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.00</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">no_replacement_columns</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">sub_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;replacement&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise there is no row where we already have replacement</span>
                <span class="n">no_replacement_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_sample</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">no_replacement_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">sub_sample</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="c1"># Get the sum to compare with the thresholds</span>
            <span class="n">consequence_sum_given_no_replacement</span> <span class="o">=</span> <span class="n">sub_sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>  <span class="c1"># type: ignore</span>
                <span class="n">no_replacement_mask</span><span class="p">,</span> <span class="n">no_replacement_columns</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">consequence_sum_given_no_replacement</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">consequence_values</span> <span class="o">=</span> <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">[</span>
                    <span class="n">sample_dv</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sample</span>
                <span class="k">assert</span> <span class="n">consequence_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">exceedance_mask</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">consequence_sum_given_no_replacement</span>
                    <span class="o">&gt;</span> <span class="n">consequence_values</span><span class="p">[</span><span class="n">no_replacement_mask</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">replacement_ratios</span><span class="p">[</span><span class="n">sample_dv</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Fill the remaining rows with False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedance_mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_sample</span><span class="p">):</span>
                    <span class="n">exceedance_mask</span> <span class="o">=</span> <span class="n">exceedance_mask</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span>
                        <span class="n">sub_sample</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exceedance_mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_sample</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">sub_sample</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Monitor triggering of replacement</span>
            <span class="n">exceedance_bool_df</span><span class="p">[</span><span class="n">sample_dv</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedance_mask</span>

        <span class="c1"># Assign replacement consequences where the threshold has been</span>
        <span class="c1"># exceeded.</span>
        <span class="n">exceedance_realizations</span> <span class="o">=</span> <span class="n">exceedance_bool_df</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Assign replacement consequences: needs to include all DVs</span>
        <span class="k">for</span> <span class="n">other_dv</span> <span class="ow">in</span> <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">other_dv</span><span class="p">,</span>
                <span class="s1">&#39;replacement&#39;</span><span class="p">,</span>
                <span class="s1">&#39;threshold_exceedance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;0&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If it doesn&#39;t exist, initialize and set to 0.00</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
                <span class="n">sample</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Assign replacement consequences</span>
            <span class="n">other_sample</span> <span class="o">=</span> <span class="n">replacement_consequence_rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">[</span><span class="n">other_dv</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span>
            <span class="k">assert</span> <span class="n">other_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exceedance_realizations</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_sample</span><span class="p">[</span>
                <span class="n">exceedance_realizations</span>
            <span class="p">]</span>
        <span class="c1"># Remove all other realized consequences from the realizations</span>
        <span class="c1"># where the threshold was exceeded.</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">exceedance_realizations</span><span class="p">,</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;dmg&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;threshold_exceedance&#39;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>

        <span class="k">return</span> <span class="n">sample</span><span class="p">,</span> <span class="n">exceedance_bool_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_replacement_exclusive</span><span class="p">(</span>  <span class="c1"># noqa: PLR6301</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ds_sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lf_sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the replacement consequence exclusive.</span>

<span class="sd">        If `replacement` columns exist in `ds_sample`, this method</span>
<span class="sd">        treats all nonzero loss values driven by `replacement` as</span>
<span class="sd">        exclusive and zeroes-out the loss values of all other columns</span>
<span class="sd">        for the applicable rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># rows where replacement is non-zero</span>
        <span class="n">replacement_rows</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># columns that correspond to the replacement consequence</span>
        <span class="n">replacement_columns</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ds_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;replacement&#39;</span>
        <span class="p">)</span>
        <span class="n">rows_df</span> <span class="o">=</span> <span class="n">ds_sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">replacement_columns</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">replacement_rows</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rows_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="n">ds_sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">replacement_rows</span><span class="p">,</span> <span class="o">~</span><span class="n">replacement_columns</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">lf_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lf_sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">replacement_rows</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.00</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_loss_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">RepairModel_DS</span><span class="p">,</span> <span class="n">RepairModel_LF</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_loss_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the loss map.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The loss map.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve the DataFrame from one of the included loss models.</span>
        <span class="c1"># We use a single loss map for all.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">loss_map</span>

    <span class="nd">@_loss_map</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_loss_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_map</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the loss map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_map: pd.DataFrame</span>
<span class="sd">            The loss map.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add the DataFrame to the included loss models.</span>
        <span class="c1"># We use a single loss map for all.</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">loss_map</span> <span class="o">=</span> <span class="n">loss_map</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the missing components.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        set</span>
<span class="sd">            Set containing tuples identifying missing loss parameter</span>
<span class="sd">            definitions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="o">.</span><span class="n">missing</span>

    <span class="nd">@_missing</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">missing</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign missing parameter definitions to the loss models.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        missing: set</span>
<span class="sd">            Set containing tuples identifying missing loss parameter</span>
<span class="sd">            definitions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="n">missing</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_loss_parameter_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure that all components have loss parameters.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Repair Models (currently the only type supported)</span>
        <span class="c1">#</span>

        <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
            <span class="n">required</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">component</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_map</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="n">missing_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lf_model</span><span class="p">):</span>
            <span class="n">missing_set</span> <span class="o">-=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_available</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">missing_set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The loss model does not provide &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;loss information for the following component(s) &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;in the asset model: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing_set</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_missing</span> <span class="o">=</span> <span class="n">missing_set</span></div>



<div class="viewcode-block" id="RepairModel_Base">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_Base">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RepairModel_Base</span><span class="p">(</span><span class="n">PelicunModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for loss models.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;consequence&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decision_variables&#39;</span><span class="p">,</span>
        <span class="s1">&#39;loss_map&#39;</span><span class="p">,</span>
        <span class="s1">&#39;loss_params&#39;</span><span class="p">,</span>
        <span class="s1">&#39;missing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sample&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assessment</span><span class="p">:</span> <span class="n">AssessmentBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize RepairModel_Base objects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        assessment: pelicun.AssessmentBase</span>
<span class="sd">            Parent assessment</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">assessment</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consequence</span> <span class="o">=</span> <span class="s1">&#39;Repair&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="RepairModel_Base.load_model_parameters">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_Base.load_model_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load model parameters from a DataFrame.</span>

<span class="sd">        Extends those already available. Parameters already defined</span>
<span class="sd">        take precedence, i.e. redefinitions of parameters are ignored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: DataFrame</span>
<span class="sd">            Data with loss model information.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Loss Driver&#39;</span><span class="p">,</span> <span class="s1">&#39;Decision Variable&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># drop redefinitions of components</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># note: .groupby introduces None entries. We replace them with</span>
        <span class="c1"># NaN for consistency.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="o">=</span> <span class="n">data</span></div>


<div class="viewcode-block" id="RepairModel_Base.drop_unused_loss_parameters">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_Base.drop_unused_loss_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_unused_loss_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_map</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove loss parameter definitions.</span>

<span class="sd">        Applicable to component IDs not present in the loss map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_map: str or pd.DataFrame or None</span>
<span class="sd">            Path to a csv file or DataFrame object that maps</span>
<span class="sd">            components IDs to their loss parameter definitions.</span>
<span class="sd">            Components in the asset model that are omitted from the</span>
<span class="sd">            provided loss map are mapped to the same ID.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># &lt;backwards compatibility&gt;</span>
        <span class="k">if</span> <span class="s1">&#39;BldgRepair&#39;</span> <span class="ow">in</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;BldgRepair&#39;</span><span class="p">]</span>
            <span class="n">loss_map</span> <span class="o">=</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;BldgRepair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;`BldgRepair` as a loss map column name is &#39;</span>
                <span class="s1">&#39;deprecated and will be dropped in &#39;</span>
                <span class="s1">&#39;future versions of pelicun. Please use `Repair` instead.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># get a list of unique component IDs</span>
        <span class="n">cmp_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="n">cmp_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cmp_set</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">cmp_mask</span><span class="p">,</span> <span class="p">:]</span></div>


<div class="viewcode-block" id="RepairModel_Base.remove_incomplete_components">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_Base.remove_incomplete_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_incomplete_components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove incomplete components.</span>

<span class="sd">        Removes components that have incomplete loss model</span>
<span class="sd">        definitions from the loss model parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Incomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cmp_incomplete_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;Incomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cmp_incomplete_idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmp_incomplete_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;WARNING: Loss model information is incomplete for &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;the following component(s) &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmp_incomplete_idx</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="si">}</span><span class="s1">. They &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;were removed from the analysis.&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="RepairModel_Base.get_available">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_Base.get_available">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a set of components with available loss parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        set</span>
<span class="sd">            Set of components with available loss parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">cmp_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="RepairModel_Base.convert_loss_parameter_units">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_Base.convert_loss_parameter_units">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_loss_parameter_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert previously loaded loss parameters to base units.&quot;&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="RepairModel_DS">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_DS">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RepairModel_DS</span><span class="p">(</span><span class="n">RepairModel_Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repair consequences for components with damage states.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RV_reg&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="RepairModel_DS.save_sample">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_DS.save_sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_units</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save or return the loss sample.</span>

<span class="sd">        This method handles the storage of a sample of loss estimates,</span>
<span class="sd">        which can either be saved directly to a file or returned as a</span>
<span class="sd">        DataFrame for further manipulation. When saving to a file,</span>
<span class="sd">        additional information such as unit conversion factors and</span>
<span class="sd">        column units can be included. If the data is not being saved</span>
<span class="sd">        to a file, the method can return the DataFrame with or without</span>
<span class="sd">        units as specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str, optional</span>
<span class="sd">            The path to the file where the loss sample should be</span>
<span class="sd">            saved. If not provided, the sample is not saved to disk</span>
<span class="sd">            but returned.</span>
<span class="sd">        save_units: bool, default: False</span>
<span class="sd">            Indicates whether to include a row with unit information</span>
<span class="sd">            in the returned DataFrame. This parameter is ignored if a</span>
<span class="sd">            file path is provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None or tuple</span>
<span class="sd">            If `filepath` is provided, the function returns None after</span>
<span class="sd">            saving the data.</span>
<span class="sd">            If no `filepath` is specified, returns:</span>
<span class="sd">            * DataFrame containing the loss sample.</span>
<span class="sd">            * Optionally, a Series containing the units for each</span>
<span class="sd">            column if `save_units` is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">div</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Saving loss sample...&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">cmp_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">dv_units</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="n">valid_dv_types</span> <span class="o">=</span> <span class="n">dv_units</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_cmp_ids</span> <span class="o">=</span> <span class="n">dv_units</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmp_id</span><span class="p">,</span> <span class="n">dv_type</span> <span class="ow">in</span> <span class="n">cmp_units</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dv_type</span> <span class="ow">in</span> <span class="n">valid_dv_types</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cmp_id</span> <span class="ow">in</span> <span class="n">valid_cmp_ids</span><span class="p">):</span>
                <span class="n">dv_units</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dv_type</span><span class="p">,</span> <span class="n">cmp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmp_units</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cmp_id</span><span class="p">,</span> <span class="n">dv_type</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">save_to_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">dv_units</span><span class="p">,</span>
            <span class="n">unit_conversion_factors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">,</span>
            <span class="n">use_simpleindex</span><span class="o">=</span><span class="p">(</span><span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loss sample successfully saved.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_units</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">units</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="RepairModel_DS.load_sample">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_DS.load_sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load loss sample data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">          Path to an existing sample stored in a file, or dataframe</span>
<span class="sd">          containing the existing sample.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict[str, str]</span>
<span class="sd">          Dictionary mapping each decision variable to its assigned</span>
<span class="sd">          unit.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">          If the columns have an invalid number of levels.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">div</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loading loss sample...&#39;</span><span class="p">)</span>

        <span class="n">sample</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
            <span class="n">return_units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="n">units</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="c1"># Obtain the DV units</span>
        <span class="c1"># Note: we don&#39;t need to check for consistency (all rows</span>
        <span class="c1"># having the same unit) since the units are extracted from a</span>
        <span class="c1"># single row in the CSV, affecting all subsequent rows.</span>
        <span class="n">units_isolated</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">units</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;dv&#39;</span><span class="p">)[</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dv_units</span> <span class="o">=</span> <span class="n">units_isolated</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># check if `uid` level was provided</span>
        <span class="n">num_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">num_levels_without_uid</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">num_levels_with_uid</span> <span class="o">=</span> <span class="n">num_levels_without_uid</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_levels</span> <span class="o">==</span> <span class="n">num_levels_without_uid</span><span class="p">:</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">dedupe_index</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="n">num_levels</span> <span class="o">==</span> <span class="n">num_levels_with_uid</span><span class="p">:</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Invalid loss sample: Column MultiIndex &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;has an unexpected length: </span><span class="si">{</span><span class="n">num_levels</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Loss sample successfully loaded.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dv_units</span></div>


<div class="viewcode-block" id="RepairModel_DS.calculate">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_DS.calculate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmg_quantities</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate damage consequences.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dmg_quantities: DataFrame</span>
<span class="sd">            A table with the quantity of damage experienced in each</span>
<span class="sd">            damage state of each performance group at each location</span>
<span class="sd">            and direction. You can use the prepare_dmg_quantities</span>
<span class="sd">            method in the DamageModel to get such a DF.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmg_quantities</span><span class="p">)</span>

        <span class="c1"># If everything is undamaged there are no losses</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">dmg_quantities</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;ds&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s1">&#39;There is no damage---DV sample is set to None.&#39;</span><span class="p">,</span>
                <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># calculate the quantities for economies of scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aggregating damage quantities...&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossFloors&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossDamageStates&#39;</span><span class="p">]:</span>
                <span class="n">eco_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eco_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">eco_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
                <span class="n">eco_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossDamageStates&#39;</span><span class="p">]:</span>
            <span class="n">eco_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">eco_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">eco_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
            <span class="n">eco_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">]</span>

        <span class="n">eco_group</span> <span class="o">=</span> <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">eco_levels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">eco_qnt</span> <span class="o">=</span> <span class="n">eco_group</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">eco_group</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">==</span> <span class="n">eco_columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Successfully aggregated damage quantities.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># apply the median functions, if needed, to get median consequences for</span>
        <span class="c1"># each realization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating the median repair consequences...&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">medians</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_median_consequence</span><span class="p">(</span><span class="n">eco_qnt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Successfully determined median repair consequences.&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># combine the median consequences with the samples of deviation from the</span>
        <span class="c1"># median to get the consequence realizations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Considering deviations from the median values to obtain &#39;</span>
            <span class="s1">&#39;random DV sample...&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Preparing random variables for repair consequences...&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RV_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_DV_RVs</span><span class="p">(</span><span class="n">dmg_quantities</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RV_reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sampling_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RV_reg</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">(</span>
                <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sampling_method</span>
            <span class="p">)</span>

            <span class="n">std_sample</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">convert_to_MultiIndex</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RV_reg</span><span class="o">.</span><span class="n">RV_sample</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">std_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
            <span class="n">std_sample</span> <span class="o">=</span> <span class="n">std_sample</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">std_sample</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Successfully generated </span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s1"> realizations of &#39;</span>
            <span class="s1">&#39;deviation from the median consequences.&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dmg_quantities</span> <span class="o">=</span> <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">std_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">std_dvs</span> <span class="o">=</span> <span class="n">std_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">std_dvs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>  <span class="c1"># noqa: PLR1702</span>
            <span class="k">if</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="n">std_dvs</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
                <span class="n">prob_cmp_list</span> <span class="o">=</span> <span class="n">std_sample</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prob_cmp_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">cmp_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">decision_variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">medians</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">medians</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="c1"># check if there is damage in the component</span>
                <span class="n">consequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">component</span><span class="p">,</span> <span class="s1">&#39;Repair&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cmp&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">medians</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">component</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">loc_list</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">loc_id</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                        <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">:,</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossFloors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
                        <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">loc_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">break</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossFloors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">median_i</span> <span class="o">=</span> <span class="n">medians</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="p">:,</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
                            <span class="p">]</span>
                            <span class="n">dmg_i</span> <span class="o">=</span> <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="p">:,</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                            <span class="p">]</span>

                            <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">prob_cmp_list</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="n">std_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="n">std_i</span> <span class="o">=</span> <span class="n">std_sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                    <span class="p">:,</span>
                                    <span class="p">(</span>
                                        <span class="n">decision_variable</span><span class="p">,</span>
                                        <span class="n">component</span><span class="p">,</span>
                                        <span class="n">ds</span><span class="p">,</span>
                                    <span class="p">),</span>  <span class="c1"># type: ignore</span>
                                <span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">std_i</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">median_i</span> <span class="o">=</span> <span class="n">medians</span><span class="p">[</span><span class="n">decision_variable</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="p">:,</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                            <span class="p">]</span>
                            <span class="n">dmg_i</span> <span class="o">=</span> <span class="n">dmg_quantities</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="p">:,</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                            <span class="p">]</span>

                            <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">prob_cmp_list</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="n">std_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="n">std_i</span> <span class="o">=</span> <span class="n">std_sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                    <span class="p">:,</span>
                                    <span class="p">(</span>
                                        <span class="n">decision_variable</span><span class="p">,</span>
                                        <span class="n">component</span><span class="p">,</span>
                                        <span class="n">ds</span><span class="p">,</span>
                                        <span class="n">loc</span><span class="p">,</span>
                                    <span class="p">),</span>  <span class="c1"># type: ignore</span>
                                <span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">std_i</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">std_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dmg_i</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">median_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_i</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dmg_i</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">median_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

                        <span class="n">loc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossFloors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">ds_list</span> <span class="o">+=</span> <span class="p">[</span>
                            <span class="n">ds</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ds_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">ds</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">loc_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossFloors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cmp_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ds_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmp_list</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">ds_list</span>
                    <span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">eco_scale</span><span class="p">[</span><span class="s1">&#39;AcrossFloors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">decision_variable</span><span class="p">,</span> <span class="n">loss_cmp_i</span><span class="p">,</span> <span class="n">dmg_cmp_i</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">loss_cmp_i</span><span class="p">,</span> <span class="n">dmg_cmp_i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">cmp_list</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">decision_variable</span><span class="p">,</span> <span class="n">loss_cmp_i</span><span class="p">,</span> <span class="n">dmg_cmp_i</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">loss_cmp_i</span><span class="p">,</span> <span class="n">dmg_cmp_i</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">cmp_list</span>
                <span class="p">]</span>

        <span class="n">lvl_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="n">dv_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">res_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">key_list</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">lvl_names</span><span class="p">)</span>

        <span class="n">dv_sample</span> <span class="o">=</span> <span class="n">dv_sample</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Successfully obtained DV sample.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">dv_sample</span></div>


<div class="viewcode-block" id="RepairModel_DS.convert_loss_parameter_units">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_DS.convert_loss_parameter_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_loss_parameter_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert previously loaded loss parameters to base units.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
        <span class="n">arg_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DS&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_marginal_params</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">arg_units</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>


<div class="viewcode-block" id="RepairModel_DS.drop_unused_damage_states">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_DS.drop_unused_damage_states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_unused_damage_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove unused columns.</span>

<span class="sd">        Remove columns from the loss model parameters corresponding</span>
<span class="sd">        to unused damage states.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">first_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">first_level</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DS&#39;</span><span class="p">)]</span>
        <span class="n">ds_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">damage_state</span> <span class="ow">in</span> <span class="n">ds_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">:,</span>  <span class="c1"># type: ignore</span>
                            <span class="n">idx</span><span class="p">[</span><span class="n">damage_state</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Note: When this evaluates to True, when you add `is</span>
                <span class="c1"># True` on the right it suddenly evaluates to</span>
                <span class="c1"># False. We need to figure out why this is happening,</span>
                <span class="c1"># but the way it&#39;s written now does what we want in</span>
                <span class="c1"># each case.</span>
            <span class="p">):</span>
                <span class="n">ds_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">damage_state</span><span class="p">)</span>  <span class="c1"># noqa: PERF401</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ds_to_drop</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_DV_RVs</span><span class="p">(</span>  <span class="c1"># noqa: N802, C901</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cases</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the random variables.</span>

<span class="sd">        Prepare the random variables associated with decision</span>
<span class="sd">        variables, such as repair cost and time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cases: MultiIndex</span>
<span class="sd">            Index with cmp-loc-uid-dir-ds descriptions that identify</span>
<span class="sd">            the RVs we need for the simulation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RandomVariableRegistry or None</span>
<span class="sd">            A RandomVariableRegistry containing all the generated</span>
<span class="sd">            random variables necessary for the simulation. If no</span>
<span class="sd">            random variables are generated (due to missing parameters</span>
<span class="sd">            or conditions), returns None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert the MultiIndex to a DataFrame</span>
        <span class="n">case_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># maps `cmp` to array of damage states</span>
        <span class="n">damage_states</span> <span class="o">=</span> <span class="n">case_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cmp&#39;</span><span class="p">)[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># maps `cmp`-`ds` to tuple of `loc`-`dir`-`uid` tuples</span>
        <span class="n">loc_dir_uids</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">case_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span>
                        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">],</span>
                        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">damaged_components</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cases</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cmp&#39;</span><span class="p">))</span>

        <span class="n">rv_reg</span> <span class="o">=</span> <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>

        <span class="n">rv_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># for each component in the loss map</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">consequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># if that component does not have realized damage states,</span>
            <span class="c1"># skip it (e.g., this can happen when there is only</span>
            <span class="c1"># `collapse`).</span>
            <span class="k">if</span> <span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">damaged_components</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># for each DV</span>
            <span class="k">for</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
                <span class="c1"># If loss parameters are missing for that consequence,</span>
                <span class="c1"># don&#39;t estimate losses for it. A warning has already</span>
                <span class="c1"># been issued for what is missing.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># If loss parameters are missing for that consequence,</span>
                <span class="c1"># for this particular loss model, they will exist in</span>
                <span class="c1"># the other(s).</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># load the corresponding parameters</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span> <span class="p">:]</span>
                    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">damage_states</span><span class="p">[</span><span class="n">component</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ds</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">ds_family</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;DS</span><span class="si">{</span><span class="n">ds</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">))</span>
                    <span class="n">ds_theta</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">theta</span>
                        <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">theta</span> <span class="o">:=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;DS</span><span class="si">{</span><span class="n">ds</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Theta_</span><span class="si">{</span><span class="n">t_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)))</span>
                        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">]</span>
                    <span class="c1"># If there is no RV family we don&#39;t need an RV</span>
                    <span class="k">if</span> <span class="n">ds_family</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># If the first parameter is controlled by a function, we use</span>
                    <span class="c1"># 1.0 in its place and will scale the results in a later</span>
                    <span class="c1"># step</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds_theta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">ds_theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ds_theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="n">loc_dir_uid</span> <span class="o">=</span> <span class="n">loc_dir_uids</span><span class="p">[</span><span class="n">component</span><span class="p">,</span> <span class="n">ds</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">loc_dir_uid</span><span class="p">:</span>
                        <span class="c1"># assign RVs</span>
                        <span class="n">rv_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span>
                            <span class="n">uq</span><span class="o">.</span><span class="n">rv_class_map</span><span class="p">(</span><span class="n">ds_family</span><span class="p">)(</span>  <span class="c1"># type: ignore</span>
                                <span class="n">name</span><span class="o">=</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">decision_variable</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1">-&#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ds</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="p">),</span>
                                <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds_theta</span><span class="p">),</span>
                                <span class="n">truncation_limits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">rv_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># assign Time-Cost correlation whenever applicable</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rho_cost_time</span>
        <span class="k">if</span> <span class="n">rho</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rv_tag</span> <span class="ow">in</span> <span class="n">rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">time_rv_tag</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">time_rv_tag</span> <span class="ow">in</span> <span class="n">rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
                    <span class="n">rv_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span>
                        <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;DV-</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ds</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">_set&#39;</span><span class="p">,</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">rv_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">([</span><span class="n">rv_tag</span><span class="p">,</span> <span class="n">time_rv_tag</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span> <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">rv_count</span><span class="si">}</span><span class="s1"> random variables created.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">rv_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv_reg</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_median_consequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eco_qnt</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate median reiapr consequences.</span>

<span class="sd">        Calculate the median repair consequences for each loss</span>
<span class="sd">        component based on its quantity realizations and the</span>
<span class="sd">        associated loss parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eco_qnt: DataFrame</span>
<span class="sd">            A DataFrame containing quantity realizations for various</span>
<span class="sd">            components and damage states, appropriately grouped to</span>
<span class="sd">            account for economies of scale.</span>

<span class="sd">        decision_variables: list</span>
<span class="sd">            Defines the decision variables to be included in the loss</span>
<span class="sd">            calculations. Defaults to those supported, but fewer can be</span>
<span class="sd">            used if desired. When fewer are used, the loss parameters for</span>
<span class="sd">            those not used will not be required.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary where keys are the types of decision</span>
<span class="sd">            variables (DV) like &#39;COST&#39; or &#39;TIME&#39;, and values are</span>
<span class="sd">            DataFrames containing the median consequences for each</span>
<span class="sd">            component and damage state. These DataFrames are structured</span>
<span class="sd">            with MultiIndex columns that may include &#39;cmp&#39; (component),</span>
<span class="sd">            &#39;ds&#39; (damage state), and potentially &#39;loc&#39; (location),</span>
<span class="sd">            depending on the way economies of scale are handled.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any loss driver types or distribution types are not</span>
<span class="sd">            recognized, or if the parameters are incomplete or</span>
<span class="sd">            unsupported.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">medians</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
            <span class="n">cmp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">median_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">loss_cmp_id</span><span class="p">,</span> <span class="n">loss_cmp_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">loss_cmp_name</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">loss_cmp_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="k">continue</span>

                <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sub_medians</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DS&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">ds_id</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                    <span class="k">if</span> <span class="n">ds_id</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">loss_params_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">loss_cmp_name</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span> <span class="n">ds</span>
                    <span class="p">]</span>

                    <span class="c1"># check if theta_0 is defined</span>
                    <span class="n">theta_0</span> <span class="o">=</span> <span class="n">loss_params_ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Theta_0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">theta_0</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># check if the distribution type is supported</span>
                    <span class="n">family</span> <span class="o">=</span> <span class="n">loss_params_ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Family&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">family</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">family</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">,</span> <span class="s1">&#39;deterministic&#39;</span><span class="p">}</span>
                    <span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;Loss Distribution of type </span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="sa">f</span><span class="s1">&#39;not supported.&#39;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># If theta_0 is a scalar</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">theta_0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta_0</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">loss_params_ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Family&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)):</span>
                            <span class="c1"># if theta_0 is constant, then use it directly</span>
                            <span class="n">f_median</span> <span class="o">=</span> <span class="n">_prep_constant_median_DV</span><span class="p">(</span><span class="n">theta_0</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># otherwise use a constant 1.0 as the median</span>
                            <span class="c1"># The random variable will be generated as a</span>
                            <span class="c1"># variation from this 1.0 and added in a later step.</span>
                            <span class="n">f_median</span> <span class="o">=</span> <span class="n">_prep_constant_median_DV</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># otherwise, use the multilinear function</span>
                        <span class="n">all_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">theta_0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)],</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">medns</span> <span class="o">=</span> <span class="n">all_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">qnts</span> <span class="o">=</span> <span class="n">all_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">f_median</span> <span class="o">=</span> <span class="n">_prep_bounded_multilinear_median_DV</span><span class="p">(</span><span class="n">medns</span><span class="p">,</span> <span class="n">qnts</span><span class="p">)</span>

                    <span class="c1"># get the corresponding aggregate damage quantities</span>
                    <span class="c1"># to consider economies of scale</span>
                    <span class="k">if</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                        <span class="n">avail_ds</span> <span class="o">=</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">:,</span>  <span class="c1"># type: ignore</span>
                            <span class="n">loss_cmp_id</span><span class="p">,</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avail_ds</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">eco_qnt_i</span> <span class="o">=</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">:,</span>  <span class="c1"># type: ignore</span>
                            <span class="p">(</span><span class="n">loss_cmp_id</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">),</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">eco_qnt_i</span> <span class="o">=</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">:,</span>  <span class="c1"># type: ignore</span>
                            <span class="n">loss_cmp_id</span><span class="p">,</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eco_qnt_i</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                        <span class="n">eco_qnt_i</span> <span class="o">=</span> <span class="n">eco_qnt_i</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
                        <span class="n">eco_qnt_i</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
                        <span class="n">eco_qnt_i</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;del&#39;</span>

                    <span class="c1"># generate the median values for each realization</span>
                    <span class="n">eco_qnt_i</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f_median</span><span class="p">(</span><span class="n">eco_qnt_i</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

                    <span class="n">sub_medians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eco_qnt_i</span><span class="p">)</span>
                    <span class="n">ds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># combine medians across damage states into one DF</span>
                    <span class="n">median_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sub_medians</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">ds_list</span><span class="p">))</span>
                    <span class="n">cmp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_cmp_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmp_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># combine medians across components into one DF</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">median_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">cmp_list</span><span class="p">)</span>

                <span class="c1"># remove the extra column header level</span>
                <span class="k">if</span> <span class="s1">&#39;del&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">)</span>

                <span class="c1"># name the remaining column header levels</span>
                <span class="k">if</span> <span class="n">eco_qnt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">]</span>

                <span class="c1"># save the results to the returned dictionary</span>
                <span class="n">medians</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">decision_variable</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">medians</span></div>



<div class="viewcode-block" id="RepairModel_LF">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_LF">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RepairModel_LF</span><span class="p">(</span><span class="n">RepairModel_Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repair consequences for components with loss functions.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RepairModel_LF.calculate">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_LF.calculate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">demand_sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cmp_sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">cmp_marginal_params</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">demand_offset</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">nondirectional_multipliers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate repair consequences.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        demand_sample: pd.DataFrame</span>
<span class="sd">            The sample of the demand model to be used for the inputs</span>
<span class="sd">            of the loss functions.</span>
<span class="sd">        cmp_sample: dict</span>
<span class="sd">            Dict mapping each `cmp`-`loc`-`dir`-`uid` to the component</span>
<span class="sd">            quantity realizations in the asset model in the form of</span>
<span class="sd">            pd.Series objects.</span>
<span class="sd">        cmp_marginal_params: pd.DataFrame</span>
<span class="sd">            Dataframe containing component marginal distribution</span>
<span class="sd">            parameters.</span>
<span class="sd">        demand_offset: dict</span>
<span class="sd">            Dictionary specifying the demand offset.</span>
<span class="sd">        nondirectional_multipliers: dict</span>
<span class="sd">            Dictionary specifying the non directional multipliers used</span>
<span class="sd">            to combine the directional demands.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">loss_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand_sample</span><span class="p">)</span>

        <span class="c1"># TODO(JVM): this can be taken out and simply passed as blocks in</span>
        <span class="c1"># the arguments, and cast to a dict in here. Index can be</span>
        <span class="c1"># obtained from there.</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cmp_marginal_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">index</span>
        <span class="p">]</span>
        <span class="c1"># If `Blocks` information is unspecified add one block per</span>
        <span class="c1"># component.</span>
        <span class="k">if</span> <span class="s1">&#39;Blocks&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmp_marginal_params</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cmp_marginal_params</span><span class="p">[</span><span class="s1">&#39;Blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">cmp_marginal_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Blocks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">performance_group_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span> <span class="n">num_blocks</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">decision_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">performance_group_dict</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span> <span class="n">location</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">uid</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">num_blocks</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">performance_group_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s1">&#39;No loss function-driven components---LF sample is set to None.&#39;</span><span class="p">,</span>
                <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">performance_group</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">performance_group_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">performance_group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Blocks&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">performance_group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>

        <span class="n">required_edps</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">invert_mapping</span><span class="p">(</span>
            <span class="n">_get_required_demand_type</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">,</span> <span class="n">performance_group</span><span class="p">,</span> <span class="n">demand_offset</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">available_edps</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">demand_sample</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">])[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Raise an error if demand sample is missing necessary entries.</span>
        <span class="n">_verify_edps_available</span><span class="p">(</span><span class="n">available_edps</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_edps</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="n">demand_dict</span> <span class="o">=</span> <span class="n">_assemble_required_demand_data</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">required_edps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">nondirectional_multipliers</span><span class="p">,</span>
            <span class="n">demand_sample</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating the median repair consequences...&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">medians</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_median_consequence</span><span class="p">(</span>
            <span class="n">performance_group</span><span class="p">,</span> <span class="n">loss_map</span><span class="p">,</span> <span class="n">required_edps</span><span class="p">,</span> <span class="n">demand_dict</span><span class="p">,</span> <span class="n">cmp_sample</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Successfully determined median repair consequences.&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Considering deviations from the median values to obtain &#39;</span>
            <span class="s1">&#39;random DV sample...&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s1">&#39;Preparing random variables for repair cost and time...&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">rv_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_DV_RVs</span><span class="p">(</span><span class="n">medians</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">rv_reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sampling_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">rv_reg</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">(</span>
                <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sampling_method</span>
            <span class="p">)</span>

            <span class="n">std_sample</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">convert_to_MultiIndex</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rv_reg</span><span class="o">.</span><span class="n">RV_sample</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">std_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;dv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;loss&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dmg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;loc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;uid&#39;</span><span class="p">,</span>
                <span class="s1">&#39;block&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">std_sample</span> <span class="o">=</span> <span class="n">std_sample</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="n">medians</span> <span class="o">*</span> <span class="n">std_sample</span><span class="p">)</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">medians</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">medians</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Successfully generated </span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s1"> realizations of &#39;</span>
            <span class="s1">&#39;deviation from the median consequences.&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># sum up the block losses</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Successfully obtained DV sample.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="RepairModel_LF.convert_loss_parameter_units">
<a class="viewcode-back" href="../../../api_reference/_autosummary/pelicun.model.loss_model.html#pelicun.model.loss_model.RepairModel_LF.convert_loss_parameter_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_loss_parameter_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert previously loaded loss parameters to base units.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
        <span class="n">arg_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">]</span>
        <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;LossFunction&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_marginal_params</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">units</span><span class="p">,</span>
            <span class="n">arg_units</span><span class="p">,</span>
            <span class="n">divide_units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_median_consequence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">performance_group</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">loss_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">required_edps</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">demand_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">cmp_sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate median repair consequences.</span>

<span class="sd">        Calculates the median repair consequences for each loss</span>
<span class="sd">        function-driven component based on its quantity realizations</span>
<span class="sd">        and the associated loss parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        performance_group: pd.DataFrame</span>
<span class="sd">            Dataframe with a single column `Blocks` containing an</span>
<span class="sd">            integer for the number of blocks of each</span>
<span class="sd">            (`cmp`-`decision_variable`)-`loc`-`dir`-`uid`.</span>
<span class="sd">        loss_map: dict</span>
<span class="sd">            Dictionary mpping component IDs, `cmp`, to their repair</span>
<span class="sd">            consequences.</span>
<span class="sd">        required_edps: dict</span>
<span class="sd">            Dictionary mapping (`cmp`-`realization`)-`loc`-`dir`-`uid`</span>
<span class="sd">            (each entry of the `performance_group`&#39;s index) with the</span>
<span class="sd">            EDP name (e.g., `PFA-1-1`) that should be used as its loss</span>
<span class="sd">            function input.</span>
<span class="sd">        demand_dict: dict</span>
<span class="sd">            Dictionary mapping each EDP name to the values in the</span>
<span class="sd">            demand sample in the form of numpy arrays.</span>
<span class="sd">        cmp_sample: dict</span>
<span class="sd">            Dict mapping each `cmp`-`loc`-`dir`-`uid` to the component</span>
<span class="sd">            quantity realizations in the asset model in the form of</span>
<span class="sd">            pd.Series objects.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Dataframe with medial loss for loss-function driven</span>
<span class="sd">            components.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If loss function interpolation fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">medians_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># for each component in the asset model</span>
        <span class="n">component</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">decision_variable</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">location</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">uid</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">blocks</span><span class="p">:</span> <span class="nb">int</span>
        <span class="k">for</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span>
            <span class="n">location</span><span class="p">,</span>
            <span class="n">direction</span><span class="p">,</span>
            <span class="n">uid</span><span class="p">,</span>
        <span class="p">),</span> <span class="n">blocks</span> <span class="ow">in</span> <span class="n">performance_group</span><span class="p">[</span><span class="s1">&#39;Blocks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">consequence</span> <span class="o">=</span> <span class="n">loss_map</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>
            <span class="n">edp</span> <span class="o">=</span> <span class="n">required_edps</span><span class="p">[</span>
                <span class="p">(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span> <span class="n">location</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">uid</span>
            <span class="p">]</span>
            <span class="n">edp_values</span> <span class="o">=</span> <span class="n">demand_dict</span><span class="p">[</span><span class="n">edp</span><span class="p">]</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">loss_function_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;LossFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss_function_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">median_loss</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">stringterpolation</span><span class="p">(</span><span class="n">loss_function_str</span><span class="p">)(</span><span class="n">edp_values</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Loss function interpolation for consequence &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">consequence</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">decision_variable</span><span class="si">}</span><span class="s1">` has failed. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Ensure a sufficient interpolation domain  &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;for the X values (those after the `|` symbol)  &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;and verify the X-value and Y-value lengths match.&#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
                <span class="n">medians_dict</span><span class="p">[</span>
                    <span class="n">decision_variable</span><span class="p">,</span>
                    <span class="n">consequence</span><span class="p">,</span>
                    <span class="n">component</span><span class="p">,</span>
                    <span class="n">location</span><span class="p">,</span>
                    <span class="n">direction</span><span class="p">,</span>
                    <span class="n">uid</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="p">),</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">median_loss</span>
                    <span class="o">*</span> <span class="n">cmp_sample</span><span class="p">[</span><span class="n">component</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">medians</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">medians_dict</span><span class="p">)</span>
        <span class="n">medians</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;dmg&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">medians</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_DV_RVs</span><span class="p">(</span>  <span class="c1"># noqa: N802</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cases</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the decision variable random variables.</span>

<span class="sd">        Prepares the random variables associated with decision</span>
<span class="sd">        variables, such as repair cost and time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cases: MultiIndex</span>
<span class="sd">            Index with `dv`-`loss`-`dmg`-`loc`-`dir`-`uid`</span>
<span class="sd">            entries that identify the RVs we need for the</span>
<span class="sd">            simulation (columns of the `medians` dataframe).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RandomVariableRegistry or None</span>
<span class="sd">            A RandomVariableRegistry containing all the generated</span>
<span class="sd">            random variables necessary for the simulation. If no</span>
<span class="sd">            random variables are generated (due to missing parameters</span>
<span class="sd">            or conditions), returns None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rv_reg</span> <span class="o">=</span> <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>

        <span class="n">rv_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># for each component in the loss map</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">decision_variable</span><span class="p">,</span>
            <span class="n">consequence</span><span class="p">,</span>
            <span class="n">component</span><span class="p">,</span>
            <span class="n">location</span><span class="p">,</span>
            <span class="n">direction</span><span class="p">,</span>
            <span class="n">uid</span><span class="p">,</span>
            <span class="n">block</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
            <span class="c1"># load the corresponding parameters</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">consequence</span><span class="p">,</span> <span class="n">decision_variable</span><span class="p">),</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LossFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="c1"># Everything is deterministic, no need to create RVs.</span>
                <span class="k">continue</span>
            <span class="n">family</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;LossFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">]</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">theta_value</span>
                <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">theta_value</span> <span class="o">:=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;LossFunction&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Theta_</span><span class="si">{</span><span class="n">t_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)))</span>
                <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">]</span>
            <span class="c1"># If there is no RV family we don&#39;t need an RV</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">family</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Since the first parameter is controlled by a function,</span>
            <span class="c1"># we use 1.0 in its place and will scale the results in a</span>
            <span class="c1"># later step.</span>
            <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># type: ignore</span>

            <span class="c1"># assign RVs</span>
            <span class="n">rv_reg</span><span class="o">.</span><span class="n">add_RV</span><span class="p">(</span>
                <span class="n">uq</span><span class="o">.</span><span class="n">rv_class_map</span><span class="p">(</span><span class="n">family</span><span class="p">)(</span>  <span class="c1"># type: ignore</span>
                    <span class="n">name</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">decision_variable</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">consequence</span><span class="si">}</span><span class="s1">-&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">),</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                    <span class="n">truncation_limits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">rv_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># assign Time-Cost correlation whenever applicable</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asmnt</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rho_cost_time</span>
        <span class="k">if</span> <span class="n">rho</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rv_tag</span> <span class="ow">in</span> <span class="n">rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">consequence</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">time_rv_tag</span> <span class="o">=</span> <span class="n">rv_tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">time_rv_tag</span> <span class="ow">in</span> <span class="n">rv_reg</span><span class="o">.</span><span class="n">RV</span><span class="p">:</span>
                    <span class="n">rv_reg</span><span class="o">.</span><span class="n">add_RV_set</span><span class="p">(</span>
                        <span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableSet</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;DV-</span><span class="si">{</span><span class="n">consequence</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1">-&#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s1">_set&#39;</span>
                            <span class="p">),</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">rv_reg</span><span class="o">.</span><span class="n">RVs</span><span class="p">([</span><span class="n">rv_tag</span><span class="p">,</span> <span class="n">time_rv_tag</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span> <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">rv_count</span><span class="si">}</span><span class="s1"> random variables created.&#39;</span><span class="p">,</span> <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">rv_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv_reg</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_prep_constant_median_DV</span><span class="p">(</span><span class="n">median</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>  <span class="c1"># noqa: N802</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a constant median Decision Variable (DV) function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    median: float</span>
<span class="sd">        The median DV for a consequence function with fixed median.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">        A function that returns the constant median DV for all component</span>
<span class="sd">        quantities.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># noqa: ANN002, ANN202, ARG001</span>
        <span class="k">return</span> <span class="n">median</span>

    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prep_bounded_multilinear_median_DV</span><span class="p">(</span>  <span class="c1"># noqa: N802</span>
    <span class="n">medians</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">quantities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a bounded multilinear median Decision Variable (DV) function.</span>

<span class="sd">    The median DV equals the min and max values when the quantity is</span>
<span class="sd">    outside of the prescribed quantity bounds. When the quantity is within the</span>
<span class="sd">    bounds, the returned median is calculated by linear interpolation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    medians: ndarray</span>
<span class="sd">        Series of values that define the y coordinates of the multilinear DV</span>
<span class="sd">        function.</span>
<span class="sd">    quantities: ndarray</span>
<span class="sd">        Series of values that define the component quantities corresponding to</span>
<span class="sd">        the series of medians and serving as the x coordinates of the</span>
<span class="sd">        multilinear DV function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">        A function that returns the median DV given the quantity of damaged</span>
<span class="sd">        components.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>  <span class="c1"># noqa: ANN001, ANN202</span>
        <span class="k">if</span> <span class="n">quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;A bounded linear median Decision Variable function called &#39;</span>
                <span class="s1">&#39;without specifying the quantity of damaged components&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">q_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># calculate the median consequence given the quantity of damaged</span>
        <span class="c1"># components</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">q_array</span><span class="p">,</span> <span class="n">quantities</span><span class="p">,</span> <span class="n">medians</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_for_lf_model</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if the data are for the lf_model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pd.DataFrame</span>
<span class="sd">        Data to be checked.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether the data are for the lf_model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;LossFunction&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_for_ds_model</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if the data are for the ds_model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pd.DataFrame</span>
<span class="sd">        Data to be checked.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether the data are for the ds_model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;DS1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Leland Stanford Junior University and The Regents of the University of California.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-158130480-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-158130480-7', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>