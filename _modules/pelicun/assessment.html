

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pelicun.assessment &mdash; pelicun  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=f9bf6728" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="../../_static/hide_empty_pre.js?v=a807066b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F2F2F2" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/pelicun-Logo-grey.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/license.html">1. Copyright and license</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/cite.html">2. Citing pelicun</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/cite.html#logo">3. Logo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/acknowledgments.html">4. Acknowledgments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about/acknowledgments.html#national-science-foundation">4.1. National Science Foundation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/acknowledgments.html#contributors">4.2. Contributors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">5. Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes/index.html#version-3-0">5.1. Version 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes/index.html#version-2-0">5.2. Version 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes/index.html#version-1-0">5.3. Version 1.0</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/install.html">1. Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/install.html#staying-up-to-date">1.1. Staying up to date</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/pelicun_framework.html">2. The Pelicun Framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#abbreviations">2.1. Abbreviations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#introduction-to-pelicun">2.2. Introduction to Pelicun</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#overview">2.3. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#performance-assessment-workflow">2.4. Performance Assessment Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#response-model">2.5. Response Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#performance-model">2.6. Performance Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#damage-model">2.7. Damage Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/pelicun_framework.html#loss-model">2.8. Loss Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/feature_overview.html">3. Overview of pelicun features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#saving-loading-samples">3.1. Saving/loading samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#logging-support">3.2. Logging support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#uncertainty-quantification">3.3. Uncertainty quantification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#assessment-types">3.4. Assessment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#demand-simulation">3.5. Demand simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#damage-estimation">3.6. Damage estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#loss-estimation">3.7. Loss estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#command-line-support">3.8. Command-line support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#standalone-tools">3.9. Standalone tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/feature_overview.html#feature-overview-and-examples">3.10. Feature overview and examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/damage_and_loss_library.html">4. Damage and loss library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/bug_reports_and_feature_requests.html">5. Bug reports and feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/resources_for_new_python_users.html">6. Resources for new python users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">7. Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/notebooks/example_1.html">7.1. Example 1: Simple loss function.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/notebooks/example_2.html">7.2. Example 2: Damage state validation.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/notebooks/example_3.html">7.3. Example 3: Combining fragility-based damage consequences and loss functions.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/index.html">8. API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api_reference/_autosummary/pelicun.html">8.1. pelicun</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/getting_started.html">1. Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide/getting_started.html#code-of-conduct">1.1. Code of conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide/getting_started.html#how-to-contribute">1.2. How to contribute</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/development_environment.html">2. Setting up a development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/code_quality.html">3. Coding practice</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide/code_quality.html#code-quality-assurance">3.1. Code quality assurance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide/code_quality.html#unit-tests">3.2. Unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide/code_quality.html#documentation">3.3. Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/internals.html">4. Package architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide/internals.html#overview-of-files">4.1. Overview of files</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #F2F2F2" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pelicun</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pelicun.assessment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pelicun.assessment</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2018 Leland Stanford Junior University</span>
<span class="c1"># Copyright (c) 2018 The Regents of the University of California</span>
<span class="c1">#</span>
<span class="c1"># This file is part of pelicun.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer in the documentation</span>
<span class="c1"># and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># 3. Neither the name of the copyright holder nor the names of its contributors</span>
<span class="c1"># may be used to endorse or promote products derived from this software without</span>
<span class="c1"># specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span>
<span class="c1"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c1"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c1"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c1"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c1"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the BSD 3-Clause License along with</span>
<span class="c1"># pelicun. If not, see &lt;http://www.opensource.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># Contributors:</span>
<span class="c1"># Adam Zsarn√≥czay</span>
<span class="c1"># John Vouvakis Manousakis</span>


<span class="sd">&quot;&quot;&quot;Classes and methods that control the performance assessment.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun</span><span class="w"> </span><span class="kn">import</span> <span class="n">base</span><span class="p">,</span> <span class="n">file_io</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">uq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.__init__</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">pelicun_version</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">EDP_to_demand_type</span><span class="p">,</span> <span class="n">get</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pelicun.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>

<span class="n">default_dbs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;fragility&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_FEMA_P58_2nd.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Buildings&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_Hazus_EQ_bldg.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Stories&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_Hazus_EQ_story.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Transportation&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_Hazus_EQ_trnsp.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Water&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_Hazus_EQ_water.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Power&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_Hazus_EQ_power.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Hurricane&#39;</span><span class="p">:</span> <span class="s1">&#39;damage_DB_SimCenter_Hazus_HU_bldg.csv&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;repair&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span> <span class="s1">&#39;loss_repair_DB_FEMA_P58_2nd.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Buildings&#39;</span><span class="p">:</span> <span class="s1">&#39;loss_repair_DB_Hazus_EQ_bldg.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Stories&#39;</span><span class="p">:</span> <span class="s1">&#39;loss_repair_DB_Hazus_EQ_story.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake - Transportation&#39;</span><span class="p">:</span> <span class="s1">&#39;loss_repair_DB_Hazus_EQ_trnsp.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Hurricane&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;loss_repair_DB_SimCenter_Hazus_HU_bldg.csv,&#39;</span>
            <span class="s1">&#39;loss_repair_DB_Hazus_FL_bldg.csv&#39;</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">default_damage_processes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;1_excessive.coll.DEM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;collapse_DS1&#39;</span><span class="p">},</span>
        <span class="s1">&#39;2_collapse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_NA&#39;</span><span class="p">},</span>
        <span class="s1">&#39;3_excessiveRID&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;irreparable_DS1&#39;</span><span class="p">},</span>
        <span class="s1">&#39;4_irreparable&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_NA&#39;</span><span class="p">},</span>
        <span class="s1">&#39;5_irreparable&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;collapse_DS0&#39;</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="c1"># TODO(AZ): expand with ground failure logic</span>
    <span class="s1">&#39;Hazus Earthquake&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;1_STR&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS5&#39;</span><span class="p">:</span> <span class="s1">&#39;collapse_DS1&#39;</span><span class="p">},</span>
        <span class="s1">&#39;2_LF&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS5&#39;</span><span class="p">:</span> <span class="s1">&#39;collapse_DS1&#39;</span><span class="p">},</span>
        <span class="s1">&#39;3_excessive.coll.DEM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;collapse_DS1&#39;</span><span class="p">},</span>
        <span class="s1">&#39;4_collapse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_NA&#39;</span><span class="p">},</span>
        <span class="s1">&#39;5_excessiveRID&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DS1&#39;</span><span class="p">:</span> <span class="s1">&#39;irreparable_DS1&#39;</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="s1">&#39;Hazus Hurricane&#39;</span><span class="p">:</span> <span class="p">{},</span>
<span class="p">}</span>


<div class="viewcode-block" id="AssessmentBase">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.AssessmentBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AssessmentBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for Assessment objects.</span>

<span class="sd">    Assessment objects manage the models, data, and calculations in pelicun.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;asset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;damage&#39;</span><span class="p">,</span>
        <span class="s1">&#39;demand&#39;</span><span class="p">,</span>
        <span class="s1">&#39;log&#39;</span><span class="p">,</span>
        <span class="s1">&#39;loss&#39;</span><span class="p">,</span>
        <span class="s1">&#39;options&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stories&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unit_conversion_factors&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize an Assessment object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_options:</span>
<span class="sd">            User-specified configuration dictionary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stories</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">Options</span><span class="p">(</span><span class="n">config_options</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">parse_units</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">units_file</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;pelicun </span><span class="si">{</span><span class="n">pelicun_version</span><span class="si">}</span><span class="s1"> | </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">prepend_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">prepend_blank_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">print_system_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">div</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Assessment Started&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">DemandModel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">DemandModel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">AssetModel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">AssetModel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damage</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">DamageModel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">DamageModel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">LossModel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">LossModel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bldg_repair</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">LossModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exists for &lt;backwards compatibility&gt;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model.LossModel</span>
<span class="sd">            The loss model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;`.bldg_repair` is deprecated and will be dropped in &#39;</span>
            <span class="s1">&#39;future versions of pelicun. &#39;</span>
            <span class="s1">&#39;Please use `.loss` instead.&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">repair</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">LossModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exists for &lt;backwards compatibility&gt;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RepairModel_DS</span>
<span class="sd">            The damage state-driven component loss model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;`.repair` is deprecated and will be dropped in &#39;</span>
            <span class="s1">&#39;future versions of pelicun. &#39;</span>
            <span class="s1">&#39;Please use `.loss` instead.&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>

<div class="viewcode-block" id="AssessmentBase.get_default_data">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.AssessmentBase.get_default_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a default data file.</span>

<span class="sd">        Loads a default data file by name and returns it. This method</span>
<span class="sd">        is specifically designed to access predefined CSV files from a</span>
<span class="sd">        structured directory path related to the SimCenter fragility</span>
<span class="sd">        library.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_name: str</span>
<span class="sd">            The name of the CSV file to be loaded, without the &#39;.csv&#39;</span>
<span class="sd">            extension. This name is used to construct the full path to</span>
<span class="sd">            the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The DataFrame containing the data loaded from the</span>
<span class="sd">            specified CSV file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># &lt;backwards compatibility&gt;</span>
        <span class="k">if</span> <span class="s1">&#39;fragility_DB&#39;</span> <span class="ow">in</span> <span class="n">data_name</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="n">data_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fragility_DB&#39;</span><span class="p">,</span> <span class="s1">&#39;damage_DB&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;`fragility_DB` is deprecated and will be dropped in &#39;</span>
                <span class="s1">&#39;future versions of pelicun. &#39;</span>
                <span class="s1">&#39;Please use `damage_DB` instead.&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;bldg_repair_DB&#39;</span> <span class="ow">in</span> <span class="n">data_name</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="n">data_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;bldg_repair_DB&#39;</span><span class="p">,</span> <span class="s1">&#39;loss_repair_DB&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;`bldg_repair_DB` is deprecated and will be dropped in &#39;</span>
                <span class="s1">&#39;future versions of pelicun. &#39;</span>
                <span class="s1">&#39;Please use `loss_repair_DB` instead.&#39;</span>
            <span class="p">)</span>

        <span class="n">data_path</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">substitute_default_path</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PelicunDefault/</span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
            <span class="n">data_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="AssessmentBase.get_default_metadata">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.AssessmentBase.get_default_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a default metadata file and pass it to the user.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_name: string</span>
<span class="sd">            Name of the json file to be loaded</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Default metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># &lt;backwards compatibility&gt;</span>
        <span class="k">if</span> <span class="s1">&#39;fragility_DB&#39;</span> <span class="ow">in</span> <span class="n">data_name</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="n">data_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fragility_DB&#39;</span><span class="p">,</span> <span class="s1">&#39;damage_DB&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;`fragility_DB` is deprecated and will be dropped in &#39;</span>
                <span class="s1">&#39;future versions of pelicun. Please use `damage_DB` instead.&#39;</span>
            <span class="p">)</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">substitute_default_path</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PelicunDefault/</span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>  <span class="c1"># noqa: RET504</span></div>


<div class="viewcode-block" id="AssessmentBase.calc_unit_scale_factor">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.AssessmentBase.calc_unit_scale_factor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_unit_scale_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine unit scale factor.</span>

<span class="sd">        Determines the scale factor from input unit to the</span>
<span class="sd">        corresponding base unit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unit: str</span>
<span class="sd">            Either a unit name, or a quantity and a unit name</span>
<span class="sd">            separated by a space.</span>
<span class="sd">            For example: &#39;ft&#39; or &#39;100 ft&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Scale factor that convert values from unit to base unit</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            When an invalid unit is specified</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unit_lst</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="c1"># check if there is a quantity specified; if yes, parse it</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unit_lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">unit_count_str</span><span class="p">,</span> <span class="n">unit_name</span> <span class="o">=</span> <span class="n">unit_lst</span>
            <span class="n">unit_count</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">unit_count_str</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">unit_name</span> <span class="o">=</span> <span class="n">unit_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">unit_count</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">[</span><span class="n">unit_name</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Specified unit not recognized: </span><span class="si">{</span><span class="n">unit_count</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">unit_name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

        <span class="k">return</span> <span class="n">scale_factor</span></div>


<div class="viewcode-block" id="AssessmentBase.scale_factor">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.AssessmentBase.scale_factor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get scale factor of given unit.</span>

<span class="sd">        Returns the scale factor of a given unit. If the unit is</span>
<span class="sd">        unknown it raises an error. If the unit is None it returns</span>
<span class="sd">        1.00.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unit: str</span>
<span class="sd">            A unit name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Scale factor</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the unit is unknown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">:</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_conversion_factors</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Unknown unit: </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">scale_factor</span></div>
</div>



<div class="viewcode-block" id="Assessment">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.Assessment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Assessment</span><span class="p">(</span><span class="n">AssessmentBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assessment class.</span>

<span class="sd">    Has methods implementing a Scenario-Based assessment.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Assessment.calculate_damage">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.Assessment.calculate_damage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_damage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_stories</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">demand_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">demand_data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">cmp_data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="n">damage_data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="n">dmg_process</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_specification</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">residual_drift_configuration</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collapse_fragility_configuration</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">block_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate damage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_stories: int</span>
<span class="sd">            Number of stories of the asset. Applicable to buildings.</span>
<span class="sd">        demand_config: dict</span>
<span class="sd">            A dictionary containing configuration options for the</span>
<span class="sd">            sample generation. Key options include:</span>
<span class="sd">            * &#39;SampleSize&#39;: The number of samples to generate.</span>
<span class="sd">            * &#39;PreserveRawOrder&#39;: Boolean indicating whether to</span>
<span class="sd">            preserve the order of the raw data. Defaults to False.</span>
<span class="sd">            * &#39;DemandCloning&#39;: Specifies if and how demand cloning</span>
<span class="sd">            should be applied. Can be a boolean or a detailed</span>
<span class="sd">            configuration.</span>
<span class="sd">        demand_data_source: string or dict</span>
<span class="sd">            If string, the demand_data_source is a file prefix</span>
<span class="sd">            (&lt;prefix&gt; in the following description) that identifies</span>
<span class="sd">            the following files: &lt;prefix&gt;_marginals.csv,</span>
<span class="sd">            &lt;prefix&gt;_empirical.csv, &lt;prefix&gt;_correlation.csv. If dict,</span>
<span class="sd">            the demand data source is a dictionary with the following</span>
<span class="sd">            optional keys: &#39;marginals&#39;, &#39;empirical&#39;, and</span>
<span class="sd">            &#39;correlation&#39;. The value under each key shall be a</span>
<span class="sd">            DataFrame.</span>
<span class="sd">        cmp_data_source: str or dict</span>
<span class="sd">            The source from where to load the component model data. If</span>
<span class="sd">            it&#39;s a string, it should be the prefix for three files:</span>
<span class="sd">            one for marginal distributions (`&lt;prefix&gt;_marginals.csv`),</span>
<span class="sd">            one for empirical data (`&lt;prefix&gt;_empirical.csv`), and one</span>
<span class="sd">            for correlation data (`&lt;prefix&gt;_correlation.csv`). If it&#39;s</span>
<span class="sd">            a dictionary, it should have keys &#39;marginals&#39;,</span>
<span class="sd">            &#39;empirical&#39;, and &#39;correlation&#39;, with each key associated</span>
<span class="sd">            with a DataFrame containing the corresponding data.</span>
<span class="sd">        damage_data_paths: list of (string | DataFrame)</span>
<span class="sd">            List of paths to data or files with damage model</span>
<span class="sd">            information. Default XY datasets can be accessed as</span>
<span class="sd">            PelicunDefault/XY. Order matters. Parameters defined in</span>
<span class="sd">            prior elements in the list take precedence over the same</span>
<span class="sd">            parameters in subsequent data paths. I.e., place the</span>
<span class="sd">            Default datasets in the back.</span>
<span class="sd">        dmg_process: dict, optional</span>
<span class="sd">            Allows simulating damage processes, where damage to some</span>
<span class="sd">            component can alter the damage state of other components.</span>
<span class="sd">        scaling_specification: dict, optional</span>
<span class="sd">            A dictionary defining the shift in median.</span>
<span class="sd">            Example: {&#39;CMP-1-1&#39;: &#39;*1.2&#39;, &#39;CMP-1-2&#39;: &#39;/1.4&#39;}</span>
<span class="sd">            The keys are individual components that should be present</span>
<span class="sd">            in the `capacity_sample`.  The values should be strings</span>
<span class="sd">            containing an operation followed by the value formatted as</span>
<span class="sd">            a float.  The operation can be &#39;+&#39; for addition, &#39;-&#39; for</span>
<span class="sd">            subtraction, &#39;*&#39; for multiplication, and &#39;/&#39; for division.</span>
<span class="sd">        residual_drift_configuration: dict</span>
<span class="sd">            Dictionary containing the following keys-values:</span>
<span class="sd">            - params: dict</span>
<span class="sd">            A dictionary containing parameters required for the</span>
<span class="sd">            estimation method, such as &#39;yield_drift&#39;, which is the</span>
<span class="sd">            drift at which yielding is expected to occur.</span>
<span class="sd">            - method: str, optional</span>
<span class="sd">            The method used to estimate the RID values. Currently,</span>
<span class="sd">            only &#39;FEMA P58&#39; is implemented. Defaults to &#39;FEMA P58&#39;.</span>
<span class="sd">        collapse_fragility_configuration: dict</span>
<span class="sd">            Dictionary containing the following keys-values:</span>
<span class="sd">            - label: str</span>
<span class="sd">            Label to use to extend the MultiIndex of the demand</span>
<span class="sd">            sample.</span>
<span class="sd">            - value: float</span>
<span class="sd">            Values to add to the rows of the additional column.</span>
<span class="sd">            - unit: str</span>
<span class="sd">            Unit that corresponds to the additional column.</span>
<span class="sd">            - location: str, optional</span>
<span class="sd">            Optional location, defaults to `0`.</span>
<span class="sd">            - direction: str, optional</span>
<span class="sd">            Optional direction, defaults to `1`.</span>
<span class="sd">        block_batch_size: int</span>
<span class="sd">            Maximum number of components in each batch.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO(JVM): when we build the API docs, ensure the above is</span>
        <span class="c1"># properly rendered.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">demand_data_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">(</span><span class="n">demand_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">residual_drift_configuration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">estimate_RID_and_adjust_sample</span><span class="p">(</span>
                <span class="n">residual_drift_configuration</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span>
                <span class="n">residual_drift_configuration</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">collapse_fragility_configuration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">expand_sample</span><span class="p">(</span>
                <span class="n">collapse_fragility_configuration</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                <span class="n">collapse_fragility_configuration</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                <span class="n">collapse_fragility_configuration</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stories</span> <span class="o">=</span> <span class="n">num_stories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">load_cmp_model</span><span class="p">(</span><span class="n">cmp_data_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">generate_cmp_sample</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">(</span>
            <span class="n">damage_data_paths</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">list_unique_component_ids</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">dmg_process</span><span class="p">,</span> <span class="n">block_batch_size</span><span class="p">,</span> <span class="n">scaling_specification</span><span class="p">)</span></div>


<div class="viewcode-block" id="Assessment.calculate_loss">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.Assessment.calculate_loss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">loss_model_data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="n">loss_map_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_map_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate loss.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        decision_variables: tuple</span>
<span class="sd">            Defines the decision variables to be included in the loss</span>
<span class="sd">            calculations. Defaults to those supported, but fewer can be</span>
<span class="sd">            used if desired. When fewer are used, the loss parameters for</span>
<span class="sd">            those not used will not be required.</span>
<span class="sd">        loss_model_data_paths: list of (string | DataFrame)</span>
<span class="sd">            List of paths to data or files with loss model</span>
<span class="sd">            information. Default XY datasets can be accessed as</span>
<span class="sd">            PelicunDefault/XY. Order matters. Parameters defined in</span>
<span class="sd">            prior elements in the list take precedence over the same</span>
<span class="sd">            parameters in subsequent data paths. I.e., place the</span>
<span class="sd">            Default datasets in the back.</span>
<span class="sd">        loss_map_path: str or pd.DataFrame or None</span>
<span class="sd">            Path to a csv file or DataFrame object that maps</span>
<span class="sd">            components IDs to their loss parameter definitions.</span>
<span class="sd">        loss_map_policy: str or None</span>
<span class="sd">            If None, does not modify the loss map.</span>
<span class="sd">            If set to `fill`, each component ID that is present in</span>
<span class="sd">            the asset model but not in the loss map is mapped to</span>
<span class="sd">            itself, but `excessiveRID` is excluded.</span>
<span class="sd">            If set to `fill_all`, each component ID that is present in</span>
<span class="sd">            the asset model but not in the loss map is mapped to</span>
<span class="sd">            itself without exceptions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">decision_variables</span> <span class="o">=</span> <span class="n">decision_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">add_loss_map</span><span class="p">(</span><span class="n">loss_map_path</span><span class="p">,</span> <span class="n">loss_map_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">(</span><span class="n">loss_model_data_paths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span></div>


<div class="viewcode-block" id="Assessment.aggregate_loss">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.Assessment.aggregate_loss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">replacement_configuration</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_combination</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate losses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        replacement_configuration: Tuple, optional</span>
<span class="sd">            Tuple containing a RandomVariableRegistry and a</span>
<span class="sd">            dictionary. The RandomVariableRegistry is defining</span>
<span class="sd">            building replacement consequence RVs for the active</span>
<span class="sd">            decision variables. The dictionary defines exceedance</span>
<span class="sd">            thresholds. If the aggregated value for a decision</span>
<span class="sd">            variable (conditioned on no replacement) exceeds the</span>
<span class="sd">            threshold, then replacement is triggered. This can happen</span>
<span class="sd">            for multiple decision variables at the same</span>
<span class="sd">            realization. The consequence keyword `replacement` is</span>
<span class="sd">            reserved to represent exclusive triggering of the</span>
<span class="sd">            replacement consequences, and other consequences are</span>
<span class="sd">            ignored for those realizations where replacement is</span>
<span class="sd">            triggered. When assigned to None, then `replacement` is</span>
<span class="sd">            still treated as an exclusive consequence (other</span>
<span class="sd">            consequences are set to zero when replacement is nonzero)</span>
<span class="sd">            but it is not being additionally triggered by the</span>
<span class="sd">            exceedance of any thresholds. The aggregated loss sample</span>
<span class="sd">            contains an additional column with information on whether</span>
<span class="sd">            replacement was already present or triggered by a</span>
<span class="sd">            threshold exceedance for each realization.</span>
<span class="sd">        loss_combination: dict, optional</span>
<span class="sd">            Dictionary defining how losses for specific components</span>
<span class="sd">            should be aggregated for a given decision variable. It has</span>
<span class="sd">            the following structure: {`dv`: {(`c1`, `c2`): `arr`,</span>
<span class="sd">            ...}, ...}, where `dv` is some decision variable, (`c1`,</span>
<span class="sd">            `c2`) is a tuple defining a component pair, `arr` is a NxN</span>
<span class="sd">            numpy array defining a combination table, and `...` means</span>
<span class="sd">            that more key-value pairs with the same schema can exist</span>
<span class="sd">            in the dictionaries.  The loss sample is expected to</span>
<span class="sd">            contain columns that include both `c1` and `c2` listed as</span>
<span class="sd">            the component. The combination is applied to all pairs of</span>
<span class="sd">            columns where the components are `c1` and `c2`, and all of</span>
<span class="sd">            the rest of the multiindex levels match (`loc`, `dir`,</span>
<span class="sd">            `uid`). This means, for example, that when combining wind</span>
<span class="sd">            and flood losses, the asset model should contain both a</span>
<span class="sd">            wind and a flood component defined at the same</span>
<span class="sd">            location-direction.  `arr` can also be an M-dimensional</span>
<span class="sd">            numpy array where each dimension has length N (NxNx...xN).</span>
<span class="sd">            This structure allows for the loss combination of M</span>
<span class="sd">            components.  In this case the (`c1`, `c2`) tuple should</span>
<span class="sd">            contain M elements instead of two.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Regardless of the value of the arguments, this method does not</span>
<span class="sd">        alter the state of the loss model, i.e., it does not modify</span>
<span class="sd">        the values of the `.sample` attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Dataframe with the aggregated loss of each realization,</span>
<span class="sd">            and another boolean dataframe with information on which DV</span>
<span class="sd">            thresholds were exceeded in each realization, triggering</span>
<span class="sd">            replacement. If no thresholds are specified it only</span>
<span class="sd">            contains False values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">aggregate_losses</span><span class="p">(</span>
            <span class="n">replacement_configuration</span><span class="p">,</span> <span class="n">loss_combination</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>



<div class="viewcode-block" id="DLCalculationAssessment">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.DLCalculationAssessment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DLCalculationAssessment</span><span class="p">(</span><span class="n">AssessmentBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for the assessment objects used in `DL_calculation.py`.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DLCalculationAssessment.calculate_demand">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.DLCalculationAssessment.calculate_demand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_demand</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">demand_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">collapse_limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">demand_calibration</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">demand_cloning</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">residual_drift_inference</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">coupled_demands</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate demands.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        demand_path: str</span>
<span class="sd">            Path to the demand data file.</span>
<span class="sd">        collapse_limits: dict[str, float] or None</span>
<span class="sd">            Optional dictionary with demand types and their respective</span>
<span class="sd">            collapse limits.</span>
<span class="sd">        length_unit : str, optional</span>
<span class="sd">            Unit of length to be used to add units to the demand data</span>
<span class="sd">            if needed.</span>
<span class="sd">        demand_calibration: dict or None</span>
<span class="sd">            Calibration data for the demand model.</span>
<span class="sd">        sample_size: int</span>
<span class="sd">            Number of realizations.</span>
<span class="sd">        coupled_demands: bool</span>
<span class="sd">            Whether to preserve the raw order of the demands.</span>
<span class="sd">        demand_cloning: dict or None</span>
<span class="sd">            Demand cloning configuration.</span>
<span class="sd">        residual_drift_inference: dict or None</span>
<span class="sd">            Information for residual drift inference.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            When an unknown residual drift method is specified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>
        <span class="n">raw_demands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">demand_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># remove excessive demands that are considered collapses, if needed</span>
        <span class="k">if</span> <span class="n">collapse_limits</span><span class="p">:</span>
            <span class="n">raw_demands_m</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">convert_to_MultiIndex</span><span class="p">(</span><span class="n">raw_demands</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_demands_m</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="n">raw_demands</span> <span class="o">=</span> <span class="n">raw_demands_m</span>

            <span class="k">if</span> <span class="s1">&#39;Units&#39;</span> <span class="ow">in</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">raw_units</span> <span class="o">=</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">raw_demands</span> <span class="o">=</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">raw_units</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">dem_to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">raw_demands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dem_type</span><span class="p">,</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">collapse_limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dem_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="n">nlevels_with_event_id</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="n">nlevels_with_event_id</span><span class="p">:</span>
                    <span class="n">dem_to_drop</span> <span class="o">+=</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">:,</span>  <span class="c1"># type: ignore</span>
                        <span class="n">idx</span><span class="p">[:,</span> <span class="n">dem_type</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dem_to_drop</span> <span class="o">+=</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">:,</span>  <span class="c1"># type: ignore</span>
                        <span class="n">idx</span><span class="p">[</span><span class="n">dem_type</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

            <span class="n">raw_demands</span> <span class="o">=</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">dem_to_drop</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_units</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="n">raw_demands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">raw_demands</span><span class="p">,</span> <span class="n">raw_units</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dem_to_drop</span><span class="p">)</span><span class="si">}</span><span class="s1"> realizations removed from the demand &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;input because they exceed the collapse limit. The remaining &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;sample size: </span><span class="si">{</span><span class="n">raw_demands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># add units to the demand data if needed</span>
        <span class="k">if</span> <span class="s1">&#39;Units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">length_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;A length unit is required to infer demand units.&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">demands</span> <span class="o">=</span> <span class="n">_add_units</span><span class="p">(</span><span class="n">raw_demands</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">demands</span> <span class="o">=</span> <span class="n">raw_demands</span>

        <span class="c1"># load the available demand sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">load_sample</span><span class="p">(</span><span class="n">demands</span><span class="p">)</span>

        <span class="c1"># get the calibration information</span>
        <span class="k">if</span> <span class="n">demand_calibration</span><span class="p">:</span>
            <span class="c1"># then use it to calibrate the demand model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">calibrate_model</span><span class="p">(</span><span class="n">demand_calibration</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if no calibration is requested,</span>
            <span class="c1"># set all demands to use empirical distribution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">calibrate_model</span><span class="p">({</span><span class="s1">&#39;ALL&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DistributionFamily&#39;</span><span class="p">:</span> <span class="s1">&#39;empirical&#39;</span><span class="p">}})</span>

        <span class="c1"># and generate a new demand sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;SampleSize&#39;</span><span class="p">:</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="s1">&#39;PreserveRawOrder&#39;</span><span class="p">:</span> <span class="n">coupled_demands</span><span class="p">,</span>
                <span class="s1">&#39;DemandCloning&#39;</span><span class="p">:</span> <span class="n">demand_cloning</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># get the generated demand sample</span>
        <span class="n">demand_sample_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">save_sample</span><span class="p">(</span><span class="n">save_units</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">demand_sample_tuple</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">demand_sample</span><span class="p">,</span> <span class="n">demand_units</span> <span class="o">=</span> <span class="n">demand_sample_tuple</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">demand_sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">demand_units</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

        <span class="n">demand_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">demand_sample</span><span class="p">,</span> <span class="n">demand_units</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

        <span class="c1"># get residual drift estimates, if needed</span>
        <span class="k">if</span> <span class="n">residual_drift_inference</span><span class="p">:</span>
            <span class="c1"># `method` is guaranteed to exist because it is confirmed when</span>
            <span class="c1"># parsing the configuration file.</span>
            <span class="n">rid_inference_method</span> <span class="o">=</span> <span class="n">residual_drift_inference</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rid_inference_method</span> <span class="o">==</span> <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span>
                <span class="n">rid_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">demand_sample</span><span class="p">[</span><span class="s1">&#39;PID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">delta_yield</span> <span class="ow">in</span> <span class="n">residual_drift_inference</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">pids</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[:,</span> <span class="n">direction</span><span class="p">]]</span>  <span class="c1"># type: ignore</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pids</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
                    <span class="n">rid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">estimate_RID</span><span class="p">(</span>
                        <span class="n">pids</span><span class="p">,</span>
                        <span class="p">{</span><span class="s1">&#39;yield_drift&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_yield</span><span class="p">)},</span>
                    <span class="p">)</span>

                    <span class="n">rid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>

                <span class="n">rid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rid_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">rid_units</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;unitless&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">rid</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rid_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rid</span><span class="p">,</span> <span class="n">rid_units</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
                <span class="n">demand_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">demand_sample</span><span class="p">,</span> <span class="n">rid_sample</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Unknown residual drift inference method: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">rid_inference_method</span><span class="si">}</span><span class="s1">`.&#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># add a constant one demand</span>
        <span class="n">demand_sample</span><span class="p">[</span><span class="s1">&#39;ONE&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">demand_sample</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">demand_sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;ONE&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;unitless&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">load_sample</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">convert_to_SimpleIndex</span><span class="p">(</span><span class="n">demand_sample</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="DLCalculationAssessment.calculate_asset">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.DLCalculationAssessment.calculate_asset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_asset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_stories</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">component_assignment_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collapse_fragility_demand_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component_sample_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">add_irreparable_damage_columns</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the asset model sample.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_stories: int</span>
<span class="sd">            Number of stories.</span>
<span class="sd">        component_assignment_file: str or None</span>
<span class="sd">            Path to a component assignment file.</span>
<span class="sd">        collapse_fragility_demand_type: str or None</span>
<span class="sd">            Optional demand type for the collapse fragility.</span>
<span class="sd">        add_irreparable_damage_columns: bool</span>
<span class="sd">            Whether to add columns for irreparable damage.</span>
<span class="sd">        component_sample_file: str or None</span>
<span class="sd">            Optional path to an existing component sample file.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            With invalid combinations of arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># retrieve the demand sample</span>
        <span class="n">demand_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">save_sample</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">demand_sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

        <span class="c1"># set the number of stories</span>
        <span class="k">if</span> <span class="n">num_stories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stories</span> <span class="o">=</span> <span class="n">num_stories</span>

        <span class="c1"># We either accept a `component_assignment_file` or a</span>
        <span class="c1"># `component_sample_file`, not both.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">component_assignment_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">component_sample_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Both `component_assignment_file` and &#39;</span>
                <span class="s1">&#39;`component_sample_file` are provided. &#39;</span>
                <span class="s1">&#39;Please provide only one.&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># load a component model and generate a sample</span>
        <span class="k">if</span> <span class="n">component_assignment_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmp_marginals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">component_assignment_file</span><span class="p">,</span>
                <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">encoding_errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">dem_types</span> <span class="o">=</span> <span class="n">demand_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># add component(s) to support collapse calculation</span>
            <span class="k">if</span> <span class="n">collapse_fragility_demand_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">collapse_fragility_demand_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA&#39;</span><span class="p">):</span>
                    <span class="c1"># we need story-specific collapse assessment</span>
                    <span class="c1"># (otherwise we have a global demand and evaluate</span>
                    <span class="c1"># collapse directly, so this code should be skipped)</span>

                    <span class="k">if</span> <span class="n">collapse_fragility_demand_type</span> <span class="ow">in</span> <span class="n">dem_types</span><span class="p">:</span>
                        <span class="c1"># excessive coll_DEM is added on every floor</span>
                        <span class="c1"># to detect large RIDs</span>
                        <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessive.coll.DEM&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ea&#39;</span>

                        <span class="n">locs</span> <span class="o">=</span> <span class="n">demand_sample</span><span class="p">[</span>
                            <span class="n">collapse_fragility_demand_type</span>  <span class="c1"># type: ignore</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessive.coll.DEM&#39;</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">dirs</span> <span class="o">=</span> <span class="n">demand_sample</span><span class="p">[</span>
                            <span class="n">collapse_fragility_demand_type</span>  <span class="c1"># type: ignore</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessive.coll.DEM&#39;</span><span class="p">,</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessive.coll.DEM&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;WARNING: No </span><span class="si">{</span><span class="n">collapse_fragility_demand_type</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;among available demands. Collapse cannot &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;be evaluated.&#39;</span>
                        <span class="p">)</span>

            <span class="c1"># always add a component to support basic collapse calculation</span>
            <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ea&#39;</span>
            <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># add components to support irreparable damage calculation</span>
            <span class="k">if</span> <span class="n">add_irreparable_damage_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;RID&#39;</span> <span class="ow">in</span> <span class="n">dem_types</span><span class="p">:</span>
                    <span class="c1"># excessive RID is added on every floor to detect large RIDs</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ea&#39;</span>

                    <span class="n">locs</span> <span class="o">=</span> <span class="n">demand_sample</span><span class="p">[</span><span class="s1">&#39;RID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>

                    <span class="n">dirs</span> <span class="o">=</span> <span class="n">demand_sample</span><span class="p">[</span><span class="s1">&#39;RID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>

                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="c1"># irreparable is a global component to recognize is any of the</span>
                    <span class="c1"># excessive RIDs were triggered</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ea&#39;</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">cmp_marginals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                        <span class="s1">&#39;WARNING: No residual interstory drift ratio among &#39;</span>
                        <span class="s1">&#39;available demands. Irreparable damage cannot be &#39;</span>
                        <span class="s1">&#39;evaluated.&#39;</span>
                    <span class="p">)</span>

            <span class="c1"># load component model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">load_cmp_model</span><span class="p">({</span><span class="s1">&#39;marginals&#39;</span><span class="p">:</span> <span class="n">cmp_marginals</span><span class="p">})</span>

            <span class="c1"># generate component quantity sample</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">generate_cmp_sample</span><span class="p">()</span>

        <span class="c1"># if requested, load the quantity sample from a file</span>
        <span class="k">if</span> <span class="n">component_sample_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">load_cmp_sample</span><span class="p">(</span><span class="n">component_sample_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="DLCalculationAssessment.calculate_damage">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.DLCalculationAssessment.calculate_damage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_damage</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component_database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">component_database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collapse_fragility</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">irreparable_damage</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">damage_process_approach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">damage_process_file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_model_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_specification</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_for_water_network_assessment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate damage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        length_unit : str, optional</span>
<span class="sd">            Unit of length to be used to add units to the demand data</span>
<span class="sd">            if needed.</span>
<span class="sd">        component_database: str</span>
<span class="sd">            Name of the component database.</span>
<span class="sd">        component_database_path: str or None</span>
<span class="sd">            Optional path to a component database file.</span>
<span class="sd">        collapse_fragility: dict or None</span>
<span class="sd">            Collapse fragility information.</span>
<span class="sd">        irreparable_damage: dict or None</span>
<span class="sd">            Information for irreparable damage.</span>
<span class="sd">        damage_process_approach: str or None</span>
<span class="sd">            Approach for the damage process.</span>
<span class="sd">        damage_process_file_path: str or None</span>
<span class="sd">            Optional path to a damage process file.</span>
<span class="sd">        custom_model_dir: str or None</span>
<span class="sd">            Optional directory for custom models.</span>
<span class="sd">        scaling_specification: dict, optional</span>
<span class="sd">            A dictionary defining the shift in median.</span>
<span class="sd">            Example: {&#39;CMP-1-1&#39;: &#39;*1.2&#39;, &#39;CMP-1-2&#39;: &#39;/1.4&#39;}</span>
<span class="sd">            The keys are individual components that should be present</span>
<span class="sd">            in the `capacity_sample`.  The values should be strings</span>
<span class="sd">            containing an operation followed by the value formatted as</span>
<span class="sd">            a float.  The operation can be &#39;+&#39; for addition, &#39;-&#39; for</span>
<span class="sd">            subtraction, &#39;*&#39; for multiplication, and &#39;/&#39; for division.</span>
<span class="sd">        is_for_water_network_assessment: bool</span>
<span class="sd">            Whether the assessment is for a water network.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            With invalid combinations of arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load the fragility information</span>
        <span class="k">if</span> <span class="n">component_database</span> <span class="ow">in</span> <span class="n">default_dbs</span><span class="p">[</span><span class="s1">&#39;fragility&#39;</span><span class="p">]:</span>
            <span class="n">component_db</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;PelicunDefault/&#39;</span> <span class="o">+</span> <span class="n">filename</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">default_dbs</span><span class="p">[</span><span class="s1">&#39;fragility&#39;</span><span class="p">][</span><span class="n">component_database</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="s1">&#39;,&#39;</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">component_db</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">component_database_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;CustomDLDataFolder&#39;</span> <span class="ow">in</span> <span class="n">component_database_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">custom_model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;`custom_model_dir` needs to be specified &#39;</span>
                        <span class="s1">&#39;when `component_database_path` includes CustomDLDataFolder.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">component_database_path</span> <span class="o">=</span> <span class="n">component_database_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s1">&#39;CustomDLDataFolder&#39;</span><span class="p">,</span> <span class="n">custom_model_dir</span>
                <span class="p">)</span>

            <span class="n">component_db</span> <span class="o">+=</span> <span class="p">[</span><span class="n">component_database_path</span><span class="p">]</span>

        <span class="n">component_db</span> <span class="o">=</span> <span class="n">component_db</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># prepare additional fragility data</span>

        <span class="c1"># get the database header from the default P58 db</span>
        <span class="n">p58_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_data</span><span class="p">(</span><span class="s1">&#39;damage_DB_FEMA_P58_2nd&#39;</span><span class="p">)</span>

        <span class="n">adf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">p58_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">collapse_fragility</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cmp_marginal_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="s1">&#39;excessive.coll.DEM&#39;</span>
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cmp_marginal_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;cmp&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># if there is story-specific evaluation</span>
                <span class="n">coll_cmp_name</span> <span class="o">=</span> <span class="s1">&#39;excessive.coll.DEM&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise, for global collapse evaluation</span>
                <span class="n">coll_cmp_name</span> <span class="o">=</span> <span class="s1">&#39;collapse&#39;</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Directional&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">coll_dem</span> <span class="o">=</span> <span class="n">collapse_fragility</span><span class="p">[</span><span class="s1">&#39;DemandType&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">coll_dem</span><span class="p">:</span>
                <span class="n">coll_dem</span><span class="p">,</span> <span class="n">coll_dem_spec</span> <span class="o">=</span> <span class="n">coll_dem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coll_dem_spec</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">coll_dem_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">demand_name</span><span class="p">,</span> <span class="n">demand_short</span> <span class="ow">in</span> <span class="n">EDP_to_demand_type</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">demand_short</span> <span class="o">==</span> <span class="n">coll_dem</span><span class="p">:</span>
                    <span class="n">coll_dem_name</span> <span class="o">=</span> <span class="n">demand_name</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">coll_dem_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;A valid demand type acronym was not provided in&#39;</span>
                    <span class="s1">&#39;the configuration file. Please ensure the&#39;</span>
                    <span class="s2">&quot;&#39;DemandType&#39; field in the collapse fragility&quot;</span>
                    <span class="s1">&#39;section contains one of the recognized acronyms&#39;</span>
                    <span class="s2">&quot;(e.g., &#39;SA&#39;, &#39;PFA&#39;, &#39;PGA&#39;). Refer to the&quot;</span>
                    <span class="s2">&quot;configuration file&#39;s &#39;collapse_fragility&#39;&quot;</span>
                    <span class="s1">&#39;section.&#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">coll_dem_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coll_dem_name</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coll_dem_name</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">coll_dem_spec</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">length_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;A length unit is required.&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">coll_dem_unit</span> <span class="o">=</span> <span class="n">_add_units</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coll_dem</span><span class="si">}</span><span class="s1">-1-1&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">length_unit</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coll_dem_unit</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">collapse_fragility</span><span class="p">[</span>
                <span class="s1">&#39;CapacityDistribution&#39;</span>
            <span class="p">]</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">collapse_fragility</span><span class="p">[</span>
                <span class="s1">&#39;CapacityMedian&#39;</span>
            <span class="p">]</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">collapse_fragility</span><span class="p">[</span>
                <span class="s1">&#39;Theta_1&#39;</span>
            <span class="p">]</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coll_cmp_name</span><span class="p">,</span> <span class="s1">&#39;Incomplete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">coll_cmp_name</span> <span class="o">!=</span> <span class="s1">&#39;collapse&#39;</span><span class="p">:</span>
                <span class="c1"># for story-specific evaluation, we need to add a placeholder</span>
                <span class="c1"># fragility that will never trigger, but helps us aggregate</span>
                <span class="c1"># results in the end</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Directional&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;One&#39;</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;unitless&#39;</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e10</span>
                <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_for_water_network_assessment</span><span class="p">:</span>
            <span class="c1"># add a placeholder collapse fragility that will never trigger</span>
            <span class="c1"># collapse, but allow damage processes to work with collapse</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Directional&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;One&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;unitless&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e10</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">irreparable_damage</span><span class="p">:</span>
            <span class="c1"># add excessive RID fragility according to settings provided in the</span>
            <span class="c1"># input file</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Directional&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Residual Interstory Drift Ratio&#39;</span>
            <span class="p">)</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;unitless&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">irreparable_damage</span><span class="p">[</span>
                <span class="s1">&#39;DriftCapacityMedian&#39;</span>
            <span class="p">]</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;lognormal&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">irreparable_damage</span><span class="p">[</span>
                <span class="s1">&#39;DriftCapacityLogStd&#39;</span>
            <span class="p">]</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;excessiveRID&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># add a placeholder irreparable fragility that will never trigger</span>
            <span class="c1"># damage, but allow damage processes to aggregate excessiveRID here</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Directional&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;One&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;unitless&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e10</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># TODO(AZ): we can improve this by creating a water</span>
        <span class="c1"># network-specific assessment class</span>
        <span class="k">if</span> <span class="n">is_for_water_network_assessment</span><span class="p">:</span>
            <span class="c1"># add a placeholder aggregate fragility that will never trigger</span>
            <span class="c1"># damage, but allow damage processes to aggregate the</span>
            <span class="c1"># various pipeline damages</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Directional&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;Peak Ground Velocity&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;mps&#39;</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e10</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;LS2&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e10</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">(</span>
            <span class="p">[</span><span class="o">*</span><span class="n">component_db</span><span class="p">,</span> <span class="n">adf</span><span class="p">],</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">list_unique_component_ids</span><span class="p">()),</span>
        <span class="p">)</span>

        <span class="c1"># load the damage process if needed</span>
        <span class="n">dmg_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">damage_process_approach</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: PLR1702</span>
            <span class="k">if</span> <span class="n">damage_process_approach</span> <span class="ow">in</span> <span class="n">default_damage_processes</span><span class="p">:</span>
                <span class="n">dmg_process</span> <span class="o">=</span> <span class="n">default_damage_processes</span><span class="p">[</span><span class="n">damage_process_approach</span><span class="p">]</span>

                <span class="c1"># For Hazus Earthquake, we need to specify the component ids</span>
                <span class="k">if</span> <span class="n">damage_process_approach</span> <span class="o">==</span> <span class="s1">&#39;Hazus Earthquake&#39;</span><span class="p">:</span>
                    <span class="n">cmp_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">save_cmp_sample</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmp_sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

                    <span class="n">cmp_list</span> <span class="o">=</span> <span class="n">cmp_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">cmp_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;STR&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;LF&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">cmp</span> <span class="ow">in</span> <span class="n">cmp_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">cmp_type</span> <span class="ow">in</span> <span class="n">cmp_map</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cmp_type</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">cmp</span><span class="p">:</span>
                                <span class="n">cmp_map</span><span class="p">[</span><span class="n">cmp_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmp</span>

                    <span class="n">new_dmg_process</span> <span class="o">=</span> <span class="n">dmg_process</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">source_cmp</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">dmg_process</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># first, look at the source component id</span>
                        <span class="n">new_source</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">cmp_type</span><span class="p">,</span> <span class="n">cmp_id</span> <span class="ow">in</span> <span class="n">cmp_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">cmp_type</span> <span class="ow">in</span> <span class="n">source_cmp</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cmp_id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>  <span class="c1"># noqa: PLC1901</span>
                                <span class="n">new_source</span> <span class="o">=</span> <span class="n">source_cmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cmp_type</span><span class="p">,</span> <span class="n">cmp_id</span><span class="p">)</span>
                                <span class="k">break</span>

                        <span class="k">if</span> <span class="n">new_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">new_dmg_process</span><span class="p">[</span><span class="n">new_source</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
                            <span class="k">del</span> <span class="n">new_dmg_process</span><span class="p">[</span><span class="n">source_cmp</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_source</span> <span class="o">=</span> <span class="n">source_cmp</span>

                        <span class="c1"># then, look at the target component ids</span>
                        <span class="k">for</span> <span class="n">ds_i</span><span class="p">,</span> <span class="n">target_vals</span> <span class="ow">in</span> <span class="n">action</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_vals</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">cmp_type</span><span class="p">,</span> <span class="n">cmp_id</span> <span class="ow">in</span> <span class="n">cmp_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">cmp_type</span> <span class="ow">in</span> <span class="n">target_vals</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cmp_id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>  <span class="c1"># noqa: PLC1901</span>
                                        <span class="n">target_vals</span> <span class="o">=</span> <span class="n">target_vals</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>  <span class="c1"># noqa: PLW2901</span>
                                            <span class="n">cmp_type</span><span class="p">,</span> <span class="n">cmp_id</span>
                                        <span class="p">)</span>

                                <span class="n">new_target_vals</span> <span class="o">=</span> <span class="n">target_vals</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># we assume that target_vals is a list of str</span>
                                <span class="n">new_target_vals</span> <span class="o">=</span> <span class="p">[]</span>

                                <span class="k">for</span> <span class="n">target_val</span> <span class="ow">in</span> <span class="n">target_vals</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">cmp_type</span><span class="p">,</span> <span class="n">cmp_id</span> <span class="ow">in</span> <span class="n">cmp_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">cmp_type</span> <span class="ow">in</span> <span class="n">target_val</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                                            <span class="n">cmp_id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># noqa: PLC1901</span>
                                        <span class="p">):</span>
                                            <span class="n">target_val</span> <span class="o">=</span> <span class="n">target_val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>  <span class="c1"># noqa: PLW2901</span>
                                                <span class="n">cmp_type</span><span class="p">,</span> <span class="n">cmp_id</span>
                                            <span class="p">)</span>

                                    <span class="n">new_target_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_val</span><span class="p">)</span>

                            <span class="n">new_dmg_process</span><span class="p">[</span><span class="n">new_source</span><span class="p">][</span><span class="n">ds_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_target_vals</span>

                    <span class="n">dmg_process</span> <span class="o">=</span> <span class="n">new_dmg_process</span>

                <span class="c1"># Remove components not present in the asset model</span>
                <span class="c1"># from the source components of the damage process.</span>
                <span class="n">asset_components</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">list_unique_component_ids</span><span class="p">())</span>
                <span class="n">filtered_dmg_process</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dmg_process</span><span class="p">:</span>
                    <span class="n">component</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">asset_components</span><span class="p">:</span>
                        <span class="n">filtered_dmg_process</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmg_process</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">dmg_process</span> <span class="o">=</span> <span class="n">filtered_dmg_process</span>

            <span class="k">elif</span> <span class="n">damage_process_approach</span> <span class="o">==</span> <span class="s1">&#39;User Defined&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">damage_process_file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;When `damage_process_approach` is set to &#39;</span>
                        <span class="s1">&#39;`User Defined`, a `damage_process_file_path` &#39;</span>
                        <span class="s1">&#39;needs to be provided.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># load the damage process from a file</span>
                <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">damage_process_file_path</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">dmg_process</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">damage_process_approach</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="c1"># no damage process applied for the calculation</span>
                <span class="n">dmg_process</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Prescribed Damage Process not recognized: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">damage_process_approach</span><span class="si">}</span><span class="s1">`.&#39;</span>
                <span class="p">)</span>

        <span class="c1"># calculate damages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
            <span class="n">dmg_process</span><span class="o">=</span><span class="n">dmg_process</span><span class="p">,</span>
            <span class="n">scaling_specification</span><span class="o">=</span><span class="n">scaling_specification</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DLCalculationAssessment.calculate_loss">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.DLCalculationAssessment.calculate_loss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_map_approach</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">occupancy_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">consequence_database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">consequence_database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_model_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">damage_process_approach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;User Defined&#39;</span><span class="p">,</span>
        <span class="n">replacement_cost_parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replacement_time_parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replacement_carbon_parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replacement_energy_parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_map_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">decision_variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replacement_configuration</span><span class="p">:</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="n">uq</span><span class="o">.</span><span class="n">RandomVariableRegistry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_combination_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate losses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_map_approach: str</span>
<span class="sd">            Approach for the loss map generation. Can be either</span>
<span class="sd">            `User Defined` or `Automatic`.</span>
<span class="sd">        occupancy_type: str</span>
<span class="sd">            Occupancy type.</span>
<span class="sd">        consequence_database: str</span>
<span class="sd">            Name of the consequence database.</span>
<span class="sd">        consequence_database_path: str or None</span>
<span class="sd">            Optional path to a consequence database file.</span>
<span class="sd">        custom_model_dir: str or None</span>
<span class="sd">            Optional directory for custom models.</span>
<span class="sd">        damage_process_approach: str</span>
<span class="sd">            Damage process approach. Defaults to `User Defined`.</span>
<span class="sd">        replacement_cost_parameters: dict or None</span>
<span class="sd">            Parameters for replacement cost.</span>
<span class="sd">        replacement_time_parameters: dict or None</span>
<span class="sd">            Parameters for replacement time.</span>
<span class="sd">        replacement_carbon_parameters: dict or None</span>
<span class="sd">            Parameters for replacement carbon.</span>
<span class="sd">        replacement_energy_parameters: dict or None</span>
<span class="sd">            Parameters for replacement energy.</span>
<span class="sd">        loss_map_path: str or None</span>
<span class="sd">            Optional path to a loss map file.</span>
<span class="sd">        decision_variables: tuple[str] or None</span>
<span class="sd">            Optional decision variables for the assessment.</span>
<span class="sd">        replacement_configuration: tuple or None</span>
<span class="sd">            Loss thresholds of replacement consequences.</span>
<span class="sd">        loss_combination_method: str, optional</span>
<span class="sd">            String defining the method to use for combining losses for</span>
<span class="sd">            components that represent different demands.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Dataframe with the aggregated loss of each realization,</span>
<span class="sd">            and another boolean dataframe with information on which DV</span>
<span class="sd">            thresholds were exceeded in each realization, triggering</span>
<span class="sd">            replacement. If no thresholds are specified it only</span>
<span class="sd">            contains False values.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            When an invalid loss map approach is specified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conseq_df</span><span class="p">,</span> <span class="n">consequence_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_consequence_info</span><span class="p">(</span>
            <span class="n">consequence_database</span><span class="p">,</span>
            <span class="n">consequence_database_path</span><span class="p">,</span>
            <span class="n">custom_model_dir</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># remove duplicates from conseq_df</span>
        <span class="n">conseq_df</span> <span class="o">=</span> <span class="n">conseq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">conseq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="p">:]</span>

        <span class="c1"># add the replacement consequence to the data</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">conseq_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Cost&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Carbon&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy&#39;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">_loss__add_replacement_cost</span><span class="p">(</span>
            <span class="n">adf</span><span class="p">,</span>
            <span class="n">damage_process_approach</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_cost_parameters</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">),</span>
            <span class="n">median</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_cost_parameters</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">),</span>
            <span class="n">distribution</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_cost_parameters</span><span class="p">,</span> <span class="s1">&#39;Distribution&#39;</span><span class="p">),</span>
            <span class="n">theta_1</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_cost_parameters</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">_loss__add_replacement_time</span><span class="p">(</span>
            <span class="n">adf</span><span class="p">,</span>
            <span class="n">damage_process_approach</span><span class="p">,</span>
            <span class="n">conseq_df</span><span class="p">,</span>
            <span class="n">occupancy_type</span><span class="o">=</span><span class="n">occupancy_type</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_time_parameters</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">),</span>
            <span class="n">median</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_time_parameters</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">),</span>
            <span class="n">distribution</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_time_parameters</span><span class="p">,</span> <span class="s1">&#39;Distribution&#39;</span><span class="p">),</span>
            <span class="n">theta_1</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_time_parameters</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">_loss__add_replacement_carbon</span><span class="p">(</span>
            <span class="n">adf</span><span class="p">,</span>
            <span class="n">damage_process_approach</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_carbon_parameters</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">),</span>
            <span class="n">median</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_carbon_parameters</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">),</span>
            <span class="n">distribution</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_carbon_parameters</span><span class="p">,</span> <span class="s1">&#39;Distribution&#39;</span><span class="p">),</span>
            <span class="n">theta_1</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_carbon_parameters</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">_loss__add_replacement_energy</span><span class="p">(</span>
            <span class="n">adf</span><span class="p">,</span>
            <span class="n">damage_process_approach</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_energy_parameters</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">),</span>
            <span class="n">median</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_energy_parameters</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">),</span>
            <span class="n">distribution</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_energy_parameters</span><span class="p">,</span> <span class="s1">&#39;Distribution&#39;</span><span class="p">),</span>
            <span class="n">theta_1</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_energy_parameters</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># prepare the loss map</span>
        <span class="n">loss_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">loss_map_approach</span> <span class="o">==</span> <span class="s1">&#39;Automatic&#39;</span><span class="p">:</span>
            <span class="c1"># get the damage sample</span>
            <span class="n">loss_map</span> <span class="o">=</span> <span class="n">_loss__map_auto</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">conseq_df</span><span class="p">,</span> <span class="n">damage_process_approach</span><span class="p">,</span> <span class="n">occupancy_type</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">loss_map_approach</span> <span class="o">==</span> <span class="s1">&#39;User Defined&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">custom_model_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">loss_map</span> <span class="o">=</span> <span class="n">_loss__map_user</span><span class="p">(</span><span class="n">custom_model_dir</span><span class="p">,</span> <span class="n">loss_map_path</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Invalid MapApproach value: `</span><span class="si">{</span><span class="n">loss_map_approach</span><span class="si">}</span><span class="s1">`.&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># prepare additional loss map entries, if needed</span>
        <span class="k">if</span> <span class="s1">&#39;DMG-collapse&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">loss_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;Repair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;replacement&#39;</span>
            <span class="n">loss_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;irreparable&#39;</span><span class="p">,</span> <span class="s1">&#39;Repair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;replacement&#39;</span>

        <span class="k">if</span> <span class="n">decision_variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">decision_variables</span> <span class="o">=</span> <span class="n">decision_variables</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">add_loss_map</span><span class="p">(</span><span class="n">loss_map</span><span class="p">,</span> <span class="n">loss_map_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">load_model_parameters</span><span class="p">([</span><span class="o">*</span><span class="n">consequence_db</span><span class="p">,</span> <span class="n">adf</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">loss_combination_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loss_combination</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">loss_combination_method</span> <span class="o">==</span> <span class="s1">&#39;Hazus Hurricane&#39;</span><span class="p">:</span>
            <span class="c1"># assemble the combination dict for wind and storm surge</span>
            <span class="c1"># open the base combination matrix</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">substitute_default_path</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;PelicunDefault/Wind_Flood_Hazus_HU_bldg.csv&#39;</span><span class="p">]</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">combination_array</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">file_path</span><span class="p">,</span>
                <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="c1"># get the component names</span>
            <span class="c1"># assume that the first and second component in the loss map</span>
            <span class="c1"># are the wind and flood components, respectively</span>
            <span class="n">wind_comp</span><span class="p">,</span> <span class="n">flood_comp</span> <span class="o">=</span> <span class="n">loss_map</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

            <span class="n">loss_combination</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Cost&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="p">(</span><span class="n">wind_comp</span><span class="p">,</span> <span class="n">flood_comp</span><span class="p">):</span> <span class="n">combination_array</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Invalid loss combination method: `</span><span class="si">{</span><span class="n">loss_combination_method</span><span class="si">}</span><span class="s1">`.&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">df_agg</span><span class="p">,</span> <span class="n">exceedance_bool_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">aggregate_losses</span><span class="p">(</span>
            <span class="n">replacement_configuration</span><span class="p">,</span> <span class="n">loss_combination</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_agg</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exceedance_bool_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_agg</span><span class="p">,</span> <span class="n">exceedance_bool_df</span></div>


<div class="viewcode-block" id="DLCalculationAssessment.load_consequence_info">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.DLCalculationAssessment.load_consequence_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_consequence_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">consequence_database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">consequence_database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_model_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load consequence information for the assessment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        consequence_database: str</span>
<span class="sd">            Name of the consequence database.</span>
<span class="sd">        consequence_database_path: str or None</span>
<span class="sd">            Optional path to a consequence database file.</span>
<span class="sd">        custom_model_dir: str or None</span>
<span class="sd">            Optional directory for custom models.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[pd.DataFrame, list[str]]</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - A DataFrame with the consequence data.</span>
<span class="sd">            - A list of paths to the consequence databases used.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            With invalid combinations of arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">consequence_database</span> <span class="ow">in</span> <span class="n">default_dbs</span><span class="p">[</span><span class="s1">&#39;repair&#39;</span><span class="p">]:</span>
            <span class="n">default_consequence_dbs</span> <span class="o">=</span> <span class="n">default_dbs</span><span class="p">[</span><span class="s1">&#39;repair&#39;</span><span class="p">][</span>
                <span class="n">consequence_database</span>
            <span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

            <span class="n">consequence_db</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;PelicunDefault/&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">default_consequence_dbs</span>
            <span class="p">]</span>

            <span class="n">conseq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_default_data</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">default_consequence_dbs</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consequence_db</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">conseq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">consequence_database_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;CustomDLDataFolder&#39;</span> <span class="ow">in</span> <span class="n">consequence_database_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">custom_model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;When `consequence_database_path` includes CustomDLDataFolder, &#39;</span>
                        <span class="s1">&#39;`custom_model_dir` needs to be specified as well.&#39;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">consequence_database_path</span> <span class="o">=</span> <span class="n">consequence_database_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s1">&#39;CustomDLDataFolder&#39;</span><span class="p">,</span> <span class="n">custom_model_dir</span>
                <span class="p">)</span>

            <span class="n">consequence_db</span> <span class="o">+=</span> <span class="p">[</span><span class="n">consequence_database_path</span><span class="p">]</span>

            <span class="n">extra_conseq_df</span> <span class="o">=</span> <span class="n">file_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                <span class="n">consequence_database_path</span><span class="p">,</span>
                <span class="n">unit_conversion_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">reindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_conseq_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conseq_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">conseq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">conseq_df</span><span class="p">,</span> <span class="n">extra_conseq_df</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conseq_df</span> <span class="o">=</span> <span class="n">extra_conseq_df</span>

        <span class="n">consequence_db</span> <span class="o">=</span> <span class="n">consequence_db</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">conseq_df</span><span class="p">,</span> <span class="n">consequence_db</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_add_units</span><span class="p">(</span><span class="n">raw_demands</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add units to demand columns in a DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raw_demands: pd.DataFrame</span>
<span class="sd">        The raw demand data to which units will be added.</span>
<span class="sd">    length_unit: str</span>
<span class="sd">        The unit of length to be used (e.g., &#39;in&#39; for inches).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        The DataFrame with units added to the appropriate demand columns.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">demands</span> <span class="o">=</span> <span class="n">raw_demands</span><span class="o">.</span><span class="n">T</span>

    <span class="n">demands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
        <span class="n">length_unit</span> <span class="o">=</span> <span class="s1">&#39;inch&#39;</span>

    <span class="n">demands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">base</span><span class="o">.</span><span class="n">convert_to_MultiIndex</span><span class="p">(</span><span class="n">demands</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>

    <span class="n">nlevels_with_event_id</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">dem_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">demands</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="n">nlevels_with_event_id</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># drop demands with no EDP type identified</span>
    <span class="n">demands</span> <span class="o">=</span> <span class="n">demands</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">demands</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">demands</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="n">dem_level</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># assign units</span>
    <span class="n">demand_cols</span> <span class="o">=</span> <span class="n">demands</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="n">dem_level</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

    <span class="c1"># remove additional info from demand names</span>
    <span class="n">demand_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">demand_cols</span><span class="p">]</span>

    <span class="c1"># acceleration</span>
    <span class="n">acc_edps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PFA&#39;</span><span class="p">,</span> <span class="s1">&#39;PGA&#39;</span><span class="p">,</span> <span class="s1">&#39;SA&#39;</span><span class="p">]</span>
    <span class="n">edp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">demand_cols</span><span class="p">,</span> <span class="n">acc_edps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">edp_mask</span><span class="p">):</span>
        <span class="n">demands</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edp_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">length_unit</span> <span class="o">+</span> <span class="s1">&#39;ps2&#39;</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># speed</span>
    <span class="n">speed_edps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PFV&#39;</span><span class="p">,</span> <span class="s1">&#39;PWS&#39;</span><span class="p">,</span> <span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="s1">&#39;SV&#39;</span><span class="p">]</span>
    <span class="n">edp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">demand_cols</span><span class="p">,</span> <span class="n">speed_edps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">edp_mask</span><span class="p">):</span>
        <span class="n">demands</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edp_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">length_unit</span> <span class="o">+</span> <span class="s1">&#39;ps&#39;</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># displacement</span>
    <span class="n">disp_edps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PFD&#39;</span><span class="p">,</span> <span class="s1">&#39;PIH&#39;</span><span class="p">,</span> <span class="s1">&#39;SD&#39;</span><span class="p">,</span> <span class="s1">&#39;PGD&#39;</span><span class="p">]</span>
    <span class="n">edp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">demand_cols</span><span class="p">,</span> <span class="n">disp_edps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">edp_mask</span><span class="p">):</span>
        <span class="n">demands</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edp_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">length_unit</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># drift ratio</span>
    <span class="n">rot_edps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PID&#39;</span><span class="p">,</span> <span class="s1">&#39;PRD&#39;</span><span class="p">,</span> <span class="s1">&#39;DWD&#39;</span><span class="p">,</span> <span class="s1">&#39;RDR&#39;</span><span class="p">,</span> <span class="s1">&#39;PMD&#39;</span><span class="p">,</span> <span class="s1">&#39;RID&#39;</span><span class="p">]</span>
    <span class="n">edp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">demand_cols</span><span class="p">,</span> <span class="n">rot_edps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">edp_mask</span><span class="p">):</span>
        <span class="n">demands</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edp_mask</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unitless&#39;</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># convert back to simple header and return the DF</span>
    <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">convert_to_SimpleIndex</span><span class="p">(</span><span class="n">demands</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_loss__add_replacement_energy</span><span class="p">(</span>
    <span class="n">adf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dl_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">median</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">theta_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add replacement energy information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adf : pandas.DataFrame</span>
<span class="sd">        Dataframe containing loss information.</span>
<span class="sd">    DL_method : str</span>
<span class="sd">        Supported methods are &#39;FEMA P-58&#39;.</span>
<span class="sd">    unit : str, optional</span>
<span class="sd">        Unit for the energy value (e.g., &#39;MJ&#39;). Defaults to None.</span>
<span class="sd">    median : float, optional</span>
<span class="sd">        Median replacement energy. If provided, it defines the base</span>
<span class="sd">        replacement energy value. Defaults to None.</span>
<span class="sd">    distribution : str, optional</span>
<span class="sd">        Distribution family to model uncertainty around the median</span>
<span class="sd">        energy (e.g., &#39;lognormal&#39;). Required if `median` is</span>
<span class="sd">        provided. Defaults to None.</span>
<span class="sd">    theta_1 : float, optional</span>
<span class="sd">        Distribution parameter (e.g., standard deviation). Required if</span>
<span class="sd">        `distribution` is provided. Defaults to None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If `median` is not provided, a default value is assigned based on</span>
<span class="sd">    the `DL_method`. For &#39;FEMA P-58&#39;, the default replacement energy</span>
<span class="sd">    value is 0 MJ.  For other methods, this consequence is removed</span>
<span class="sd">    from the dataframe entirely.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ren</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">median</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO(JVM): in this case we need unit (add config parser check)</span>

        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">median</span>

        <span class="k">if</span> <span class="n">distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO(JVM): in this case we need theta_1 (add config parser check)</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">distribution</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">theta_1</span>
    <span class="k">elif</span> <span class="n">dl_method</span> <span class="o">==</span> <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;MJ&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ren</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># for everything else, remove this consequence</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ren</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_loss__add_replacement_carbon</span><span class="p">(</span>
    <span class="n">adf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">damage_process_approach</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">median</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">theta_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add replacement carbon emission information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adf : pandas.DataFrame</span>
<span class="sd">        Dataframe containing loss information.</span>
<span class="sd">    damage_process_approach : str</span>
<span class="sd">        Supported approaches include &#39;FEMA P-58&#39;.</span>
<span class="sd">    unit : str, optional</span>
<span class="sd">        Unit for the carbon emission value (e.g., &#39;kg&#39;). Defaults to</span>
<span class="sd">        None.</span>
<span class="sd">    median : float, optional</span>
<span class="sd">        Median replacement carbon emissions. If provided, it defines</span>
<span class="sd">        the base replacement carbon value. Defaults to None.</span>
<span class="sd">    distribution : str, optional</span>
<span class="sd">        Distribution family to model uncertainty around the median</span>
<span class="sd">        carbon emissions (e.g., &#39;lognormal&#39;). Required if `median` is</span>
<span class="sd">        provided.  Defaults to None.</span>
<span class="sd">    theta_1 : float, optional</span>
<span class="sd">        Distribution parameter (e.g., standard deviation). Required if</span>
<span class="sd">        `distribution` is provided. Defaults to None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If `median` is not provided, a default value is assigned based on</span>
<span class="sd">    the `damage_process_approach`. For &#39;FEMA P-58&#39;, the default</span>
<span class="sd">    replacement carbon emissions value is 0 kg. For other approaches,</span>
<span class="sd">    this consequence is removed from the dataframe entirely.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rcarb</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Carbon&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">median</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO(JVM): in this case we need unit (add config parser check)</span>

        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">median</span>

        <span class="k">if</span> <span class="n">distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO(JVM): in this case we need theta_1 (add config parser check)</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">distribution</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">theta_1</span>
    <span class="k">elif</span> <span class="n">damage_process_approach</span> <span class="o">==</span> <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;kg&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rcarb</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># for everything else, remove this consequence</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">rcarb</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_loss__add_replacement_time</span><span class="p">(</span>
    <span class="n">adf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">damage_process_approach</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conseq_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">occupancy_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">median</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">theta_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add replacement time information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adf : pandas.DataFrame</span>
<span class="sd">        Dataframe containing loss information.</span>
<span class="sd">    damage_process_approach : str</span>
<span class="sd">        Supported approaches are &#39;FEMA P-58&#39;, &#39;Hazus Earthquake -</span>
<span class="sd">        Buildings&#39;.</span>
<span class="sd">    conseq_df : pandas.DataFrame</span>
<span class="sd">        Dataframe containing consequence data for different damage</span>
<span class="sd">        states.</span>
<span class="sd">    occupancy_type : str, optional</span>
<span class="sd">        Type of occupancy, used to look up replacement time in the</span>
<span class="sd">        consequence dataframe for Hazus Earthquake approach. Defaults</span>
<span class="sd">        to None.</span>
<span class="sd">    unit : str, optional</span>
<span class="sd">        Unit for the replacement time (e.g., &#39;day, &#39;worker_day&#39;).</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    median : float, optional</span>
<span class="sd">        Median replacement time or loss ratio. If provided, it defines</span>
<span class="sd">        the base replacement time. Defaults to None.</span>
<span class="sd">    distribution : str, optional</span>
<span class="sd">        Distribution family to model uncertainty around the median</span>
<span class="sd">        time (e.g., &#39;lognormal&#39;). Required if `median` is</span>
<span class="sd">        provided. Defaults to None.</span>
<span class="sd">    theta_1 : float, optional</span>
<span class="sd">        Distribution parameter (e.g., standard deviation). Required if</span>
<span class="sd">        `distribution` is provided. Defaults to None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If `median` is not provided, a default value is assigned based on</span>
<span class="sd">    the `damage_process_approach`. For &#39;FEMA P-58&#39;, the default</span>
<span class="sd">    replacement time is 0 worker_days. For &#39;Hazus Earthquake -</span>
<span class="sd">    Buildings&#39;, the replacement time is fetched from `conseq_df` for</span>
<span class="sd">    the provided `occupancy_type` and corresponds to the total loss</span>
<span class="sd">    (damage state 5, DS5). In other cases, a placeholder value of 1 is</span>
<span class="sd">    used.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">median</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO(JVM): in this case we need unit (add config parser check)</span>

        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">median</span>

        <span class="k">if</span> <span class="n">distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO(JVM): in this case we need theta_1 (add config parser check)</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">distribution</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">theta_1</span>
    <span class="k">elif</span> <span class="n">damage_process_approach</span> <span class="o">==</span> <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;worker_day&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># for Hazus EQ, use 1.0 as a loss_ratio</span>
    <span class="k">elif</span> <span class="n">damage_process_approach</span> <span class="o">==</span> <span class="s1">&#39;Hazus Earthquake - Buildings&#39;</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;day&#39;</span>

        <span class="c1"># load the replacement time that corresponds to total loss</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">conseq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;STR.</span><span class="si">{</span><span class="n">occupancy_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DS5&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># otherwise, use 1 (and expect to have it defined by the user)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;loss_ratio&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_loss__add_replacement_cost</span><span class="p">(</span>
    <span class="n">adf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dl_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">median</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">theta_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add replacement cost information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adf : pandas.DataFrame</span>
<span class="sd">        Dataframe containing loss information.</span>
<span class="sd">    DL_method : str</span>
<span class="sd">        Supported methods are &#39;FEMA P-58&#39;, &#39;Hazus Earthquake&#39;, and</span>
<span class="sd">        &#39;Hazus Hurricane&#39;.</span>
<span class="sd">    unit : str, optional</span>
<span class="sd">        Unit for the replacement cost (e.g., &#39;USD_2011&#39;,</span>
<span class="sd">        &#39;loss_ratio&#39;). Defaults to None.</span>
<span class="sd">    median : float, optional</span>
<span class="sd">        Median replacement cost or loss ratio. If provided, it defines</span>
<span class="sd">        the base replacement cost. Defaults to None.</span>
<span class="sd">    distribution : str, optional</span>
<span class="sd">        Distribution family to model uncertainty around the median</span>
<span class="sd">        cost (e.g., &#39;lognormal&#39;). Required if `median` is</span>
<span class="sd">        provided. Defaults to None.</span>
<span class="sd">    theta_1 : float, optional</span>
<span class="sd">        Distribution parameter (e.g., standard deviation). Required if</span>
<span class="sd">        `distribution` is provided. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Cost&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">median</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO(JVM): in this case we need unit (add config parser check)</span>

        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">median</span>

        <span class="k">if</span> <span class="n">distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO(JVM): in this case we need theta_1 (add config parser check)</span>

            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Family&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">distribution</span>
            <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">theta_1</span>

    <span class="k">elif</span> <span class="n">dl_method</span> <span class="o">==</span> <span class="s1">&#39;FEMA P-58&#39;</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;USD_2011&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># for Hazus EQ and HU, use 1.0 as a loss_ratio</span>
    <span class="k">elif</span> <span class="n">dl_method</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Hazus Earthquake&#39;</span><span class="p">,</span> <span class="s1">&#39;Hazus Hurricane&#39;</span><span class="p">}:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;loss_ratio&#39;</span>

        <span class="c1"># store the replacement cost that corresponds to total loss</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.00</span>

    <span class="c1"># otherwise, use 1 (and expect to have it defined by the user)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;1 EA&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;loss_ratio&#39;</span>
        <span class="n">adf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;DS1&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta_0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_loss__map_user</span><span class="p">(</span>
    <span class="n">custom_model_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">loss_map_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a user-defined loss map from a specified path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    custom_model_dir : str</span>
<span class="sd">        Directory containing custom models.</span>
<span class="sd">    loss_map_path : str, optional</span>
<span class="sd">        Path to the loss map file. The path can include a placeholder</span>
<span class="sd">        &#39;CustomDLDataFolder&#39; that will be replaced by</span>
<span class="sd">        `custom_model_dir`.  If not provided, raises a ValueError.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame containing the loss map information.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `loss_map_path` is not provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">loss_map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loss_map_path</span> <span class="o">=</span> <span class="n">loss_map_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;CustomDLDataFolder&#39;</span><span class="p">,</span> <span class="n">custom_model_dir</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Missing loss map path.&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loss_map_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_loss__map_auto</span><span class="p">(</span>
    <span class="n">assessment</span><span class="p">:</span> <span class="n">DLCalculationAssessment</span><span class="p">,</span>
    <span class="n">conseq_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dl_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">occupancy_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatically generate a loss map.</span>

<span class="sd">    Automatically generate a loss map based on the damage sample and</span>
<span class="sd">    the consequence database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    assessment : AssessmentBase</span>
<span class="sd">        The assessment object containing the damage model and sample.</span>
<span class="sd">    conseq_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing consequence data for different damage</span>
<span class="sd">        states.</span>
<span class="sd">    DL_method : str</span>
<span class="sd">        Damage loss method, which defines how the loss map is</span>
<span class="sd">        generated.  Supported methods are &#39;FEMA P-58&#39;, &#39;Hazus</span>
<span class="sd">        Earthquake&#39;, &#39;Hazus Hurricane&#39;, and &#39;Hazus Earthquake</span>
<span class="sd">        Transportation&#39;.</span>
<span class="sd">    occupancy_type : str, optional</span>
<span class="sd">        Occupancy type, used to map damage components to the correct</span>
<span class="sd">        loss models in Hazus Earthquake methods. Defaults to None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame containing the automatically generated loss map,</span>
<span class="sd">        where the index corresponds to the damage components and the</span>
<span class="sd">        values indicate the associated loss models.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - For &#39;FEMA P-58&#39; and &#39;Hazus Hurricane&#39;, the method assumes that</span>
<span class="sd">      fragility and consequence data have matching component IDs.</span>
<span class="sd">    - For &#39;Hazus Earthquake&#39; and &#39;Hazus Earthquake Transportation&#39;,</span>
<span class="sd">      the method assumes that consequence archetypes are only</span>
<span class="sd">      differentiated by occupancy type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the damage sample</span>
    <span class="n">dmg_sample</span> <span class="o">=</span> <span class="n">assessment</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">save_sample</span><span class="p">()</span>
    <span class="n">asset_sample</span> <span class="o">=</span> <span class="n">assessment</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">save_cmp_sample</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmg_sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asset_sample</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

    <span class="c1"># create a mapping for all components that are also in</span>
    <span class="c1"># the prescribed consequence database</span>
    <span class="n">asset_cmps</span> <span class="o">=</span> <span class="n">asset_sample</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;cmp&#39;</span><span class="p">)</span>
    <span class="n">loss_cmps</span> <span class="o">=</span> <span class="n">conseq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">drivers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">loss_models</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">dl_method</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;FEMA P-58&#39;</span><span class="p">,</span> <span class="s1">&#39;Hazus Hurricane&#39;</span><span class="p">}:</span>
        <span class="c1"># with these methods, we assume fragility and consequence data</span>
        <span class="c1"># have the same IDs</span>

        <span class="k">for</span> <span class="n">asset_cmp</span> <span class="ow">in</span> <span class="n">asset_cmps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asset_cmp</span> <span class="o">==</span> <span class="s1">&#39;collapse&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">asset_cmp</span> <span class="ow">in</span> <span class="n">loss_cmps</span><span class="p">:</span>
                <span class="n">drivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset_cmp</span><span class="p">)</span>
                <span class="n">loss_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset_cmp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">dl_method</span> <span class="ow">in</span> <span class="p">{</span>
        <span class="s1">&#39;Hazus Earthquake&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hazus Earthquake Transportation&#39;</span><span class="p">,</span>
    <span class="p">}:</span>
        <span class="c1"># with Hazus Earthquake we assume that consequence</span>
        <span class="c1"># archetypes are only differentiated by occupancy type</span>
        <span class="k">for</span> <span class="n">asset_cmp</span> <span class="ow">in</span> <span class="n">asset_cmps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asset_cmp</span> <span class="o">==</span> <span class="s1">&#39;collapse&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">cmp_class</span> <span class="o">=</span> <span class="n">asset_cmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">occupancy_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loss_cmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmp_class</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">occupancy_type</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss_cmp</span> <span class="o">=</span> <span class="n">cmp_class</span>

            <span class="k">if</span> <span class="n">loss_cmp</span> <span class="ow">in</span> <span class="n">loss_cmps</span><span class="p">:</span>
                <span class="n">drivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset_cmp</span><span class="p">)</span>
                <span class="n">loss_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_cmp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">loss_models</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Repair&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">drivers</span><span class="p">)</span>


<div class="viewcode-block" id="TimeBasedAssessment">
<a class="viewcode-back" href="../../api_reference/_autosummary/pelicun.assessment.html#pelicun.assessment.TimeBasedAssessment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeBasedAssessment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Time-based assessment.&quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Leland Stanford Junior University and The Regents of the University of California.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-158130480-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-158130480-7', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>